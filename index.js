"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var r=t(require("socket.io-client"));var e=t(require("eventemitter3"));var n=t(require("bitcoinsource"));var a=t(require("axios"));function i(t,r,e,n,a,i,s){try{var o=t[i](s);var u=o.value}catch(t){return void e(t)}o.done?r(u):Promise.resolve(u).then(n,a)}function s(t){return function(){var r=this,e=arguments;return new Promise((function(n,a){var s=t.apply(r,e);function o(t){i(s,n,a,o,u,"next",t)}function u(t){i(s,n,a,o,u,"throw",t)}o(void 0)}))}}function o(t,r,e){return r in t?Object.defineProperty(t,r,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[r]=e,t}function u(t,r){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),e.push.apply(e,n)}return e}function c(t){for(var r=1;r<arguments.length;r++){var e=null!=arguments[r]?arguments[r]:{};r%2?u(Object(e),!0).forEach((function(r){o(t,r,e[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):u(Object(e)).forEach((function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(e,r))}))}return t}function d(t,r){if(null==t)return{};var e=function(t,r){if(null==t)return{};var e={};var n=Object.keys(t);var a,i;for(i=0;i<n.length;i++)a=n[i],r.indexOf(a)>=0||(e[a]=t[a]);return e}(t,r);var n,a;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(a=0;a<i.length;a++)n=i[a],r.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(e[n]=t[n])}return e}function v(t){var r=function(t,r){if("object"!=typeof t||null===t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof r?r:String(r)}var h="http://bitcoinbroadcastserver-env.r5t6c3b2kj.us-west-1.elasticbeanstalk.com";n.versionGuard=()=>!0,n.Networks.defaultNetwork=n.Networks.mainnet;class p{constructor(t){this.kind=t}toJSON(){return{}}}function l(t){return{writable:!0,value:t}}function f(t,r,e){var{[t]:n}=e;return c({[r]:n},d(e,[t].map(v)))}var{PublicKey:g,Address:m,Transaction:_}=n;class y extends p{constructor(t,r){super("pkh"),this.address=t,this._amount=r}static fromPublicKeyHashInput(t){var{output:r}=t;return new this(r.script.toAddress(),r.satoshis)}toJSON(){return{kind:"pkh",address:this.address.toString(),amount:this._amount}}static isJSON(t){return t.address&&t.amount}static fromJSON(t){return new this(new m(t.address),t.amount)}}class w extends p{constructor(t){super("return"),this.data=t||""}getData(){return this.data}toJSON(){return{kind:"return",data:this.data}}static isJSON(t){return!!t.data}static fromJSON(t){return new this(t.data)}}var{Address:b,PublicKey:O,Signature:S,Script:x,Opcode:I}=n;function P(t,r){var e=[];var n=0;for(;n<t.length;)e.push(t.slice(n,n+r)),n+=r;return e}class k extends x{static outScriptFromData(t){var{kind:r,_owners:e=[],_amount:n,__vouts:a,__txId:i}=t,s=d(t,["kind","_owners","_amount","__vouts","__txId"]);var o=P(Buffer.from(JSON.stringify(s)),479);return o[o.length-1].byteLength>=479&&P(o.pop(),479).forEach(t=>{o.push(t)}),o.map(t=>{var r=new k;return r.add("OP_1"),e.forEach(t=>r.add(t.toBuffer())),r.add("OP_".concat(e.length)),r.add("OP_CHECKMULTISIG"),r.add(t),r.add("OP_DROP"),{redeemScript:r,chunk:t}})}getData(){return this.isDbDataScript()?JSON.parse(this.chunks[this.chunks.length-2].buf.toString()):{}}getPublicKeys(){if(this.isDbDataScript())return this.chunks.slice(1,this.chunks.length-4).map(t=>new O(t.buf));throw new Error("Cannot get owners from non-data script")}isDbDataScript(){return!!(this.chunks.length>=5&&this.chunks[0].opcodenum===I.OP_1&&this.chunks[1].buf&&[20,33].includes(this.chunks[1].buf.length)&&this.chunks[this.chunks.length-3].opcodenum===I.OP_CHECKMULTISIG&&this.chunks[this.chunks.length-2].buf&&this.chunks[this.chunks.length-1].opcodenum===I.OP_DROP)}static isP2shScript(t){return!(3!==t.chunks.length||t.chunks[0].opcodenum!==I.OP_0||!t.chunks[1].buf||!t.chunks[2].buf)}static redeemScriptFromP2shScript(t){if(!this.isP2shScript(t))throw new Error("not a p2sh script");var r=new x(t.chunks[2].buf);var e=new this;return e.chunks=r.chunks,e}static fromScript(t){var r=new x(t);var e=new k;return e.chunks=r.chunks,e}}var D=t=>"object"==typeof t?Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1]:Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1].toLowerCase();var j=t=>{var[,...r]=t;return r};var T=t=>["undefined","number","string","boolean","Null"].includes(D(t));var E=t=>T(t)||["Array","Object"].includes(D(t));var B=(t,r)=>{if(!E(t)||!E(r))throw new Error("Unsupported data types for deep equals: ".concat(D(t)," & ").concat(D(r)));return D(t)===D(r)&&(T(t)&&T(r)?t===r:t&&r&&Object.entries(t).every(t=>{var[e,n]=t;return B(r[e],n)})&&Object.entries(r).every(r=>{var[e,n]=r;return B(t[e],n)}))};var N=t=>{if(T(t))return t;if("Array"===D(t))return t.map(N);if("Object"===D(t)){var r=Object.keys(t).reduce((r,e)=>(r[e]=N(t[e]),r),{});var e=Object.create(Object.getPrototypeOf(t));return Object.assign(e,r)}throw new Error("Unsupported data type for clone: ".concat(D(t)))};var K=(t,r)=>t.filter(t=>!r.includes(t));var A=(t,r)=>{var e={};var n=K(Object.keys(t),Object.keys(r));var a=K(Object.keys(r),Object.keys(t));var i=((t,r)=>t.filter(t=>r.includes(t)))(Object.keys(t),Object.keys(r));for(var s of n)e[s]={__kind:"D",old:t[s],new:null};for(var o of a)e[o]={__kind:"N",old:null,new:r[o]};for(var u of i)e[u]={__kind:B(t[u],r[u])?"S":"C",old:t[u],new:r[u]};return e};var J=t=>{var r={};var e=["_owners","_id","_rev"];var n=Object.entries(t).filter(t=>{var[r,n]=t;return e.includes(r)||T(n)});var a={};n.forEach(t=>{var[r,e]=t;a[r]=e}),r[""]=a;var i=Object.entries(t).filter(t=>{var[r,n]=t;return!e.includes(r)&&!T(n)});var s={};return i.forEach(t=>{var[r,e]=t;s[r]=e}),Object.entries(s).forEach(t=>{var[e,n]=t;Object.entries(J(n)).forEach(t=>{var[n,a]=t;r["_".concat(e).concat(n)]=a})}),r};var C=t=>{var r=J(t);return delete r[""],r};var R=(t,r)=>(t._owners=void 0!==t._owners?t._owners:[r],t);var M=(t,r)=>{for(var e in t)R(t[e].new,r);return t};var H=(t,r)=>{t=R(t,r);var e=["_owners","_id","_rev"];return Object.entries(t).forEach(n=>{var[a,i]=n;e.includes(a)||T(i)||(t[a]=H(t[a],r))}),t};var U=(t,r)=>"object"==typeof t&&(0===r.length?t:U(t[(t=>{var[r]=t;return r})(r)],j(r)));var V=function(t,r,e){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];r.forEach((r,a)=>{var i=U(t,j(r.path.split("_")));i&&(i._rev={txId:e,virtualIndex:a},n&&(i._id={txId:e,virtualIndex:a}))})};var{PublicKey:F,Transaction:z,Script:q}=n;class W extends p{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super("script"),Object.assign(this,t),this._amount=t._amount||4e3}getData(t){return this[t]}getSerializeData(){var t=d(this,["kind","_owners","_amount"]);return Buffer.from(JSON.stringify(t))}static fromMultiSigScriptHashInput(t){var{_scriptBuffer:r}=t;var e=k.fromBuffer(r);var{redeemScript:n=k.redeemScriptFromP2shScript(e)}=t;return this.fromRedeemScript(n)}static fromRedeemScript(t){return this.fromRedeemScripts([t])}static fromRedeemScripts(t){var r=t.map(t=>t.chunks[t.chunks.length-2].buf);var e=Buffer.concat(r);var n=JSON.parse(e.toString());return Object.assign(new this,c({kind:"script",_owners:t[0].getPublicKeys(),_amount:4e3},n))}static addVouts(t){var r=0;return t.map(t=>{var e="script"===t.kind?k.outScriptFromData(t).length:1;return t.__vouts=Array(e).fill(r).map((t,r)=>t+r),r+=e,t})}toJSON(){return c({},this,{kind:"script",_owners:(this._owners||[]).map(t=>t.toString())})}static isJSON(t){return"script"===t.kind}static fromJSON(t){var r=N(t);return r._owners=(r._owners||[]).map(t=>new F(t)),new W(r)}}var{PublicKey:L,Address:G}=n;class Z extends p{constructor(t){super("change"),this.address=t}toJSON(){return{kind:"change",address:this.address.toString()}}static isJSON(t){return t.address}static fromJSON(t){return new this(new G(t.address))}}var{Address:Q,Transaction:X,PublicKey:Y,Script:$}=n;class tt{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"BSV";this.chain=t}static getBaseUrl(t){switch(t){case"BSV":return"https://api.whatsonchain.com/v1/bsv/main";case"BCH":return"https://rest.bitcoin.com/v2";default:return""}}static unwrap(t){return s((function*(){try{return(yield t).data}catch(t){var{message:r,config:e,response:n}=t;var{url:a,method:i,data:s}=e;var o;try{o=JSON.parse(s)}catch(t){o=null}var u=o&&o.txhex?new X(o.txhex):null;throw t.message="Communication Error\n\nmessage\t".concat(r,"\nrequest\t").concat(i," ").concat(a,"\n").concat(u?"transaction\t ".concat(JSON.stringify(u.toJSON(),null,2)):"post"!==i||u?"":"data\t".concat(s),"\n").concat(n?"response\t".concat(JSON.stringify(n.data)):""),t}}))()}static get(t,r){var e=this;return s((function*(){var n=e.getBaseUrl(r);return yield e.unwrap(a.get("".concat(n).concat(t)))}))()}static post(t,r,e){var n=this;return s((function*(){var i=n.getBaseUrl(e);return yield n.unwrap(a.post("".concat(i).concat(t),r))}))()}static getBalance(t,r){var e=this;return s((function*(){switch(r){case"BSV":var n="/address/".concat(t.toString(),"/balance");var{confirmed:a,unconfirmed:i}=yield e.get(n,r);return parseInt(a,10)+parseInt(i,10);case"BCH":var s="/address/details/".concat(t.toString());var{balanceSat:o}=yield e.get(s,r);return parseInt(o,10);default:throw new Error("chain is not set in getBalance")}}))()}getBalance(t){var r=this;return s((function*(){return tt.getBalance(t,r.chain)}))()}static getTransaction(t,r){var e=this;return s((function*(){switch(r){case"BSV":return e.get("/tx/hash/".concat(t),r);case"BCH":return e.get("/transaction/details/".concat(t),r);default:throw new Error("chain is not set in getTransaction")}}))()}getTransaction(t){var r=this;return s((function*(){return tt.getTransaction(t,r.chain)}))()}static getRawTransaction(t,r){var e=this;return s((function*(){switch(r){case"BSV":return e.get("/tx/".concat(t,"/hex"),r);case"BCH":return e.get("/rawtransactions/getRawTransaction/".concat(t),r);default:throw new Error("chain is not set in getRawTransaction")}}))()}getRawTransaction(t){var r=this;return s((function*(){return tt.getRawTransaction(t,r.chain)}))()}static sendTransaction(t,r){var e=this;return s((function*(){if("BSV"===r)return{txId:yield e.post("/tx/raw",{txhex:t.toString()},r)};if("BCH"===r){var[n]=yield e.post("/rawtransactions/sendRawTransaction",{hexes:[t.toString()]},r);return{txId:n}}throw new Error("chain is not set in sendTransaction")}))()}sendTransaction(t){var r=this;return s((function*(){return tt.sendTransaction(t,r.chain)}))()}static getUtxosFromAddress(t,r){var e=this;return s((function*(){var n=[];var a="";switch(r){case"BSV":var i=(n=yield e.get("/address/".concat(t.toString(),"/unspent"),r)).map(t=>{var{tx_hash:r,tx_pos:e,value:n}=t;return{txId:r,vout:e,satoshis:n,amount:n/1e8}});return Promise.all(i.map(function(){var t=s((function*(t){var n=(yield e.get("/tx/hash/".concat(t.txId),r)).vout[t.vout];return t.scriptPubKey=n.scriptPubKey.hex,t}));return function(r){return t.apply(this,arguments)}}()));case"BCH":return({utxos:n,scriptPubKey:a}=yield e.get("/address/utxo/".concat(t.toString()),r)),(n=n.map(t=>c({scriptPubKey:a},t))).map(t=>{var{txid:r}=t;return c({txId:r},d(t,["txid"]))});default:throw new Error("chain is not set in getUtxosFromAddress")}}))()}getUtxosFromAddress(t){var r=this;return s((function*(){return tt.getUtxosFromAddress(t,r.chain)}))()}static getTxosFromOutputData(t,r){var e=this;return s((function*(){var n=t.map(t=>t.__txId);var a=[...new Set(n)];var i=new Map;return yield Promise.all(a.map(function(){var t=s((function*(t){return i.set(t,yield e.getTransaction(t,r))}));return function(r){return t.apply(this,arguments)}}())),t.map(t=>{var{vout:r,blockheight:e,confirmations:n}=i.get(t.__txId)||{};return t.__vouts.map(a=>{var{scriptPubKey:i,value:s}=r[a];return{address:i.addresses[0],txId:t.__txId,vout:a,scriptPubKey:i.hex,amount:parseFloat(s),satoshis:parseInt(1e8*s,10),height:e,confirmations:n}})})}))()}getTxosFromOutputData(t){var r=this;return s((function*(){return tt.getTxosFromOutputData(t,r.chain)}))()}static postOutputData(t){var r=this;return s((function*(){return r.post("".concat(h,"/"),t,"")}))()}postOutputData(t){return s((function*(){return tt.postOutputData(t)}))()}static getOutputData(t){var r=this;return s((function*(){return r.get("".concat(h,"/un-p2sh/").concat(t),"")}))()}getOutputData(t){return s((function*(){return tt.getOutputData(t)}))()}static getOwnedRevs(t){var r=this;return s((function*(){return r.get("".concat(h,"/txos/").concat(t.toString()),"")}))()}getOwnedRevs(t){return s((function*(){return tt.getOwnedRevs(t)}))()}static setTxoSpent(t){var r=this;return s((function*(){return r.post("".concat(h,"/txos/set-spent/"),t,"")}))()}setTxoSpent(t){return s((function*(){return tt.setTxoSpent(t)}))()}}class rt{static fromJSON(t){if(W.isJSON(t))return W.fromJSON(t);if(y.isJSON(t))return y.fromJSON(t);if(Z.isJSON(t))return Z.fromJSON(t);if(w.isJSON(t))return w.fromJSON(t);throw new Error("unrecognized json ".concat(JSON.stringify(t)))}}var{Transaction:et,PublicKey:nt,Address:at,BN:it,Script:st,encoding:ot}=n;var{Output:ut,Input:ct}=et;var{MultiSigScriptHash:dt,PublicKeyHashInput:vt}=ct;var{BufferReader:ht}=ot;class pt extends et{constructor(t,r){super(r),this._outputData=[],this.chain=t,Object.defineProperty(this,"to",l(this._to)),Object.defineProperty(this,"from",l(this._from))}get dataInputs(){var t=[];var r=function*(t){for(var r of t)yield r}(this.inputs);var e=r.next();for(;!e.done;){var n=e.value;var a=k.fromScript(n._scriptBuffer);if(a.isPublicKeyHashIn())t.push(new y(a.toAddress(),0));else if(k.isP2shScript(a)){var i=!1;var s=[k.redeemScriptFromP2shScript(a)];for(;!i;)try{t.push(W.fromRedeemScripts(s)),i=!0}catch(t){var o=r.next();if(o.done)throw new Error("Could not compute data inputs");var u=o.value;var c=k.fromScript(u._scriptBuffer);s.push(k.redeemScriptFromP2shScript(c))}}e=r.next()}return t}set dataInputs(t){throw Error("dataTransaction.dataInputs cannot be set directly, use dataTransaction.from or dataTransaction.fromScriptOutput")}get inputsWithData(){return this.dataInputs.filter(t=>"script"===t.kind)}getVirtualInputs(t){var r=this;return s((function*(){if("BSV"===r.chain)return(yield Promise.all(r.inputs.map(function(){var t=s((function*(t){var{prevTxId:e,outputIndex:n}=t;var a=t.prevTxId.toString("hex");var i=(yield pt.fromTxId(a,r.chain)).outputs[n];return!!k.fromScript(i._scriptBuffer).isDbDataScript()&&t}));return function(r){return t.apply(this,arguments)}}()))).filter(t=>!!t).map(t=>({txId:t.prevTxId.toString("hex"),virtualIndex:t.outputIndex}));if("BCH"===t){var{inputsWithData:e}=r;var n=W.addVouts(e);return Promise.all(n.map(function(){var e=s((function*(e){var n=[];e.__vouts.forEach(t=>{n.push(r.inputs[t])});var a=n[0].prevTxId.toString("hex");var i=yield pt.fromTxId(a,t);yield i.fetchOutputData();var s=W.addVouts(i.outputData);var o=[];return s.forEach((t,r)=>{B(t.__vouts,n.map(t=>t.outputIndex))&&o.push(r)}),{txId:a,virtualIndex:o[0]}}));return function(t){return e.apply(this,arguments)}}()))}throw new Error("chain not set in getVirtualInputs")}))()}fromMultiSig(t,r,e){var n=t.map(t=>f("txId","txid",t));return super.from(n,r,e)}_from(t,r,e){var n=f("txId","txid",t);return super.from(n,r,e)}fromScriptOutput(t,r){var e=k.outScriptFromData(r);var{_owners:n}=r;return e.forEach((r,e)=>{var{redeemScript:a}=r;var{scriptPubKey:i,satoshis:s,txId:o,vout:u}=t[e];var c=new ut({script:new k(i),satoshis:parseInt(s,10)});var d=new k;var v=new dt({prevTxId:o,output:c,outputIndex:u,script:d},n,1,null,a);this.addInput(v)}),this}get outputData(){if(void 0===this._outputData.length)throw new Error("transaction.outputData is not initialized. Call transaction.fetchDataOuptuts() first. ".concat(JSON.stringify(this._outputData,null,2)));return this._outputData}set outputData(t){throw Error("dataTransaction.outputData cannot be set directly")}change(t){var r=this.outputs.length;return super.change(t),this.outputs.length>r&&this._outputData.push(new Z(t)),this}toChangeOutput(t){var r=this.outputs.length;return super.change(t.address),this.outputs.length>r&&this._outputData.push(t),this._outputData.length-1}toPkhOutput(t){return super.to(t.address,t._amount),this._outputData.push(t),this._outputData.length-1}toScriptOutput(t){if("BSV"===this.chain){var{_owners:r=[],_amount:e}=t,n=d(t,["_owners","_amount"]);var a=new k;a.add("OP_1"),r.forEach(t=>a.add(t.toBuffer())),a.add("OP_".concat(r.length)),a.add("OP_CHECKMULTISIG"),a.add(Buffer.from(JSON.stringify(n))),a.add("OP_DROP");var i=new ut({script:a,satoshis:e});return this.addOutput(i),this.outputs.length-1}if("BCH"===this.chain){var s=k.outScriptFromData(t);return this._outputData.push(t),s.forEach(r=>{var{redeemScript:e,chunk:n}=r;var a="BSV"===this.chain?e:k.buildScriptHashOut(e);var i=t._amount;var s=new ut({script:a,satoshis:i});this.addOutput(s)}),this._outputData.length-1}throw new Error("chain not set in dataScript.toScriptOutput")}toReturnOutput(t){return this.addData(t.data),this._outputData.push(t),this._outputData.length-1}_to(t){switch(t.kind){case"change":return this.toChangeOutput(t);case"return":return this.toReturnOutput(t);case"script":return this.toScriptOutput(t);case"pkh":return this.toPkhOutput(t);default:throw new Error("Unsupported output kind ".concat(t.kind))}}fetchOutputData(){var t=this;return s((function*(){if(t._outputData.length)return t._outputData;var r=t.getTxId();var e=[];return"BSV"===t.chain?e=t.outputs.map(t=>{var r=k.fromScript(t._scriptBuffer);var e=t._satoshis;if(r.isDbDataScript()){var n=r.getPublicKeys().map(t=>t.toString());return Object.assign(r.getData(),{kind:"script",_amount:e,_owners:n})}if(r.isPublicKeyHashOut()){var a=r.getPublicKeyHash();return{kind:"change",address:at.fromPublicKeyHash(a)}}throw new Error("Unrecognized output sctipt ".concat(r.toString()))}):"BCH"===t.chain&&(e=yield tt.getOutputData(r)),t._outputData=e.map(rt.fromJSON),t._outputData}))()}get prevObjectIds(){return this.inputs.map(t=>({txId:t.prevTxId.toString("hex"),virtualIndex:t.outputIndex}))}getTxId(){return new ht(this._getHash()).readReverse().toString("hex")}static fromTxId(t,r){return s((function*(){var e=null;try{e=yield tt.getRawTransaction(t,r)}catch(n){yield new Promise(t=>setTimeout(t,3e3)),e=yield tt.getRawTransaction(t,r)}var n=new pt(r);return n.fromString(e),n}))()}}var{Mnemonic:lt,HDPrivateKey:ft,PrivateKey:gt,PublicKey:mt,Address:_t,OutputData:yt}=n;class wt{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new lt;var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"BSV";this.mnemonic=t,this.path="",this.chain=r,this.restClient=new tt(r),this.hdPrivateKey=this.mnemonic.toHDPrivateKey(this.path,"mainnet")}static getRandomMnemonic(){return(new lt).toString()}getRandomMnemonic(){return wt.getRandomMnemonic()}static fromMnemonic(t){return new wt(t)}getMnemonic(){return this.mnemonic}getPath(){return this.path}derive(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];var e=new wt(this.mnemonic);return e.path="".concat(this.path).concat(this.path.length?"/":"").concat(t).concat(r?"'":""),e.hdPrivateKey=this.hdPrivateKey.derive(t,r),e}static getHdPrivateKey(){return new ft}getPrivateKey(){return this.hdPrivateKey.privateKey}getPublicKey(){return this.hdPrivateKey.publicKey}getAddress(){return this.address=this.address||this.getPublicKey().toAddress("mainnet"),this.address}getBalance(){var t=this;return s((function*(){var r=t.getAddress();return t.restClient.getBalance(r.toString())}))()}getUtxos(t){var r=this;var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getAddress();return s((function*(){var n=yield r.restClient.getUtxosFromAddress(e);for(var a=n.length-1;a>0;a-=1){var i=Math.floor(Math.random()*(a+1));[n[a],n[i]]=[n[i],n[a]]}var s=0;var o=[];var u=0;for(;s<t&&u<n.length;)o.push(n[u]),s+=n[u].satoshis,u+=1;if(s>=t)return o;throw new Error("Insufficient balance in address ".concat(e.toString()," on ").concat("BSV",". Found ").concat(s,", required ").concat(t,"."))}))()}sendTransaction(t){var r=this;var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return s((function*(){var{txId:n}=yield r.restClient.sendTransaction(t);if(e){var a=JSON.stringify(t.outputData.map(t=>t.toJSON()));var i=t.toJSON().inputs.map(t=>{var{prevTxId:r,outputIndex:e}=t;return{txId:r,outputIndex:e}});yield r.restClient.postOutputData({txId:n,outputData:a,inputs:i})}return{txId:n}}))()}send(t,r,e){var n=this;return s((function*(){var a="string"==typeof r?r:r.toString();"string"==typeof e&&_t.fromString(e);var i=rt.fromJSON({amount:t,address:a});return n.sendOutputData([i],e)}))()}sendOutputData(t,r){var e=this;return s((function*(){var n=new pt(e.chain);var a=r||e.getAddress();var i=pt._estimateFee(n._estimateSize(),n._getUnspentValue(),2e3);return(yield e.getUtxos(n._getOutputAmount()-n._getInputAmount()+i)).forEach(t=>n.from(t)),t.forEach(n.to.bind(n)),n.change(a),n.sign(e.getPrivateKey()),e.sendTransaction(n)}))()}sendAll(t){var r=this;return s((function*(){var e=yield r.getBalance();if(e>2e3){var n=new y(t,e-2e3);return r.sendOutputData([n])}throw new Error("Insufficient funds to send payment.")}))()}}var{HDPrivateKey:bt,Mnemonic:Ot,Transaction:St,Script:xt}=n;class It{constructor(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"BSV";this.wallet=t||new wt(void 0,r),this.chain=r}static fromMnemonic(t,r){return new this(new wt(t,r),r)}put(t){var r=this;return s((function*(){return r.update([],t)}))()}static getOutputDataMap(t){return s((function*(){var r=[...new Set(t)];var e=yield Promise.all(r.map(function(){var t=s((function*(t){var r=(yield tt.getOutputData(t)).map(rt.fromJSON);var e=0;var n=r.map(r=>{var n="script"===r.kind?k.outScriptFromData(r).length:1;var a=Array(n).fill(e).map((t,r)=>t+r);return e+=n,c({},r,{__vouts:a,__txId:t})});return[t,n]}));return function(r){return t.apply(this,arguments)}}()));return new Map(e)}))()}get(t){var r=this;return s((function*(){if("BSV"===r.chain){var e=t.map(t=>t.txId);var n=[...new Set(e)];var a=yield Promise.all(n.map(function(){var t=s((function*(t){return[t,yield tt.getTransaction(t,r.chain)]}));return function(r){return t.apply(this,arguments)}}()));var i=new Map(a);return Promise.all(t.map(function(){var t=s((function*(t){var{txId:r,virtualIndex:e}=t;var n=i.get(r).vout[e];var a=k.fromScript(n.scriptPubKey.hex);return Object.assign(a.getData(),{__txId:r,__vouts:[e],_owners:a.getPublicKeys(),_amount:Math.round(1e8*n.value)})}));return function(r){return t.apply(this,arguments)}}()))}if("BCH"===r.chain){var o=t.map(t=>t.txId);var u=yield It.getOutputDataMap(o);return t.map(t=>{var{txId:r,virtualIndex:e}=t;var n=u.get(r);if(!n||!Array.isArray(n))throw new Error("No data found.");return n[e]})}throw new Error("chain not set in db.get")}))()}getUpdateTxBch(t,r,e){var n=this;return s((function*(){var e=new pt(n.chain);var a=yield n.get(t);var i=yield n.wallet.restClient.getTxosFromOutputData(a);t.forEach(function(){var t=s((function*(t,r){e.fromScriptOutput(i[r],a[r])}));return function(r,e){return t.apply(this,arguments)}}());var o=r.map(t=>e.to(t));var u=St._estimateFee(e._estimateSize(),e._getUnspentValue(),2e3);return(yield n.wallet.getUtxos(e._getOutputAmount()-e._getInputAmount()+u)).forEach(t=>e.from(t)),e.change(n.wallet.getAddress()),e.sign(n.wallet.getPrivateKey()),{transaction:e,virtualIndices:o}}))()}getUpdateTxBsv(t,r,e){var n=this;return s((function*(){var e=new pt(n.chain);yield Promise.all(t.map(function(){var t=s((function*(t){var{txId:r,virtualIndex:a}=t;var i=yield tt.getTransaction(r,n.chain);var{scriptPubKey:s,value:o}=i.vout[a];var u=k.fromScript(xt.fromHex(s.hex));var c={txId:r,outputIndex:a,scriptPubKey:u,satoshis:Math.round(1e8*o)};var d=u.getPublicKeys();e.from(c,d,1)}));return function(r){return t.apply(this,arguments)}}())),r.map(t=>t._amount=Math.max(t._amount||4e3));var a=r.map(t=>e.to(t));var i=St._estimateFee(e._estimateSize(),e._getUnspentValue(),2e3);return(yield n.wallet.getUtxos(e._getOutputAmount()-e._getInputAmount()+i)).forEach(t=>e.from(t)),e.change(n.wallet.getAddress()),e.sign(n.wallet.getPrivateKey()),yield e.fetchOutputData(),{transaction:e,virtualIndices:a}}))()}update(t,r){var e=this;return s((function*(){var n=r.reduce((t,r)=>t+parseInt(r._amount,10),0);if("BSV"===e.chain){var{transaction:a,virtualIndices:i}=yield e.getUpdateTxBsv(t,r,n);try{var{txId:o}=yield e.wallet.sendTransaction(a,!0);return i.map(t=>({txId:o,virtualIndex:t}))}catch(t){var{response:u}=t;throw"258: txn-mempool-conflict"===(u?u.data:null)&&(yield e.createUtxos(10)),t}}else if("BCH"===e.chain){var{transaction:c,virtualIndices:d}=yield e.getUpdateTxBch(t,r,n);var{txId:v}=yield e.wallet.sendTransaction(c,!0);return t.forEach(function(){var t=s((function*(t){yield e.wallet.restClient.setTxoSpent(t)}));return function(r){return t.apply(this,arguments)}}()),d.map(t=>({txId:v,virtualIndex:t}))}throw new Error("Chain not set in db.update ".concat(e.chain))}))()}createUtxos(t,r){var e=this;return s((function*(){var n=r||4e4;console.log("Creating ".concat(t," unspent outputs with ").concat(n," satoshis in address ").concat(e.wallet.getAddress().toString()));var a=[...Array(t-1).keys()].map(()=>new y(e.wallet.getAddress(),n));return e.update([],a)}))()}}var Pt=eval;class kt{eval(t){return s((function*(){return Pt(t)}))()}apply(t,r,e){return s((function*(){return{res:t[r](...e),obj:t}}))()}}class Dt{constructor(){return new kt}eval(t){var r=this;return s((function*(){return r.sandbox.eval(t)}))()}apply(t,r,e){var n=this;return s((function*(){return n.sandbox.apply(t,r,e)}))()}}var jt=t=>new Promise(r=>setTimeout(r,t));class Tt{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};var{__target:r={},chain:n,db:a=new It(void 0,n),sandbox:i=new Dt,eventEmitter:s=new e,socket:o,id:u}=t;this.__target=r,this.__target._id=u,this.__target._rev=u,this.db=a,this.sandbox=i,this.eventEmitter=s,this.socket=o,this.socket.on("message",this.onWebsocketMessage.bind(this)),this._initialized=!1,this.chain=n,this.poll()}poll(){var t=this;return s((function*(){for(;!t._initialized;)try{yield tt.getTransaction(t.__target._id.txId,t.chain),t._initialized=!0}catch(t){yield jt(500)}t.eventEmitter.emit("initialized")}))()}onWebsocketMessage(t){var r=this;var{data:e}=t;return s((function*(){var{txId:t,outputData:n}=JSON.parse(e);var a=yield pt.fromTxId(t,r.chain);if(yield a.fetchOutputData(),"BSV"===r.chain)n=JSON.stringify(a.outputData.map(t=>t.toJSON()));else if("BCH"!==r.chain)throw new Error("chain not set in onWebsocketMessage");var[{__func:i}]=JSON.parse(n);var s=(yield a.getVirtualInputs(r.chain)).findIndex(t=>B(t,r.__target._rev));var o=s>=0?a.outputData[s].path:"";if(-1!==s&&("constructor"!==i||"_0"!==o)){r.__target._rev={txId:t,virtualIndex:s};var u=yield Tt.getObjectAt(r.__target._rev,r.sandbox,r.chain);Object.entries(u).forEach(t=>{var[e,n]=t;r.__target[e]=n}),r.__target._rev={txId:t,virtualIndex:s},r.eventEmitter.emit("updated")}}))()}static getObjectsAt(t,r,e){return s((function*(){if(!e)throw new Error("chain not set in getObjectAt");var n=yield pt.fromTxId(t,e);yield n.fetchOutputData(e);var a=yield n.getVirtualInputs(e);var i=n.outputData.filter(t=>"script"===t.kind).map((t,r)=>({output:t,input:a[r]||null}));var o=i.flatMap(t=>t.output);var u=yield Promise.all(i.map(function(){var t=s((function*(t){var{input:n,output:a}=t;return n&&2===a.path.length&&n.txId?(yield Tt.getObjectsAt(n.txId,r,e))[n.virtualIndex]:{}}));return function(r){return t.apply(this,arguments)}}()));var{__func:c,_args:d,__cls:v}=n.outputData[0];var h=null;var p=0;if("constructor"===c){var l=u;var f=d.map(t=>"__"===t?l[p++]:t);h=[new(yield r.eval("(".concat(v,")")))(...f),...f],V([,...f],o,t,!1)}else{var[g,...m]=u;var _=d.map(t=>"__"===t?m[p++]:t);yield r.apply(g,c,_),h=[g,..._],V(h,o,t,!1)}return h}))()}static getObjectAt(t,r,e){return s((function*(){return(yield Tt.getObjectsAt(t.txId,r,e))[t.virtualIndex]}))()}get(t,r){var e=this;if("_initialized"===r)return Reflect.get(this,r);if(["_id","_rev","_owners","_amount","__pos"].includes(r))return Reflect.get(this.__target,r);if("__target"===r)return this.__target;if("_on"===r||"_once"===r)return(t,e)=>this.eventEmitter[r.substring(1)](t,e);if("_close"===r)throw new Error("Smart objects do not need to be closed anymore.");return t&&r&&"function"!=typeof t[r]?Reflect.get(t,r):Object.prototype.hasOwnProperty.call(t.constructor.prototype,r)?function(){var n=s((function*(){for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];var s=a.filter(t=>t._rev);var o=N(s);var u=a.map(t=>t._rev?"__":t);var c=a.map(t=>t._rev?t.__target:t);var d=N(t);var{res:v}=yield e.sandbox.apply(d,r,c);"object"==typeof v&&(v._isRes=!0);var h=e.db.wallet.getPublicKey().toString();H(t,h);var p=C([t,...o]);var l=C([d,...s]);var f=A(p,l);"object"!=typeof v||v._rev||(f._res={__kind:"N",old:null,new:v});var g=M(f,h);var m=[];var _=[];Object.entries(g).forEach(t=>{var[r,e]=t;var{_owners:n,_amount:a,_isRes:i}=e.new;var s={path:r,_owners:n,_amount:a};"N"===e.__kind?m.push([[],[s]]):("C"===e.__kind||"S"===e.__kind&&2===r.length||"S"===e.__kind&&i)&&_.push([[e.old._rev],[s]])});var y=_.concat(m);var w=y.flatMap(t=>t[0]);var b=y.flatMap(t=>t[1]);void 0!==b[0]&&(b[0].__func=r,b[0]._args=u);var O=b.map(W.fromJSON);var[{txId:S}]=yield e.db.update(w,O);var x=Object.entries(f).findIndex(t=>{var[,r]=t;return r.new._isRes});var I=null;var P={txId:S,virtualIndex:x};"object"==typeof v&&(v._id=P,v._rev=P,delete v._isRes,I=new Tt({id:P,__target:v,chain:e.chain,db:e.db,sandbox:e.sandbox,eventEmitter:e.eventEmitter,socket:e.socket}));var{eventEmitter:k}=e;return new Promise(t=>{k.once("updated",()=>{"object"!=typeof v||v._rev?t(v):t(new Proxy(v,I))})})}));return function(){return n.apply(this,arguments)}}():Reflect.get(t,r)}set(t,r,e){return this.__target[r]=e,!0}}var{Mnemonic:Et,PublicKey:Bt}=n;var Nt=function(){var t=s((function*(t,r){return new Promise(e=>{t._initialized||t._once(r,e)})}));return function(r,e){return t.apply(this,arguments)}}();class Kt{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};var{chain:e,seed:n}=t;var{sandbox:a=new Dt}=t;var{mnemonic:i=new Et(n)}=t;var{db:s=It.fromMnemonic(i,e)}=t;this.db=s,this.sandbox=a,this.socket=r.connect(h)}_createSmartObject(t,r,e){var{db:n,socket:a,sandbox:i}=this;var{chain:s}=n.wallet.restClient;var o=new Tt({__target:t,chain:s,db:n,sandbox:i,eventEmitter:e,socket:a,id:r});return new Proxy(t,o)}formatContract(t){var r=this;return s((function*(){return"string"===D(t)&&(t=(t=t.startsWith("export ")?t.slice(7):t).startsWith("default ")?t.slice(8):t,t="(".concat(t,")"),t=yield r.sandbox.eval(t)),t}))()}new(t){var r=this;var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return s((function*(){var a=n.filter(t=>t._rev);var i=N(a);var s=n.map(t=>t._rev?"__":t);var o=n.map(t=>t._rev?t.__target:t);var u=new(t=yield r.formatContract(t))(...o);var c=r.db.wallet.getPublicKey().toString();H(u,c);var d=C([null,...i]);var v=C([u,...a]);var h=A(d,v);var p=M(h,c);var l=[];var f=[];Object.entries(p).forEach(t=>{var[r,e]=t;var{_owners:n,_amount:a}=e.new;var i={path:r,_owners:n,_amount:a};"N"===e.__kind?l.push([[],[i]]):("C"===e.__kind||"S"===e.__kind&&2===r.length)&&f.push([[e.old._rev],[i]])});var g=f.concat(l);var m=g.flatMap(t=>t[0]);var _=g.flatMap(t=>t[1]);void 0!==_[0]&&(_[0].__func="constructor",_[0]._args=s,_[0].__cls=t.toString());var y=_.map(W.fromJSON);var[w]=yield r.db.update(m,y);V([u],_,w.txId,!0);var b=new e;var O=r._createSmartObject(u,w,b);return yield Nt(O,"initialized"),O}))()}sync(t){var r=this;return s((function*(){var e=yield Tt.getObjectAt(t,r.sandbox,r.db.wallet.restClient.chain);return r._createSmartObject(e,t)}))()}shutdown(){this.socket.disconnect(!0)}getOwnedRevs(){var t=this;return s((function*(){return Kt.getOwnedRevs(t.db.wallet.getPublicKey())}))()}static getOwnedRevs(t){return s((function*(){return tt.getOwnedRevs(t)}))()}}module.exports=Kt;
