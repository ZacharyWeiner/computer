"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var r=t(require("socket.io-client"));var e=t(require("bitcoinsource"));var n=t(require("axios"));require("bchaddrjs");var a=t(require("eventemitter3"));function i(t,r,e,n,a,i,u){try{var o=t[i](u);var s=o.value}catch(t){return void e(t)}o.done?r(s):Promise.resolve(s).then(n,a)}function u(t){return function(){var r=this,e=arguments;return new Promise((function(n,a){var u=t.apply(r,e);function o(t){i(u,n,a,o,s,"next",t)}function s(t){i(u,n,a,o,s,"throw",t)}o(void 0)}))}}function o(t,r,e){return r in t?Object.defineProperty(t,r,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[r]=e,t}function s(t,r){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),e.push.apply(e,n)}return e}function c(t){for(var r=1;r<arguments.length;r++){var e=null!=arguments[r]?arguments[r]:{};r%2?s(Object(e),!0).forEach((function(r){o(t,r,e[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):s(Object(e)).forEach((function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(e,r))}))}return t}function d(t,r){if(null==t)return{};var e={};var n=Object.keys(t);var a,i;for(i=0;i<n.length;i++)a=n[i],r.indexOf(a)>=0||(e[a]=t[a]);return e}function v(t,r){if(null==t)return{};var e=d(t,r);var n,a;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(a=0;a<i.length;a++)n=i[a],r.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(e[n]=t[n])}return e}function p(t,r){if("object"!=typeof t||null===t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,r||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}function h(t){var r=p(t,"string");return"symbol"==typeof r?r:String(r)}var l="BSV";var f="mainnet";var m=546;var _=2e3;var g=2e4;var y=479;var O="https://bchsvexplorer.com/api";var w="http://bitcoinbroadcastserver-env.r5t6c3b2kj.us-west-1.elasticbeanstalk.com";var b="ws://bitcoinbroadcastserver-env.r5t6c3b2kj.us-west-1.elasticbeanstalk.com:8020";var S={CHAIN:l,BITCOIN_NETWORK:f,BLOCK_EXPLORER_URL:O,MIN_SATOSHI_AMOUNT:m,MIN_NON_DUST_AMOUNT:_,SCRIPT_CHUNK_SIZE:y,UN_P2SH_URL:w,DEFAULT_FEE:g,WS_URL:b};e.versionGuard=()=>!0,e.Networks.defaultNetwork=e.Networks[S.BITCOIN_NETWORK];class x extends Error{constructor(t,r){for(var e=arguments.length,n=new Array(e>2?e-2:0),a=2;a<e;a++)n[a-2]=arguments[a];super(...n),this.name="Error",this.message=t+(r?": ".concat(r):""),Error.captureStackTrace&&Error.captureStackTrace(this,x)}}function I(t){return{writable:!0,value:t}}function P(t,r,e){var{[t]:n}=e;return c({[r]:n},v(e,[t].map(h)))}var N=function(){var t=u((function*(t){try{return(yield t).data}catch(t){if(t.response){var{status:r,statusText:e,data:n}=t.response;var{method:a,url:i}=t.response.config||{method:"unknown",url:"unknown"};var u=t.response.config.data;var o=n.error||(-1!==n.indexOf("Code:")?n:e);throw new x("\nCommunication Error\n\nstatus\t".concat(r," ").concat(e,"\nmessage\t").concat(o,"\nrequest\t").concat(a," ").concat(i).concat(u?"\ndata\t".concat(u):""))}throw new x("Communication error","Service unavailable.")}}));return function(r){return t.apply(this,arguments)}}();var k=function(){var t=u((function*(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:S.BLOCK_EXPLORER_URL;var e=yield N(n.get("".concat(r).concat(t)));return e}));return function(r){return t.apply(this,arguments)}}();var E=function(){var t=u((function*(t,r){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:S.BLOCK_EXPLORER_URL;return N(n.post("".concat(e).concat(t),r))}));return function(r,e){return t.apply(this,arguments)}}();var D=function(){var t=u((function*(t){var{balanceSat:r}=yield k("/addr/".concat(t.toString()));return r}));return function(r){return t.apply(this,arguments)}}();var T=function(){var t=u((function*(t){return k("/tx/".concat(t))}));return function(r){return t.apply(this,arguments)}}();var j=function(){var t=u((function*(t){return(yield k("/rawtx/".concat(t))).rawtx}));return function(r){return t.apply(this,arguments)}}();var R=function(){var t=u((function*(t){var r={rawtx:t.toString()};return(t=>{var{txid:r}=t;return c({txId:r},v(t,["txid"]))})(yield E("/tx/send",r))}));return function(r){return t.apply(this,arguments)}}();var K=function(){var t=u((function*(t){return(yield k("/addr/".concat(t.toString(),"/utxo"))).map(t=>{var{txid:r}=t;return c({txId:r},v(t,["txid"]))})}));return function(r){return t.apply(this,arguments)}}();var U=function(){var t=u((function*(t){var r=t.map(t=>t.__txId);var e=[...new Set(r)];var n=new Map;return yield Promise.all(e.map(function(){var t=u((function*(t){return n.set(t,yield T(t))}));return function(r){return t.apply(this,arguments)}}())),t.map(t=>{var{vout:r,blockheight:e,confirmations:a}=n.get(t.__txId)||{};return t.__vouts.map(n=>{var{scriptPubKey:i,value:u,spentTxId:o}=r[n];return{address:i.addresses[0],txId:t.__txId,vout:n,scriptPubKey:i.hex,amount:parseFloat(u),satoshis:parseInt(1e8*u,10),height:e,confirmations:a}})})}));return function(r){return t.apply(this,arguments)}}();var A=function(){var t=u((function*(t){return E("/",t,S.UN_P2SH_URL)}));return function(r){return t.apply(this,arguments)}}();var J=function(){var t=u((function*(t){return k("/un-p2sh/".concat(t),S.UN_P2SH_URL)}));return function(r){return t.apply(this,arguments)}}();var M=function(){var t=u((function*(t){return k("/txos/".concat(t.toString()),S.UN_P2SH_URL)}));return function(r){return t.apply(this,arguments)}}();var C=function(){var t=u((function*(t){return E("/txos/set-spent/",t,S.UN_P2SH_URL)}));return function(r){return t.apply(this,arguments)}}();class H{constructor(t){this.kind=t}toJSON(){return{}}static fromOutputId(t){return u((function*(){var{txId:r,virtualIndex:e}=t;return(yield J(r))[e]}))()}}var{PublicKey:L,Transaction:B,Script:F}=e;class W extends H{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super("script"),Object.assign(this,t),this._amount=t._amount||S.MIN_NON_DUST_AMOUNT}getData(t){return this[t]}getSerializeData(){var t=v(this,["kind","_owners","_amount"]);return Buffer.from(JSON.stringify(t))}static fromMultiSigScriptHashInput(t){var{_scriptBuffer:r}=t;var e=et.fromBuffer(r);var{redeemScript:n=et.redeemScriptFromP2shScript(e)}=t;return this.fromRedeemScript(n)}static fromRedeemScript(t){return this.fromRedeemScripts([t])}static fromRedeemScripts(t){var r=t.map(t=>t.chunks[t.chunks.length-2].buf);var e=Buffer.concat(r);var n=JSON.parse(e.toString());return Object.assign(new this,c({kind:"script",_owners:t[0].getPublicKeys(),_amount:S.MIN_NON_DUST_AMOUNT},n))}static addVouts(t){var r=0;return t.map(t=>{var e="script"===t.kind?et.outScriptFromData(t).length:1;return t.__vouts=Array(e).fill(r).map((t,r)=>t+r),r+=e,t})}toJSON(){return c({},this,{kind:"script",_owners:(this._owners||[]).map(t=>t.toString()),_amount:S.MIN_NON_DUST_AMOUNT})}static isJSON(t){return"script"===t.kind}static fromJSON(t){var r=c({},t);return r._owners=(r._owners||[]).map(t=>new L(t)),new W(r)}}var{PublicKey:z,Address:q,Transaction:V}=e;class Z extends H{constructor(t,r){super("pkh"),this.address=t,this.amount=r}static fromPublicKeyHashInput(t){var{output:r}=t;return new this(r.script.toAddress(),r.satoshis)}toJSON(){return{kind:"pkh",address:this.address.toString(),amount:this.amount}}static isJSON(t){return t.address&&t.amount}static fromJSON(t){return new this(new q(t.address),t.amount)}}class G extends H{constructor(t){super("return"),this.data=t||""}getData(){return this.data}toJSON(){return{kind:"return",data:this.data}}static isJSON(t){return!!t.data}static fromJSON(t){return new this(t.data)}}var{Address:X,PublicKey:Q,Signature:Y,Script:$,Opcode:tt}=e;function rt(t,r){var e=[];var n=0;for(;n<t.length;)e.push(t.slice(n,n+r)),n+=r;return e}class et extends ${static outScriptFromData(t){var{kind:r,_owners:e=[],_amount:n,__vouts:a,__txId:i}=t,u=v(t,["kind","_owners","_amount","__vouts","__txId"]);var o=rt(Buffer.from(JSON.stringify(u)),S.SCRIPT_CHUNK_SIZE);return o[o.length-1].byteLength>=S.SCRIPT_CHUNK_SIZE&&rt(o.pop(),S.SCRIPT_CHUNK_SIZE).forEach(t=>{o.push(t)}),o.map(t=>{var r=new et;return r.add("OP_1"),e.forEach(t=>r.add(t.toBuffer())),r.add("OP_".concat(e.length)),r.add("OP_CHECKMULTISIG"),r.add(t),r.add("OP_DROP"),{redeemScript:r,chunk:t}})}getPublicKeys(){var t=1;var r=[];for(;this.chunks[t].buf;)r.push(new Q(this.chunks[t].buf)),t+=1;return r}static inScriptFromData(t,r,e,n){var a=new et;return e.forEach(t=>{a.add(t)}),a.add(a),a}isDbDataScript(){return!(!(this.chunks.length>=5&&this.chunks[0].opcodenum===tt.OP_1&&this.chunks[1].buf)||20!==this.chunks[1].buf.length&&33!==this.chunks[1].buf.length||this.chunks[2].opcodenum!==tt.OP_1||this.chunks[3].opcodenum!==tt.OP_CHECKMULTISIG||!this.chunks[4].buf||this.chunks[5].opcodenum!==tt.OP_DROP)}static isP2shScript(t){return!(3!==t.chunks.length||t.chunks[0].opcodenum!==tt.OP_0||!t.chunks[1].buf||!t.chunks[2].buf)}static redeemScriptFromP2shScript(t){if(!this.isP2shScript(t))throw new Error("not a p2sh script");var r=new $(t.chunks[2].buf);var e=new this;return e.chunks=r.chunks,e}static fromScript(t){var r=new $(t);var e=new et;return e.chunks=r.chunks,e}}var{PublicKey:nt,Address:at}=e;class it extends H{constructor(t){super("change"),this.address=t}toJSON(){return{kind:"change",address:this.address.toString()}}static isJSON(t){return t.address}static fromJSON(t){return new this(new at(t.address))}}var ut=t=>"object"==typeof t?Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1]:Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1].toLowerCase();var ot=t=>["undefined","number","string","boolean","Null"].includes(ut(t));var st=t=>ot(t)||["Array","Object"].includes(ut(t));var ct=t=>t===parseInt(t,10).toString();var dt=(t,r)=>{if(!st(t)||!st(r))throw new Error("Unsupported data types for deep equals: ".concat(ut(t)," & ").concat(ut(r)));return ut(t)===ut(r)&&(ot(t)&&ot(r)?t===r:t&&r&&Object.entries(t).every(t=>{var[e,n]=t;return dt(r[e],n)})&&Object.entries(r).every(r=>{var[e,n]=r;return dt(t[e],n)}))};var vt=t=>{if(ot(t))return t;if("Array"===ut(t))return t.map(t=>vt(t));if("Object"===ut(t)){var r=Object.keys(t).reduce((r,e)=>(r[e]=vt(t[e]),r),{});var e=Object.create(Object.getPrototypeOf(t));return Object.assign(e,r)}throw new Error("Unsupported data type for clone: ".concat(ut(t)))};var pt=function t(r){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];var a=e;for(var i of(n[e]={},Object.keys(r)))i.startsWith("_")?n[a][i]=r[i]:ot(r[i])?n[a][i]="_":(e+=1,n[a][i]=e,({res:n,pos:e}=t(r[i],e,n)));return{res:n,pos:e}};var ht=function t(r){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;var n=r[e];if(void 0===n)return"_";var a=Object.keys(n).every(ct);var i=a?[]:{};for(var u of Object.keys(n))u.startsWith("_")?i[u]=n[u]:i[u]=t(r,n[u]);return i};class lt{static fromJSON(t){if(W.isJSON(t))return W.fromJSON(t);if(Z.isJSON(t))return Z.fromJSON(t);if(it.isJSON(t))return it.fromJSON(t);if(G.isJSON(t))return G.fromJSON(t);throw new Error("unrecognized json ".concat(JSON.stringify(t)))}}var{Mnemonic:ft,HDPrivateKey:mt,PrivateKey:_t,PublicKey:gt,Address:yt,OutputData:Ot}=e;class wt{constructor(t){this.mnemonic=t||new ft,this.path="",this.hdPrivateKey=this.mnemonic.toHDPrivateKey(this.path,S.BITCOIN_NETWORK)}static getRandomMnemonic(){return(new ft).toString()}static fromMnemonic(t){return new wt(t)}getMnemonic(){return this.mnemonic}getPath(){return this.path}derive(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];var e=new wt(this.mnemonic);return e.path="".concat(this.path).concat(this.path.length?"/":"").concat(t).concat(r?"'":""),e.hdPrivateKey=this.hdPrivateKey.derive(t,r),e}static getHdPrivateKey(){return new mt}getPrivateKey(){return this.hdPrivateKey.privateKey}getPublicKey(){return this.hdPrivateKey.publicKey}getAddress(){return this.address=this.address||this.getPublicKey().toAddress(S.BITCOIN_NETWORK),this.address}getBalance(){var t=this;return u((function*(){var r=t.getAddress();return D(r.toString())}))()}getUtxos(t){var r=arguments,e=this;return u((function*(){var n=r.length>1&&void 0!==r[1]?r[1]:e.getAddress();var a=yield K(n);for(var i=a.length-1;i>0;i-=1){var u=Math.floor(Math.random()*(i+1));var o=a[i];a[i]=a[u],a[u]=o}var s=0;var c=[];var d=0;for(;s<t&&d<a.length;)c.push(a[d]),s+=a[d].satoshis,d+=1;if(s<t)throw new Error("Insufficient balance in address ".concat(n.toString()));return c}))()}sendTransaction(t){var r=arguments;return u((function*(){var e=r.length>1&&void 0!==r[1]&&r[1];var{txId:n}=yield R(t);if(e){var a=JSON.stringify(t.outputData.map(t=>t.toJSON()));var i=t.toJSON().inputs.map(t=>{var{prevTxId:r,outputIndex:e}=t;return{txId:r,outputIndex:e}});yield A({txId:n,outputData:a,inputs:i})}return{txId:n}}))()}send(t,r,e){var n=this;return u((function*(){var a="string"==typeof r?r:r.toString();"string"==typeof e&&yt.fromString(e);var i=lt.fromJSON({amount:t,address:a});return n.sendOutputData([i],e)}))()}sendOutputData(t,r){var e=this;return u((function*(){var n=new Ut;var a=r||e.getAddress();var i=S.DEFAULT_FEE;var u=e.getPrivateKey();var o=t.reduce((t,r)=>t+parseInt(r.amount||0,10),0);return(yield e.getUtxos(o+i)).forEach(n.from.bind(n)),t.forEach(n.to.bind(n)),n.change(a),n.sign(u),e.sendTransaction(n)}))()}sendAll(t){var r=this;return u((function*(){var e=yield r.getBalance();var n=S.DEFAULT_FEE;if(e>n){var a=new Z(t,e-n);return r.sendOutputData([a])}throw new Error("Insufficient funds to send payment.")}))()}}class bt{constructor(t){this.wallet=t||new wt}static fromMnemonic(t){return new this(new wt(t))}put(t){var r=this;return u((function*(){return r.update([],t)}))()}get(t){return u((function*(){return bt.get(t)}))()}static getOutputDataMap(t){return u((function*(){var r=[...new Set(t)];var e=yield Promise.all(r.map(function(){var t=u((function*(t){var r=(yield J(t)).map(lt.fromJSON);var e=0;var n=r.map(r=>{var n="script"===r.kind?et.outScriptFromData(r).length:1;var a=Array(n).fill(e).map((t,r)=>t+r);return e+=n,c({},r,{__vouts:a,__txId:t})});return[t,n]}));return function(r){return t.apply(this,arguments)}}()));return new Map(e)}))()}static get(t){var r=this;return u((function*(){var e=t.map(t=>t.txId);var n=yield r.getOutputDataMap(e);return t.map(t=>{var{txId:r,virtualIndex:e}=t;var a=n.get(r);if(!a||!Array.isArray(a))throw new Error("No data found.");return a[e]})}))()}update(t,r){var e=this;return u((function*(){var n=new Ut;var a=yield e.get(t);var i=yield U(a);t.forEach(function(){var t=u((function*(t,r){n.fromScriptOutput(i[r],a[r])}));return function(r,e){return t.apply(this,arguments)}}());var o=r.map(n.to.bind(n));var s=(n._estimateSize()+20)*(S.DEFAULT_FEE/1e3);(yield e.wallet.getUtxos(s)).forEach(n.from.bind(n)),n.fee(s),n.change(e.wallet.getAddress()),n.sign(e.wallet.getPrivateKey());var{txId:c}=yield e.wallet.sendTransaction(n,!0);return t.forEach(function(){var t=u((function*(t){yield C(t)}));return function(r){return t.apply(this,arguments)}}()),o.map(t=>({txId:c,virtualIndex:t}))}))()}}var{Transaction:St,PublicKey:xt,Address:It,BN:Pt,Script:Nt,encoding:kt}=e;var{Output:Et,Input:Dt}=St;var{MultiSigScriptHash:Tt,PublicKeyHashInput:jt}=Dt;var{BufferReader:Rt}=kt;var Kt=t=>new Promise(r=>setTimeout(r,t));class Ut extends St{constructor(t){super(t),this._outputData=[],Object.defineProperty(this,"to",I(this._to)),Object.defineProperty(this,"from",I(this._from))}get dataInputs(){var t=[];var r=function*(t){for(var r of t)yield r}(this.inputs);var e=r.next();for(;!e.done;){var n=e.value;var a=et.fromScript(n._scriptBuffer);if(a.isPublicKeyHashIn())t.push(new Z(a.toAddress(),0));else if(et.isP2shScript(a)){var i=!1;var u=[et.redeemScriptFromP2shScript(a)];for(;!i;)try{t.push(W.fromRedeemScripts(u)),i=!0}catch(t){var o=r.next();if(o.done)throw new Error("Could not compute data inputs");var s=o.value;var c=et.fromScript(s._scriptBuffer);u.push(et.redeemScriptFromP2shScript(c))}}e=r.next()}return t}set dataInputs(t){throw Error("dataTransaction.dataInputs cannot be set directly, use dataTransaction.from or dataTransaction.fromScriptOutput")}get inputsWithData(){return this.dataInputs.filter(t=>"script"===t.kind)}getVirtualInputs(){var t=this;return u((function*(){var{inputsWithData:r}=t;var e=W.addVouts(r);return Promise.all(e.map(function(){var r=u((function*(r){var e=[];if(r.__vouts.forEach(r=>{e.push(t.inputs[r])}),!e.every(t=>t.prevTxId.toString("hex")===e[0].prevTxId.toString("hex")))throw new Error("Something went wrong 1");var n=e[0].prevTxId.toString("hex");var a=yield Ut.fromTxId(n);yield a.fetchOutputData();var i=W.addVouts(a.outputData);var u=[];if(i.forEach((t,r)=>{dt(t.__vouts,e.map(t=>t.outputIndex))&&u.push(r)}),u.length>1)throw new Error("Something went wrong 2");return{txId:n,virtualIndex:u[0]}}));return function(t){return r.apply(this,arguments)}}()))}))()}fromMultiSig(t,r,e){var n=t.map(t=>P("txId","txid",t));return super.from(n,r,e)}_from(t){var r=P("txId","txid",t);return super.from(r)}fromScriptOutput(t,r){var e=et.outScriptFromData(r);var{_owners:n}=r;return e.forEach((r,e)=>{var{redeemScript:a}=r;var{scriptPubKey:i,satoshis:u,txId:o,vout:s}=t[e];var c=new Et({script:new et(i),satoshis:parseInt(u,10)});var d=new et;var v=new Tt({prevTxId:o,output:c,outputIndex:s,script:d},n,1,null,a);this.addInput(v)}),this}get outputData(){if(!this._outputData.length)throw new Error("dataTransaction.outputData is not initialized. Call dataTransaction.fetchDataOuptuts() first.");return this._outputData}set outputData(t){throw Error("dataTransaction.outputData cannot be set directly")}get outputsWithData(){return this.outputData.filter(t=>"script"===t.kind)}change(t){var r=this.outputs.length;return super.change(t),this.outputs.length>r&&this._outputData.push(new it(t)),this}toChangeOutput(t){var r=this.outputs.length;return super.change(t.address),this.outputs.length>r&&this._outputData.push(t),this._outputData.length-1}toPkhOutput(t){return super.to(t.address,t.amount),this._outputData.push(t),this._outputData.length-1}toScriptOutput(t){var r=et.outScriptFromData(t);return this._outputData.push(t),r.forEach(r=>{var{redeemScript:e,chunk:n}=r;var a=et.buildScriptHashOut(e);var i=t._amount;var u=new Et({script:a,satoshis:i});this.addOutput(u)}),this._outputData.length-1}toReturnOutput(t){return this.addData(t.data),this._outputData.push(t),this._outputData.length-1}_to(t){switch(t.kind){case"change":return this.toChangeOutput(t);case"return":return this.toReturnOutput(t);case"script":return this.toScriptOutput(t);case"pkh":return this.toPkhOutput(t);default:throw new Error("Unsupported output kind ".concat(t.kind))}}fetchOutputData(){var t=this;return u((function*(){if(t._outputData.length)return t._outputData;var r=t.getTxId();var e=yield J(r);return t._outputData=e.map(lt.fromJSON),t._outputData}))()}get prevObjectIds(){return this.inputs.map(t=>({txId:t.prevTxId.toString("hex"),virtualIndex:t.outputIndex}))}getTxId(){return new Rt(this._getHash()).readReverse().toString("hex")}static fromTxId(t){return u((function*(){var r=null;try{r=yield j(t)}catch(e){yield Kt(3e3),r=yield j(t)}var e=new Ut;return yield e.fromString(r),e}))()}}class At{eval(t){return u((function*(){return eval(t)}))()}apply(t,r,e){return u((function*(){return{res:t[r](...e),obj:t}}))()}}class Jt{constructor(){return new At}eval(t){var r=this;return u((function*(){return r.sandbox.eval(t)}))()}apply(t,r,e){var n=this;return u((function*(){return n.sandbox.apply(t,r,e)}))()}}var Mt=t=>new Promise(r=>setTimeout(r,t));class Ct{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};var{id:r,target:e={},db:n=new bt,sandbox:i=new Jt,eventEmitter:u=new a,socket:o}=t;this._id=r,this._rev=r,this.__target=e,this.db=n,this.sandbox=i,this.eventEmitter=u,this.socket=o,this.socket.on("message",this.onWebsocketMessage.bind(this)),this._initialized=!1,this.poll()}poll(){var t=this;return u((function*(){for(;!t._initialized;)try{yield T(t._id.txId),t._initialized=!0}catch(t){yield Mt(500)}t.eventEmitter.emit("initialized")}))()}onWebsocketMessage(t){var r=this;return u((function*(){var{data:e}=t;try{var{txId:n}=JSON.parse(e)||{};var a=yield Ut.fromTxId(n);yield a.fetchOutputData();var{__func:i,_args:o}=a.outputData[0];var s=yield a.getVirtualInputs();var c=s.findIndex(t=>dt(t,r._rev));if("constructor"===i||-1===c)return;var d=yield Promise.all(s.map(function(){var t=u((function*(t){return dt(t,r._rev)?r.__target:Ct.getObjectAt(t,r.sandbox)}));return function(r){return t.apply(this,arguments)}}()));var v=0;var[p,...h]=d;var l=o.map(t=>"__"===t?h[v++]:t);yield r.sandbox.apply(p,i,l),r._rev={txId:n,virtualIndex:c},r.eventEmitter.emit("updated")}catch(t){throw console.log("Error on websocket message",t),t}}))()}static getObjectAt(t,r){return u((function*(){var e=yield Ut.fromTxId(t.txId);yield e.fetchOutputData();var n=yield e.getVirtualInputs();var a=yield Promise.all(n.map(function(){var t=u((function*(t){return Ct.getObjectAt(t,r)}));return function(r){return t.apply(this,arguments)}}()));var{__func:i,_args:o,__cls:s}=e.outputData[0];var c=null;var d=0;if("constructor"===i){var v=a;var p=o.map(t=>"__"===t?v[d++]:t);c=[new(yield r.eval("(".concat(s,")")))(...p),...p]}else{var[h,...l]=a;var f=o.map(t=>"__"===t?l[d++]:t);yield r.apply(h,i,f),c=[h,...f]}return c[t.virtualIndex]}))()}get(t,r){var e=this;if("_id"===r||"_rev"===r||"_initialized"===r)return Reflect.get(this,r);if("_owners"===r||"_amount"===r)return Reflect.get(this.__target,r);if("__target"===r)return this.__target;if("_on"===r||"_once"===r)return(t,e)=>this.eventEmitter[r.substring(1)](t,e);if("_close"===r)throw new Error("Smart objects do not need to be closed anymore.");return t&&r&&"function"!=typeof t[r]?Reflect.get(t,r):Object.prototype.hasOwnProperty.call(t.constructor.prototype,r)?u((function*(){for(var t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];var i=yield global.computer.update(e,r,n);yield e.db.update(global.computer.oldRevs,global.computer.newOutputs),global.computer.reset();var{eventEmitter:u}=e;return new Promise(t=>{u.once("updated",()=>{t(i)})})})):Reflect.get(t,r)}set(t,r,e){if("_rev"===r)return this._rev=e,!0;throw new Error("Cannot set property of smart object")}}class Ht{constructor(t){this.publicKey=t,this.newOutputs=[],this.oldRevs=[]}static encode(t,r){var{res:e}=pt([t,...r]);var n=e.shift();var a=Object.values(n);return e[0]._partition=a,e}static decode(t){var r=t[0]._partition;delete t[0]._partition;var e={};var n=0;for(var a of r)e[n]=a,n+=1;t.unshift(e);var i=ht(t);return{target:i.shift(),params:i}}new(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];var e=r.filter(t=>t._rev);var n=r.map(t=>t._rev?"__":t);var a=r.map(t=>t._rev?t.__target:t);var i=e.map(t=>t._rev);var u=new t(...a);u._owners=u._owners||[this.publicKey.toString()],u._amount=u._amount||S.MIN_NON_DUST_AMOUNT;var o=Ht.encode(u,e);o[0].__cls=t.toString(),o[0].__func="constructor",o[0]._args=n;var s=o.map(W.fromJSON.bind(this));return this.oldRevs=[...i],this.newOutputs=s,u}update(t,r,e){var n=this;return u((function*(){var{__target:a,_rev:i,sandbox:u}=t;var o=e.filter(t=>t._rev);var s=e.map(t=>t._rev?"__":t);var c=e.map(t=>t._rev?t.__target:t);var d=o.map(t=>t._rev);var v=vt(a);var{res:p,obj:h}=yield u.apply(v,r,c);var l=Ht.encode(v,o);l[0].__func=r,l[0]._args=s,l[0]._owners=h._owners||v.owners,l[0]._amount=h._amount||v._amount;var f=l.map(W.fromJSON.bind(n));return n.oldRevs=[i,...d],n.newOutputs=f,p}))()}reset(){this.oldRevs=[],this.newOutputs=[]}}var{Mnemonic:Lt,PublicKey:Bt}=e;var Ft=function(){var t=u((function*(t,r){return new Promise(e=>{t._initialized||t._once(r,e)})}));return function(r,e){return t.apply(this,arguments)}}();class Wt{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};var{seed:e,mnemonic:n=new Lt(e),db:a=bt.fromMnemonic(n),sandbox:i=new Jt}=t;this.db=a,this.sandbox=i,this.socket=r.connect(S.UN_P2SH_URL),global.computer=new Ht(this.db.wallet.getPublicKey())}_createSmartObject(t,r){var{db:e,socket:n}=this;var a=new Ct({id:r,target:t,db:e,socket:n});return new Proxy(t,a)}formatContract(t){var r=this;return u((function*(){return"string"===ut(t)&&(t=(t=t.startsWith("export ")?t.slice(7):t).startsWith("default ")?t.slice(8):t,t="(".concat(t,")"),t=yield r.sandbox.eval(t)),t}))()}new(t){var r=arguments,e=this;return u((function*(){var n=r.length>1&&void 0!==r[1]?r[1]:[];t=yield e.formatContract(t);var a=global.computer.new(t,n);var i=yield e.db.update(global.computer.oldRevs,global.computer.newOutputs);global.computer.reset(),n.filter(t=>t._rev).forEach((t,r)=>{t._rev=i[r+1]});var u=e._createSmartObject(a,i[0]);return yield Ft(u,"initialized"),u}))()}sync(t){var r=this;return u((function*(){var e=yield Ct.getObjectAt(t,r.sandbox);return r._createSmartObject(e,t)}))()}shutdown(){this.socket.disconnect(!0)}close(){throw new Error("computer.close() has been renamed to computer.shutdown()")}static getOlder(t){return u((function*(){var{txId:r,virtualIndex:e}=t[0];var n=yield Ut.fromTxId(r);return yield n.fetchOutputData(),"constructor"!==n.outputData[e].__func&&[{txId:n.inputs[0].prevTxId.toString("hex"),virtualIndex:n.inputs[0].outputIndex}]}))()}static getOldest(t){var r=this;return u((function*(){var e=yield r.getOlder(t);return e?r.getOldest(e):t}))()}getOwnedRevs(){var t=this;return u((function*(){return Wt.getOwnedRevs(t.db.wallet.getPublicKey())}))()}static getOwnedRevs(t){return u((function*(){return M(t)}))()}}module.exports=Wt;
