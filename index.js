"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var e=t(require("bitcoinsource"));var r=t(require("axios"));
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function n(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(t);s<n.length;s++)e.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(t,n[s])&&(r[n[s]]=t[n[s]])}return r}function s(t,e,r,n){return new(r||(r=Promise))((function(s,i){function a(t){try{c(n.next(t))}catch(t){i(t)}}function o(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,o)}c((n=n.apply(t,e||[])).next())}))}var i=process.env.BC_CHAIN||"BSV";var a=process.env.BC_NETWORK||"testnet";var o=process.env.BC_WOC_API_KEY||void 0;var c=parseInt(process.env.BC_DUST_LIMIT,10)||4e3;var u=parseInt(process.env.BC_DEFAULT_FEE,10)||("BSV"===i?500:2500);var h=parseInt(process.env.BC_SCRIPT_CHUNK_SIZE,10)||479;var p;var d;process.env.BC_BBS_URL?(d="http://".concat(process.env.BC_BBS_URL),p="ws://".concat(process.env.BC_BBS_URL)):(d="https://bbs.bitcoincomputer.io",p="wss://bbs.bitcoincomputer.io");var l={CHAIN:i,NETWORK:a,WOC_API_KEY:o,MIN_NON_DUST_AMOUNT:c,SCRIPT_CHUNK_SIZE:h,UN_P2SH_URL:d,WS_URL:p,DEFAULT_FEE:u};e.versionGuard=()=>!0,e.Networks.defaultNetwork=e.Networks[l.NETWORK];const{PublicKey:v}=e;const f=()=>"__temp__:"+Math.random();const g=["_id","_rev","_owners","_amount","__vouts","__txId","__cls","__func","__index","__args"];const _=t=>Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1];const m=t=>"object"==typeof t?_(t):_(t).toLowerCase();const w=t=>["number","string","boolean","undefined","Null"].includes(m(t));const b=t=>"Array"===m(t);const y=t=>"Object"===m(t);const O=t=>!!t._owners&&"object"==typeof t._owners;const S=t=>!!t._owners&&"string"==typeof t._owners;const x=t=>!!t._amount;const I=t=>w(t)||["Array","Object"].includes(m(t));const j=t=>"Object"===m(t)&&Object.keys(t).every(t=>!Number.isNaN(parseInt(t,10)));const P=(t,e)=>{if(!I(t)||!I(e))throw new Error(`Unsupported data types for deep equals: ${m(t)} & ${m(e)}`);if(m(t)!==m(e))return!1;if(w(t)&&w(e))return t===e;const r=(t,e)=>Object.entries(t).every(([t,r])=>P(e[t],r));return t&&e&&r(t,e)&&r(e,t)};const E=t=>{if(w(t))return t;if(b(t))return t.map(E);if(y(t)){const e=Object.keys(t).reduce((e,r)=>(e[r]=E(t[r]),e),{});const r=Object.create(Object.getPrototypeOf(t));return Object.assign(r,e)}throw new Error("Unsupported data type for clone: "+m(t))};const T=(t,e)=>t.reduce(([t,r],n,s)=>e(n,s)?[[...t,n],r]:[t,[...r,n]],[[],[]]);const C=(t,e)=>Object.fromEntries(Object.entries(t).map(t=>e(t)));const k=(t,e)=>C(t,([t,r])=>[t,e(r)]);const D=(t,e)=>Object.fromEntries(Object.entries(t).filter(([,t])=>e(t)));const K=(t,e)=>{if(w(t))return t;if(b(t))return t.map(t=>K(t,e));if(y(t)){const r=C(t,([t,r])=>[t,g.includes(t)?r:K(r,e)]);const n=x(t)?t._amount:l.MIN_NON_DUST_AMOUNT;const s=O(t)?t._owners:[e];return Object.assign(Object.assign({},r),{_amount:n,_owners:s})}throw new Error(`unsupported type ${m(t)} in setOwnersAndAmount`)};const B=(t,e,r,n)=>{if(w(t))return t;if(b(t))return t.map(t=>B(t,e,r,n));if(y(t)){t._rev=`${n}:${r}`;const s=e[r];return Object.entries(t).forEach(([r,i])=>{"object"==typeof s&&Object.keys(s).includes(r)&&(t[r]=B(i,e,s[r],n))}),t}throw new Error(`Unsupported type ${m(t)} in deep.updateRev`)};const N=t=>{if(w(t))return t;if(b(t))return t.map(t=>N(t));if(y(t))return t.__cls=t.constructor.toString(),Object.entries(t).forEach(([e,r])=>{t[e]=N(r)}),t;throw new Error(`Unsupported type ${m(t)} in deep.addClass`)};const U=t=>{if(w(t))return t;if(b(t))return t.map(t=>U(t));if(y(t))return t._id=!t._id||t._id.startsWith("__temp__")?t._rev:t._id,Object.entries(t).forEach(([e,r])=>{t[e]=U(r)}),t;throw new Error(`Unsupported type ${m(t)} in deep.addId`)};const A=t=>{if(w(t))return t;if(b(t))return t.map(t=>A(t));if(y(t)){const e=f();return t._id=t._id||e,t._rev=t._rev||e,Object.values(t).map(t=>A(t)),t}throw new Error(`Unsupported type ${m(t)} in addRandomId`)};const R=t=>{if(w(t))return t;if(b(t))return t.map(t=>R(t));if(y(t))return C(t,([t,e])=>"_owners"===t?[t,JSON.stringify(e)]:w(e)?[t,e]:[t,R(e)]);throw new Error(`Unexpected type ${m(t)} in stringifyOwners`)};const H=t=>S(t)?Object.assign(Object.assign({},t),{_owners:JSON.parse(t._owners).map(t=>new v(t))}):t;const $=t=>{if(w(t))return t;if(b(t)||y(t))return Object.entries(t).reduce((t,[e,r])=>{const n=$(r);return j(n)?Object.entries(n).forEach(([r,n])=>{t[`${e}_${r}`]=n}):t[e]=n,t},{});throw new Error(`Unsupported type ${m(t)} in encodeArraysAsObjects`)};const L=t=>{const e={[t._id]:Object.entries(t).reduce((t,[e,r])=>g.includes(e)?Object.assign(Object.assign({},t),{[e]:r}):w(r)?Object.assign(Object.assign({},t),{["__basic__"+e]:r}):Object.assign(Object.assign({},t),{[e]:r._id}),{})};return Object.values(t).filter(t=>!w(t)).reduce((t,e)=>Object.assign(Object.assign({},t),L(e)),e)};const M=t=>Object.fromEntries(Object.entries(t).filter(([t])=>!t.startsWith("__basic__")));const F=(t,e)=>Object.fromEntries(Object.entries(e).map(([e,r])=>{const n=t[e];var s;return r.__change=(s=n)?P(s,r)?"same":"diff":"new",[e,r]}));const V=(t,e)=>(t[e].__contains=Object.entries(t[e]).reduce((e,[r,n])=>["__contains"].concat(g).includes(r)?e:"__change"===r?"new"===n||"diff"===n||e:V(t,n)[n].__contains||e,!1),t);const W=t=>t.reduce((t,e,r)=>Object.assign(Object.assign({},t),{[e._id]:r}),{});const J=(t,e)=>t.map(t=>Object.entries(t).reduce((t,[r,n])=>{const s="string"==typeof n&&"undefined"!==m(e[n])?e[n]:n;return Object.assign(Object.assign({},t),{[r]:s})},{}));const z=(t,e,r)=>{const[s,...i]=[e,...t].map((t,e)=>{const s=n(t,["_id","_rev","__change","__contains"]);return 0===e||e<=r.length?n(s,["__cls"]):s});return[s,...i.map(t=>Object.fromEntries(Object.entries(t).filter(([t,e])=>g.filter(t=>"__cls"!==t).includes(t)||"__cls"===t&&"string"==typeof e&&"function Object() { [native code] }"!==e||"number"==typeof e)))]};const q=(t,e)=>{const r=A(e);const n=r._id;const s=E(t);const i=E(r);N(s),N(i);const a=R(s);const o=R(i);const c=$(a);const u=$(o);const h=L(c);const p=L(u);const d=F(h,p);const l=k(d,M);const v=V(l,n);const f=v[n];delete f.__cls,delete v[n];const g=k(v,t=>t._rev);const _=D(v,t=>t.__contains||Object.values(f).includes(t._id));const m=Object.values(_);const[w,b]=T(m,t=>"new"===t.__change);const y=[...b,...w];const O=W(y);const S=J(y,O);const[x]=J([f],O);const I=b.map(t=>t._rev);const[j,...P]=z(S,x,I);return[I,P.map(H).map(t=>Object.entries(t).reduce((t,[e,r])=>Object.assign(Object.assign({},t),{[e]:g[r]||r}),{})),j]};var Z=t=>({smartArgs:t.filter(t=>t._rev),dumbArgs:t.map(t=>t._rev?"__":t)});var G=(t,e)=>{var r=0;return e.map(e=>"__"===e?t[r++]:e)};class Y{constructor(t){this.db=t}construct(t,e){return s(this,void 0,void 0,(function*(){const[r,n]=E([e,{}]);const s=new t(...e);const{smartArgs:i,dumbArgs:a}=Z(r);const{smartArgs:o}=Z(e);const c=Object.assign(Object.assign(Object.assign({},i),{obj:n}),{_id:"index"});const u=Object.assign(Object.assign(Object.assign({},o),{obj:s}),{_id:"index"});const[h,p,d]=q(c,u);void 0!==p[0]&&(p[0].__index=d);const l=d.obj;void 0!==p[l]&&(p[l].__func="constructor",p[l].__args=a,p[l].__cls=t.toString());const[v]=yield this.db.update(h,p);const[f]=v.split(":");return Object.entries(d).forEach(([t,e])=>{B("obj"===t?s:o[t],p,e,f)}),U([s,...o]),s}))}call(t,e,r){return s(this,void 0,void 0,(function*(){const[n,s]=E([r,t]);const i=Reflect.apply(t[e],t,r);const{smartArgs:a,dumbArgs:o}=Z(n);const{smartArgs:c}=Z(r);const u=Object.assign(Object.assign(Object.assign({},a),{obj:s}),{_id:"index"});const h=Object.assign(Object.assign(Object.assign({},c),{obj:t}),{_id:"index"});"Object"===m(i)&&(h.res=i);const[p,d,l]=q(u,h);void 0!==d[0]&&(d[0].__index=l);const v=l.obj;void 0!==d[v]&&(d[v].__func=e,d[v].__args=o);const[f]=yield this.db.update(p,d);const[g]=f.split(":");return Object.entries(l).forEach(([e,r])=>{"obj"===e&&B(t,d,r,g),B("res"===e?i:c[e],d,r,g)}),U([i,t,...c]),i}))}get(t,e){return"function"==typeof t[e]?(...r)=>this.call(t,e,r):Reflect.get(t,e)}}function Q(t,e,r,n,s,i,a){try{var o=t[i](a);var c=o.value}catch(t){return void r(t)}o.done?e(c):Promise.resolve(c).then(n,s)}function X(t){return function(){var e=this,r=arguments;return new Promise((function(n,s){var i=t.apply(e,r);function a(t){Q(i,n,s,a,o,"next",t)}function o(t){Q(i,n,s,a,o,"throw",t)}a(void 0)}))}}function tt(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function et(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function rt(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?et(Object(r),!0).forEach((function(e){tt(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):et(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function nt(t,e){if(null==t)return{};var r={};var n=Object.keys(t);var s,i;for(i=0;i<n.length;i++)s=n[i],e.indexOf(s)>=0||(r[s]=t[s]);return r}function st(t,e){if(null==t)return{};var r=nt(t,e);var n,s;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(s=0;s<i.length;s++)n=i[s],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}function it(t,e){if("object"!=typeof t||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}function at(t){var e=it(t,"string");return"symbol"==typeof e?e:String(e)}var{PublicKey:ot,Signature:ct,Script:ut,Opcode:ht}=e;function pt(t,e){var r=[];var n=0;for(;n<t.length;)r.push(t.slice(n,n+e)),n+=e;return r}class dt extends ut{static outScriptFromData(t){var{_owners:e,_amount:r,__vouts:n,__txId:s}=t,i=st(t,["_owners","_amount","__vouts","__txId"]);var a=pt(Buffer.from(JSON.stringify(i)),l.SCRIPT_CHUNK_SIZE);return a[a.length-1].byteLength>=l.SCRIPT_CHUNK_SIZE&&pt(a.pop(),l.SCRIPT_CHUNK_SIZE).forEach(t=>{a.push(t)}),a.map(t=>({redeemScript:dt.getScript(t,e),chunk:t}))}static getScript(t,e){var r=new dt;return r.add("OP_1"),e.forEach(t=>r.add(t.toBuffer())),r.add("OP_".concat(e.length)),r.add("OP_CHECKMULTISIG"),r.add(t),r.add("OP_DROP"),r}getData(){return this.isDbDataScript()?JSON.parse(this.chunks[this.chunks.length-2].buf.toString()):{}}getPublicKeys(){if(this.isDbDataScript())return this.chunks.slice(1,this.chunks.length-4).map(t=>new ot(t.buf));throw new Error("Cannot get owners from non-data script")}isDbDataScript(){return!!(this.chunks.length>=5&&this.chunks[0].opcodenum===ht.OP_1&&this.chunks[1].buf&&[20,33].includes(this.chunks[1].buf.length)&&this.chunks[this.chunks.length-3].opcodenum===ht.OP_CHECKMULTISIG&&this.chunks[this.chunks.length-2].buf&&this.chunks[this.chunks.length-1].opcodenum===ht.OP_DROP)}static isP2shScript(t){return!(3!==t.chunks.length||t.chunks[0].opcodenum!==ht.OP_0||!t.chunks[1].buf||!t.chunks[2].buf)}static redeemScriptFromP2shScript(t){if(!this.isP2shScript(t))throw new Error("not a p2sh script");var e=new ut(t.chunks[2].buf);var r=new this;return r.chunks=e.chunks,r}static fromScript(t){var e=new ut(t);var r=new dt;return r.chunks=e.chunks,r}}function lt(t){return{writable:!0,value:t}}function vt(t,e,r){var{[t]:n}=r;return rt({[e]:n},st(r,[t].map(at)))}var{Address:ft,Transaction:gt,PublicKey:_t,Script:mt}=e;var wt=new Map;class bt{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l.CHAIN;var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.NETWORK;var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:l.WOC_API_KEY;this.chain=t,this.network=e,"BSV"===t&&(this.wocApiKey=r)}getBaseUrl(){if("BSV"===this.chain){var t="livenet"===this.network?"main":"test";return"https://api.whatsonchain.com/v1/bsv/".concat(t)}var e="livenet"===this.network?"rest":"trest";return"https://".concat(e,".bitcoin.com/v2")}getRequestHeaders(){return"BSV"===this.chain&&this.wocApiKey?{"woc-api-key":this.wocApiKey}:{}}unwrap(t){return X((function*(){try{return(yield t).data}catch(t){var{message:e,config:r,response:n}=t;var{url:s,method:i,data:a}=r;var o;try{o=JSON.parse(a)}catch(t){o=null}var c=o&&o.txhex?new gt(o.txhex):null;throw t.message="Communication Error\n\nmessage\t".concat(e,"\nrequest\t").concat(i," ").concat(s,"\n").concat(c?"transaction\t ".concat(JSON.stringify(c.toJSON(),null,2)):"post"!==i||c?"":"data\t".concat(a),"\n").concat(n?"response\t".concat(JSON.stringify(n.data)):""),t}}))()}get(t){var e=arguments,n=this;return X((function*(){var s=e.length>1&&void 0!==e[1]&&e[1]?"":n.getBaseUrl();return n.unwrap(r.get("".concat(s).concat(t),{headers:n.getRequestHeaders()}))}))()}post(t,e){var n=arguments,s=this;return X((function*(){var i=n.length>2&&void 0!==n[2]&&n[2]?"":s.getBaseUrl();return s.unwrap(r.post("".concat(i).concat(t),e,{headers:s.getRequestHeaders()}))}))()}getBalance(t){var e=this;return X((function*(){var r="/address/".concat(t.toString(),"/balance");var n="/address/details/".concat(t.toString());var s;switch(e.chain){case"BSV":return s=yield e.get(r),parseInt(s.confirmed,10)+parseInt(s.unconfirmed,10);case"BCH":return s=yield e.get(n),parseInt(s.balanceSat,10)+parseInt(s.unconfirmedBalanceSat,10);default:throw new Error("chain is not set in getBalance")}}))()}getTransaction(t){var e=this;return X((function*(){var r=yield e.getRawTransaction(t);return new gt(r)}))()}getTransactionWithSpendingData(t){var e=this;return X((function*(){if("testnet"===e.network&&"BSV"===e.chain)throw new Error("Restclient.getTransactionWithSpendingData is not supported on BSV testnet");switch([t]=t.split(":"),e.chain){case"BSV":var r="https://api.blockchair.com/bitcoin-sv/dashboards/transaction/".concat(t);var{data:n}=yield e.get(r,!0);var{transaction:s,inputs:i,outputs:a}=n[t];return{hex:"",txid:s.hash,hash:s.hash,version:s.version,size:s.size,locktime:s.lock_time,vin:i,vout:a.map(t=>({value:t.value,n:t.index,scriptPubKey:t.script_hex,spentTxId:t.spending_transaction_id,spentIndex:t.spending_index})),blockhash:"unknown",confirmations:"unknown",time:"unknown",blocktime:"unknown"};case"BCH":return e.get("/transaction/details/".concat(t));default:throw new Error("chain is not set in getTransactionWithSpendingData")}}))()}getRawTransaction(t){var e=this;return X((function*(){var[n]=t.split(":");var s=wt.get(n);if(s)return s;var i="livenet"===e.network?"main":"test";var a=yield e.unwrap(r.get("".concat(l.UN_P2SH_URL,"/tx/").concat(e.chain,"/").concat(i,"/").concat(n)));return wt.set(n,a),a}))()}sendTransaction(t){var e=arguments,r=this;return X((function*(){var n=e.length>1&&void 0!==e[1]&&e[1];var s;if("BSV"===r.chain)s=yield r.post("/tx/raw",{txhex:t.toString()});else{if("BCH"!==r.chain)throw new Error("chain is not set in sendTransaction");[s]=yield r.post("/rawtransactions/sendRawTransaction",{hexes:[t.toString()]})}if(n){var i=t.outputData.map(t=>{var{_owners:e}=t;if(void 0!==e){var r=e.map(t=>t.toString());return rt(rt({},t),{_owners:r})}return t});var a=JSON.stringify(i);var o=t.toJSON().inputs.map(t=>{var{prevTxId:e,outputIndex:r}=t;return"".concat(e,":").concat(r)});yield r.postOutputData({txId:s,outputData:a,inputs:o})}return s}))()}getUtxosFromAddress(t){var e=this;return X((function*(){var r=[];var n="";switch(e.chain){case"BSV":return r=yield e.get("/address/".concat(t.toString(),"/unspent")),Promise.all(r.map(t=>{var{tx_hash:e,tx_pos:r,value:n}=t;return{txId:e,vout:r,satoshis:n,amount:n/1e8}}).map(function(){var t=X((function*(t){var r=(yield e.getTransaction(t.txId)).outputs[t.vout];return t.scriptPubKey=r.script.toHex(),t}));return function(e){return t.apply(this,arguments)}}()));case"BCH":return({utxos:r,scriptPubKey:n}=yield e.get("/address/utxo/".concat(t.toString()))),r.map(t=>rt({scriptPubKey:n},t)).map(t=>{var{txid:e}=t;return rt({txId:e},st(t,["txid"]))});default:throw new Error("chain is not set in getUtxosFromAddress")}}))()}getTxosFromOutputData(t){var e=this;return X((function*(){var r=t.map(t=>t.__txId);var n=[...new Set(r)];var s=new Map;return yield Promise.all(n.map(function(){var t=X((function*(t){return s.set(t,yield e.getTransaction(t))}));return function(e){return t.apply(this,arguments)}}())),t.map(t=>{var{outputs:e,blockheight:r,confirmations:n}=s.get(t.__txId)||{};return t.__vouts.map(s=>{var{_scriptBuffer:i,_satoshis:a}=e[s];return{txId:t.__txId,vout:s,scriptPubKey:i.toString("hex"),amount:parseFloat(a/1e8),satoshis:parseInt(a,10),height:r,confirmations:n}})})}))()}postOutputData(t){var e=this;return X((function*(){return e.post("".concat(l.UN_P2SH_URL,"/"),t,!0)}))()}getOutputData(t){var e=this;return X((function*(){return((yield e.get("".concat(l.UN_P2SH_URL,"/un-p2sh/").concat(t),!0))||[]).map(t=>t._owners?rt(rt({},t),{_owners:t._owners.map(t=>new _t(t))}):t)}))()}getOwnedRevs(t){var e=this;return X((function*(){return e.get("".concat(l.UN_P2SH_URL,"/txos/").concat(t.toString()),!0)}))()}getLatestRev(t){var e=this;return X((function*(){var[{rev:r}]=yield e.get("".concat(l.UN_P2SH_URL,"/get-rev/").concat(t),!0);return r}))()}setTxoSpent(t){var e=this;return X((function*(){var[r,n]=t.split(":");return e.post("".concat(l.UN_P2SH_URL,"/txos/set-spent/"),{txId:r,virtualIndex:parseInt(n,10)},!0)}))()}}var{Transaction:yt,PublicKey:Ot,Address:St,BN:xt,Script:It,encoding:jt}=e;var{Output:Pt,Input:Et}=yt;var{MultiSigScriptHash:Tt,PublicKeyHashInput:Ct}=Et;var{BufferReader:kt}=jt;var Dt=t=>new Promise(e=>setTimeout(e,t));class Kt extends yt{constructor(t,e,r){super(r),this._outputData=[],this.restClient=new bt(t,e),this.feePerKb(l.DEFAULT_FEE),Object.defineProperty(this,"to",lt(this._to)),Object.defineProperty(this,"from",lt(this._from))}get chain(){return this.restClient.chain}get network(){return this.restClient.network}static fromRedeemScripts(t){var e=t.map(t=>t.chunks[t.chunks.length-2].buf);var r=Buffer.concat(e);var n=JSON.parse(r.toString());return rt({_owners:t[0].getPublicKeys(),_amount:l.MIN_NON_DUST_AMOUNT},n)}static addVouts(t){var e=0;return t.map(t=>{var r=dt.outScriptFromData(t).length;return t.__vouts=Array(r).fill(e).map((t,e)=>t+e),e+=r,t})}get dataInputs(){var t=[];var e=function*(t){for(var e of t)yield e}(this.inputs);var r=e.next();for(;!r.done;){var n=r.value;var s=dt.fromScript(n._scriptBuffer);if(dt.isP2shScript(s)){var i=!1;var a=[dt.redeemScriptFromP2shScript(s)];for(;!i;)try{t.push(Kt.fromRedeemScripts(a)),i=!0}catch(t){var o=e.next();if(o.done)throw new Error("Could not compute data inputs");var c=o.value;var u=dt.fromScript(c._scriptBuffer);a.push(dt.redeemScriptFromP2shScript(u))}}r=e.next()}return t}set dataInputs(t){throw Error("dataTransaction.dataInputs cannot be set directly, use dataTransaction.from or dataTransaction.fromDataOutput")}getVirtualInputs(){var t=this;return X((function*(){if("BSV"===t.chain)return(yield Promise.all(t.inputs.map(function(){var e=X((function*(e){var{prevTxId:r,outputIndex:n}=e;var s=e.prevTxId.toString("hex");var i=(yield Kt.fromTxId(s,t.chain,t.network)).outputs[n];return!!dt.fromScript(i._scriptBuffer).isDbDataScript()&&e}));return function(t){return e.apply(this,arguments)}}()))).filter(t=>!!t).map(t=>"".concat(t.prevTxId.toString("hex"),":").concat(t.outputIndex));if("BCH"===t.chain){var{dataInputs:e}=t;var r=Kt.addVouts(e);return Promise.all(r.map(function(){var e=X((function*(e){var r=[];e.__vouts.forEach(e=>{r.push(t.inputs[e])});var n=r[0].prevTxId.toString("hex");var s=yield Kt.fromTxId(n,t.chain,t.network);yield s.fetchOutputData();var i=Kt.addVouts(s.outputData);var a=[];i.forEach((t,e)=>{P(t.__vouts,r.map(t=>t.outputIndex))&&a.push(e)});var o=a[0];return"".concat(n,":").concat(o)}));return function(t){return e.apply(this,arguments)}}()))}throw new Error("chain not set in getVirtualInputs")}))()}fromMultiSig(t,e,r){var n=t.map(t=>vt("txId","txid",t));return super.from(n,e,r)}_from(t,e,r){var n=vt("txId","txid",t);return super.from(n,e,r)}fromDataOutput(t,e){var r=dt.outScriptFromData(e);var{_owners:n}=e;return r.forEach((e,r)=>{var{redeemScript:s}=e;var{scriptPubKey:i,satoshis:a,txId:o,vout:c}=t[r];var u=new Pt({script:new dt(i),satoshis:parseInt(a,10)});var h=new dt;var p=new Tt({prevTxId:o,output:u,outputIndex:c,script:h},n,1,null,s);this.addInput(p)}),this}get outputData(){if("BSV"===this.chain)return this.outputs.filter(t=>dt.fromScript(t._scriptBuffer).isDbDataScript()).map(t=>{var{chunks:e}=t._script||t.script;var{buf:r}=e[e.length-2];var n=JSON.parse(r.toString());var s=e.slice(1,e.length-4);return n._owners=s.map(t=>new Ot(t.buf).toString()),n._amount=t._satoshis,n});if("BCH"===this.chain)return this._outputData;throw new Error("Chain not set in dataTransaction get outputdata")}set outputData(t){throw Error("dataTransaction.outputData cannot be set directly")}toData(t){if("BSV"===this.chain){var{_owners:e,_amount:r}=t,n=st(t,["_owners","_amount"]);var s=Buffer.from(JSON.stringify(n));var i=dt.getScript(s,e);var a=new Pt({script:i,satoshis:r});return this.addOutput(a),this.outputs.length-1}if("BCH"===this.chain){var o=dt.outScriptFromData(t);return this._outputData.push(t),o.forEach(e=>{var{redeemScript:r,chunk:n}=e;var s=dt.buildScriptHashOut(r);var i=t._amount;var a=new Pt({script:s,satoshis:i});this.addOutput(a)}),this._outputData.length-1}throw new Error("chain not set in dataScript.toScriptOutput")}_to(t,e){return t&&t._owners&&t._amount&&!e?this.toData(t):super.to(t,e)}fetchOutputData(){var t=this;return X((function*(){if(!t._outputData.length){var e=t.getTxId();"BSV"===t.chain?t._outputData=t.outputs.map(t=>{var e=dt.fromScript(t._scriptBuffer);var r=t._satoshis;if(e.isDbDataScript()){var n=e.getPublicKeys().map(t=>t.toString());return Object.assign(e.getData(),{_amount:r,_owners:n})}if(e.isPublicKeyHashOut()){var s=e.getPublicKeyHash();return{address:St.fromPublicKeyHash(s)}}throw new Error("Unrecognized output script ".concat(e.toString()))}):"BCH"===t.chain&&(t._outputData=yield t.restClient.getOutputData(e))}}))()}get prevObjectIds(){return this.inputs.map(t=>"".concat(t.prevTxId.toString("hex"),":").concat(t.outputIndex))}getTxId(){return new kt(this._getHash()).readReverse().toString("hex")}getChangeIndex(){return this._changeIndex}static fromTxId(t,e,r){return X((function*(){var n=null;var s=new bt(e,r);try{n=yield s.getRawTransaction(t)}catch(e){yield Dt(3e3),n=yield s.getRawTransaction(t)}var i=new Kt(e,r);return i.fromString(n),i}))()}}class Bt{constructor(t,e,r={}){const{path:n="m/44'/0'/0'/0",passphrase:s=""}=r;this.mnemonic=t,this.path=n,this.passphrase=s,this.restClient=e,this.utoxsSyncing=!1,this.hdPrivateKey=this.mnemonic.toHDPrivateKey(this.passphrase,l.NETWORK),this.path&&(this.hdPrivateKey=this.hdPrivateKey.derive(this.path)),this.utxos=[],this.syncUtxos()}get chain(){return this.restClient.chain}get network(){return this.restClient.network}getMnemonic(){return this.mnemonic}getPath(){return this.path}getUtxos(){return this.utxos}derive(t=0,e=!1){const r=new Bt(this.mnemonic,this.restClient);return r.path=`${this.path}${this.path.length?"/":""}${t}${e?"'":""}`,r.hdPrivateKey=this.hdPrivateKey.derive(t,e),r}static getHdPrivateKey(){return new e.HDPrivateKey}getPrivateKey(){return this.hdPrivateKey.privateKey}getPublicKey(){return this.hdPrivateKey.publicKey}getAddress(){return this.address=this.address||this.getPublicKey().toAddress(this.network),this.address}syncUtxos(){return s(this,void 0,void 0,(function*(){this.utoxsSyncing=!0,this.utxos=yield this.restClient.getUtxosFromAddress(this.getAddress()),this.utoxsSyncing=!1}))}waitUntilSynced(){return s(this,void 0,void 0,(function*(){for(;this.utoxsSyncing;)yield new Promise(t=>setTimeout(t,300))}))}getBalance(){return s(this,void 0,void 0,(function*(){const t=this.getAddress();return this.restClient.getBalance(t.toString())}))}getBalanceLowerBounds(){return s(this,void 0,void 0,(function*(){return yield this.waitUntilSynced(),this.utxos.reduce((t,e)=>t+e.satoshis,0)}))}getUtxosToSpend(t){return s(this,void 0,void 0,(function*(){yield this.waitUntilSynced();for(let t=this.utxos.length-1;t>0;t-=1){const e=Math.floor(Math.random()*(t+1));[this.utxos[t],this.utxos[e]]=[this.utxos[e],this.utxos[t]]}return this.getUtxosWithSatoshis(t)}))}getUtxosWithSatoshis(t){let e=0;const r=[];let n=0;for(;e<t&&n<this.utxos.length;)r.push(this.utxos[n]),e+=this.utxos[n].satoshis,n+=1;if(e>=t)return r;throw new Error(`Insufficient balance in address ${this.getAddress().toString()} on ${l.NETWORK} ${l.CHAIN}. Found ${e}, required ${t}.`)}fundAndSendTransaction(t,e=!1){return s(this,void 0,void 0,(function*(){t.feePerKb(l.DEFAULT_FEE);const r=t._estimateFee()+100;const n=yield this.getUtxosToSpend(t._getOutputAmount()-t._getInputAmount()+r);n.forEach(e=>t.from(e)),t.change(this.getAddress()),t.sign(this.getPrivateKey());const s=yield this.restClient.sendTransaction(t,e);this.utxos=this.utxos.filter(t=>!n.includes(t));const i=t.getChangeOutput();return i&&this.utxos.push({txId:t.getTxId(),vout:t.getChangeIndex(),satoshis:i.satoshis,amount:i.satoshis/1e8,scriptPubKey:i.script.toHex()}),s}))}send(t,e){return s(this,void 0,void 0,(function*(){const r=new Kt(this.chain,this.network).to(e,t);return this.fundAndSendTransaction(r)}))}}var{HDPrivateKey:Nt,Mnemonic:Ut,Transaction:At,Script:Rt,PublicKey:Ht}=e;class $t{constructor(t){this.wallet=t}get chain(){return this.wallet.chain}get network(){return this.wallet.network}put(t){var e=this;return X((function*(){return e.update([],t)}))()}getOutputDataMap(t){var e=this;return X((function*(){var r=[...new Set(t)];var n=yield Promise.all(r.map(function(){var t=X((function*(t){var r=yield e.wallet.restClient.getOutputData(t);var n=0;var s=r.map(e=>{var r=dt.outScriptFromData(e).length;var s=Array(r).fill(n).map((t,e)=>t+e);return n+=r,void 0!==e._owners&&(e._owners=e._owners.map(t=>new Ht(t))),rt(rt({},e),{},{__vouts:s,__txId:t})});return[t,s]}));return function(e){return t.apply(this,arguments)}}()));return new Map(n)}))()}get(t){var e=this;return X((function*(){if("BSV"===e.chain){var r=t.map(t=>t.split(":")[0]);var n=[...new Set(r)];var s=yield Promise.all(n.map(function(){var t=X((function*(t){return[t,yield e.wallet.restClient.getTransaction(t)]}));return function(e){return t.apply(this,arguments)}}()));var i=new Map(s);return Promise.all(t.map(function(){var t=X((function*(t){var[e,r]=t.split(":");var n=i.get(e).outputs[parseInt(r,10)];var s=dt.fromScript(n.script);return Object.assign(s.getData(),{__txId:e,__vouts:[parseInt(r,10)],_owners:s.getPublicKeys(),_amount:Math.round(n.satoshis)})}));return function(e){return t.apply(this,arguments)}}()))}if("BCH"===e.chain){var a=t.map(t=>t.split(":")[0]);var o=yield e.getOutputDataMap(a);return t.map(t=>{var[e,r]=t.split(":");var n=o.get(e);if(!n||!Array.isArray(n))throw new Error("No data found.");return n[parseInt(r,10)]})}throw new Error("chain not set in db.get")}))()}getUpdateTxBch(t,e,r){var n=this;return X((function*(){var r=new Kt(n.chain,n.network);var s=yield n.get(t);var i=yield n.wallet.restClient.getTxosFromOutputData(s);t.forEach(function(){var t=X((function*(t,e){r.fromDataOutput(i[e],s[e])}));return function(e,r){return t.apply(this,arguments)}}());var a=K(e,n.wallet.getPublicKey()).map(t=>r.to(t));return{txId:yield n.wallet.fundAndSendTransaction(r,!0),virtualIndices:a}}))()}getUpdateTxBsv(t,e,r){var n=this;return X((function*(){var r=new Kt(n.chain,n.network);(yield Promise.all(t.map(function(){var t=X((function*(t){var[e,r]=t.split(":");var s=yield n.wallet.restClient.getTransaction(e);var{script:i,satoshis:a}=s.outputs[parseInt(r,10)];var o=dt.fromScript(i);return{output:{txId:e,outputIndex:parseInt(r,10),scriptPubKey:o,satoshis:Math.round(a)},publicKeys:o.getPublicKeys(),nr:1}}));return function(e){return t.apply(this,arguments)}}()))).forEach(t=>{var{output:e,publicKeys:n,nr:s}=t;r.from(e,n,s)});var s=K(e,n.wallet.getPublicKey()).map(t=>r.to(t));return{txId:yield n.wallet.fundAndSendTransaction(r,!0),virtualIndices:s}}))()}update(t,e){var r=this;return X((function*(){var n=e.reduce((t,e)=>t+parseInt(e._amount,10),0);if("BSV"===r.chain){var{txId:s,virtualIndices:i}=yield r.getUpdateTxBsv(t,e,n);return yield Promise.all(t.map(function(){var t=X((function*(t){yield r.wallet.restClient.setTxoSpent(t)}));return function(e){return t.apply(this,arguments)}}())),i.map(t=>"".concat(s,":").concat(t))}if("BCH"===r.chain){var{txId:a,virtualIndices:o}=yield r.getUpdateTxBch(t,e,n);return t.forEach(function(){var t=X((function*(t){yield r.wallet.restClient.setTxoSpent(t)}));return function(e){return t.apply(this,arguments)}}()),o.map(t=>"".concat(a,":").concat(t))}throw new Error("Chain not set in db.update ".concat(r.chain))}))()}}var Lt;if("undefined"==typeof window){var{LocalStorage:Mt}=require("node-localstorage");Lt=new Mt("./uls-scratch")}else void 0!==window.localStorage&&({localStorage:Lt}=window);var Ft=Lt;class Vt{static serialize(t){return JSON.stringify(Object.entries(t))}static deserialize(t,e){var r=e?new e:{};return JSON.parse(t).forEach(t=>{var[e,n]=t;return r[e]=n}),r}static set(t){if(void 0===t._rev)throw new Error("Rev not set in Cache.set");var e="Object"===t.constructor.name?JSON.stringify({data:Vt.serialize(t)}):JSON.stringify({data:Vt.serialize(t),clazz:t.constructor.toString()});return Ft.setItem(t._rev,e),t._rev}static get(t){var{data:e,clazz:r}=JSON.parse(Ft.getItem(t||""))||{};if(e){var n="string"==typeof r?eval("(".concat(r,")")):void 0;return this.deserialize(e,n)}return null}}class Wt{constructor(t,e){this.chain=t,this.network=e}get(t){return s(this,void 0,void 0,(function*(){const e=Vt.get(t);if(e)return e;const[r,n]=t.split(":");const i=yield Kt.fromTxId(r,this.chain,this.network);yield i.fetchOutputData();const a=i.outputData;const{__index:o}=a[0];const{__cls:c,__func:u,__args:h}=a[o.obj];const p=yield i.getVirtualInputs();const d=yield Promise.all(Object.values(o).map(t=>s(this,void 0,void 0,(function*(){return p[t]?this.get(p[t]):Promise.resolve({})}))));const l=Object.keys(o).map((t,e)=>[t,d[e]]);const v=Object.fromEntries(l);let f=v.obj;delete v.obj;const g=Object.entries(v).reduce((t,[e,r])=>(Number.isNaN(parseInt(e,10))||(t[parseInt(e,10)]=r),t),[]);const _=G(g,h);let m;if("constructor"===u){const t=eval(`(${c})`);f=new t(..._)}else{const t=f[u].bind(f);m=Reflect.apply(t,f,_)}const b=o;return Object.entries(b).forEach(([t,e])=>{"obj"===t&&B(f,a,e,r),B("res"===t?m:g[t],a,e,r)}),U([f,m,...g]),[f,m,...g].filter(t=>!w(t)).map(Vt.set),[...g,f,m][n]}))}}const{Mnemonic:Jt,PublicKey:zt}=e;class qt{constructor(t){const{seed:e,chain:r=l.CHAIN,network:n=l.NETWORK,mnemonic:s=new Jt(e),wocApiKey:i,path:a="m/44'/0'/0'/0",passphrase:o=""}=t;this.restClient=new bt(r,n,i);const{db:c=new $t(new Bt(s,this.restClient,{path:a,passphrase:o}))}=t;this.db=c,this.reader=new Wt(this.chain,this.network)}get chain(){return this.db.chain}get network(){return this.db.network}static parseContract(t){if("string"==typeof t){const e=t.startsWith("export ")?t.slice(7):t;const r=e.startsWith("default ")?e.slice(8):e;return eval(`(${r})`)}return t}new(t,e){return s(this,void 0,void 0,(function*(){const r=new Y(this.db);const n=qt.parseContract(t);const s=new Proxy(n,r);const i=yield new s(...e);return new Proxy(i,r)}))}sync(t){return s(this,void 0,void 0,(function*(){const e=yield this.reader.get(t);const r=new Y(this.db);return new Proxy(e,r)}))}getOwnedRevs(t=this.db.wallet.getPublicKey()){return s(this,void 0,void 0,(function*(){return this.db.wallet.restClient.getOwnedRevs(t)}))}getRevs(t=this.db.wallet.getPublicKey()){return s(this,void 0,void 0,(function*(){return(yield this.db.wallet.restClient.getOwnedRevs(t)).map(({txId:t,virtualIndex:e})=>`${t}:${e}`)}))}getLatestRev(t){return s(this,void 0,void 0,(function*(){return this.db.wallet.restClient.getLatestRev(t)}))}syncWallet(){return s(this,void 0,void 0,(function*(){this.db.wallet.syncWallet()}))}}module.exports=qt;
