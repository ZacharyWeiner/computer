"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var r=t(require("bitcoinsource"));var e=t(require("axios"));function n(t,r,e,n,a,i,s){try{var o=t[i](s);var u=o.value}catch(t){return void e(t)}o.done?r(u):Promise.resolve(u).then(n,a)}function a(t){return function(){var r=this,e=arguments;return new Promise((function(a,i){var s=t.apply(r,e);function o(t){n(s,a,i,o,u,"next",t)}function u(t){n(s,a,i,o,u,"throw",t)}o(void 0)}))}}function i(t,r,e){return r in t?Object.defineProperty(t,r,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[r]=e,t}function s(t,r){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),e.push.apply(e,n)}return e}function o(t){for(var r=1;r<arguments.length;r++){var e=null!=arguments[r]?arguments[r]:{};r%2?s(Object(e),!0).forEach((function(r){i(t,r,e[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):s(Object(e)).forEach((function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(e,r))}))}return t}function u(t,r){if(null==t)return{};var e={};var n=Object.keys(t);var a,i;for(i=0;i<n.length;i++)a=n[i],r.indexOf(a)>=0||(e[a]=t[a]);return e}function c(t,r){if(null==t)return{};var e=u(t,r);var n,a;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(a=0;a<i.length;a++)n=i[a],r.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(e[n]=t[n])}return e}function v(t,r){if("object"!=typeof t||null===t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,r||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}function p(t){var r=v(t,"string");return"symbol"==typeof r?r:String(r)}var h=process.env.BC_CHAIN||"BSV";var d=process.env.BC_NETWORK||"testnet";var l=process.env.BC_WOC_API_KEY||void 0;var f=!!process.env.BC_LOCAL_BBS||!1;var _=parseInt(process.env.BC_DUST_LIMIT,10)||4e3;var g=parseInt(process.env.BC_DEFAULT_FEE,10)||("BSV"===h?500:2500);var m=parseInt(process.env.BC_SCRIPT_CHUNK_SIZE,10)||479;var w;var y;process.env.BC_BBS_URL?(y="http://".concat(process.env.BC_BBS_URL),w="ws://".concat(process.env.BC_BBS_URL)):(y=f?"http://localhost:3000":"https://bbs.bitcoincomputer.io",w=f?"ws://localhost:3000":"wss://bbs.bitcoincomputer.io");var b={CHAIN:h,NETWORK:d,WOC_API_KEY:l,MIN_NON_DUST_AMOUNT:_,SCRIPT_CHUNK_SIZE:m,UN_P2SH_URL:y,WS_URL:w,DEFAULT_FEE:g};var S=["_id","_rev","_owners","_amount","__vouts","__txId","__cls","__func","__index","_args"];var O=t=>"object"==typeof t?Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1]:Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1].toLowerCase();var x=t=>["undefined","number","string","boolean","Null"].includes(O(t));var I=t=>x(t)||["Array","Object"].includes(O(t));var P=t=>"Object"===O(t)&&Object.keys(t).every(t=>!isNaN(parseInt(t,10)));var T=(t,r)=>{if(!I(t)||!I(r))throw new Error("Unsupported data types for deep equals: ".concat(O(t)," & ").concat(O(r)));return O(t)===O(r)&&(x(t)&&x(r)?t===r:t&&r&&Object.entries(t).every(t=>{var[e,n]=t;return T(r[e],n)})&&Object.entries(r).every(r=>{var[e,n]=r;return T(t[e],n)}))};var j=t=>{if(x(t))return t;if("Array"===O(t))return t.map(j);if("Object"===O(t)){var r=Object.keys(t).reduce((r,e)=>(r[e]=j(t[e]),r),{});var e=Object.create(Object.getPrototypeOf(t));return Object.assign(e,r)}throw new Error("Unsupported data type for clone: ".concat(O(t)))};var C=(t,r)=>t.reduce((t,e,n)=>{var[a,i]=t;return r(e,n)?[[...a,e],i]:[a,[...i,e]]},[[],[]]);var E=(t,r)=>Object.fromEntries(Object.entries(t).map(t=>{var[e,n]=t;return[e,r(n)]}));var k=(t,r)=>Object.fromEntries(Object.entries(t).filter(t=>{var[,e]=t;return r(e)}));var B=t=>x(t)?t:Object.entries(t).reduce((t,r)=>{var[e,n]=r;var a=B(n);return P(a)?Object.entries(a).forEach(r=>{var[n,a]=r;t["".concat(e,"_").concat(n)]=a}):t[e]=a,t},{});var D=0;var K=()=>"__temp__:".concat(D++);var N=t=>{if("Array"===O(t))t.map(N);else if("Object"===O(t)){var r=K();t._id=t._id||r,t._rev=t._rev||r,Object.values(t).map(N)}};var A=(t,r,e)=>{if(!x(t)){var n=r.findIndex(r=>r===t._rev);-1!==n&&(t._rev="".concat(e,":").concat(n)),"Array"===O(t)?t.map(t=>A(t,r,e)):"Object"===O(t)&&Object.values(t).map(t=>A(t,r,e))}};var U=(t,r)=>{if(!x(t)&&"undefined"!==O(r)){if(t._rev===r)return t;if("Array"===O(t))return t.find(t=>U(t,r));if("Object"===O(t))return Object.values(t).find(t=>U(t,r));throw new Error("Unsupported type ".concat(O(t)," in findByRev"))}};var R=(t,r)=>{if("Array"===O(t))return t.map(t=>R(t,r));if("Object"===O(t)){var e=Object.entries(t).reduce((t,e)=>{var[n,a]=e;var i=S.includes(n)?a:R(a,r);return o(o({},t),{[n]:i})},{});var n=void 0!==t._amount?t._amount:b.MIN_NON_DUST_AMOUNT;var a=void 0!==t._owners?t._owners:[r];return o(o({},e),{_amount:n,_owners:a})}return t};var H=t=>{"Array"===O(t)?t.map(H):"Object"===O(t)&&(void 0!==t._owners&&(t._owners=JSON.stringify(t._owners)),Object.values(t).map(H))};var F=t=>{"Array"===O(t)?t.map(F):"Object"===O(t)&&(void 0!==t._owners&&(t._owners=JSON.parse(t._owners)),Object.values(t).map(F))};var M=t=>{var r={[t._id]:Object.entries(t).reduce((t,r)=>{var[e,n]=r;return S.includes(e)?o(o({},t),{[e]:n}):x(n)?o(o({},t),{["__basic__".concat(e)]:n}):o(o({},t),{[e]:n._id})},{})};return Object.values(t).filter(t=>!x(t)).reduce((t,r)=>o(o({},t),M(r)),r)};var L=(t,r)=>(t[r].__contains=Object.entries(t[r]).reduce((r,e)=>{var[n,a]=e;return["__contains"].concat(S).includes(n)?r:"__change"===n?"new"===a||"diff"===a||r:L(t,a)[a].__contains||r},!1),t);var V=(t,r)=>Object.fromEntries(Object.entries(r).map(r=>{var[e,n]=r;var a=t[e];var i;return n.__change=(i=a)?T(i,n)?"same":"diff":"new",[e,n]}));var W=t=>Object.fromEntries(Object.entries(t).filter(t=>{var[r]=t;return!r.startsWith("__basic__")}));var J=t=>t.reduce((t,r,e)=>o(o({},t),{[r._id]:e}),{});var z=(t,r)=>t.map(t=>Object.entries(t).reduce((t,e)=>{var[n,a]=e;var i="undefined"!==O(r[a])?r[a]:a;return o(o({},t),{[n]:i})},{}));var q=(t,r)=>{N(r);var e=r._id;var n=j(t);var a=j(r);H(n),H(a);var i=B(n);var s=B(a);var u=M(i);var c=M(s);var v=V(u,c);var p=E(v,W);var h=L(p,e);var{index:d}=h;delete h.index;var l=E(h,t=>t._rev);var f=k(h,t=>t.__contains||Object.values(d).includes(t._id));var _=Object.values(f);var[g,m]=C(_,t=>"new"===t.__change);var w=[...m,...g];var y=J(w);var b=z(w,y);var[S]=z([d],y);var O=m.map(t=>t._rev);b.concat([S]).forEach(t=>{delete t._id,delete t._rev,delete t.__change,delete t.__contains});var x=b.map(t=>Object.entries(t).reduce((t,r)=>{var[e,n]=r;return o(o({},t),{[e]:l[n]||n})},{}));return F(x),[O,x,S]};var Z=t=>({smartArgs:t.filter(t=>t._rev),dumbArgs:t.map(t=>t._rev?"__":t)});var G=(t,r)=>r.map(r=>"__"===r?t.shift():r);class Y{constructor(t){this.db=t}construct(t,r){var e=this;return a((function*(){return a((function*(){var[n,a]=j([r,{}]);var i=new t(...r);var{smartArgs:s,dumbArgs:u}=Z(n);var{smartArgs:c}=Z(r);var v=o(o(o({},s),{obj:a}),{},{_id:"index"});var p=o(o(o({},c),{obj:i}),{},{_id:"index"});var[h,d,l]=q(v,p);void 0!==d[0]&&(d[0].__func="constructor",d[0]._args=u,d[0].__index=l,d[0].__cls=t.toString());var f=yield e.db.update(h,d);var _=f[0].split(":")[0];A([...c,i],h,_);var g=f[c.length];return i._rev=g,i._id=g,i}))()}))()}call(t,r,e){var n=this;return a((function*(){var[a,i]=j([e,t]);var s=Reflect.apply(t[r],t,e);var{smartArgs:u,dumbArgs:c}=Z(a);var{smartArgs:v}=Z(e);var p=o(o(o({},u),{obj:i}),{},{_id:"index"});var h=o(o(o({},v),{obj:t}),{},{_id:"index"});"object"===O(s)&&(h.res=s);var[d,l,f]=q(p,h);void 0!==l[0]&&(l[0].__func=r,l[0]._args=c,l[0].__index=f);var _=yield n.db.update(d,l);var g="object"===O(s)?[...v,t,s]:[...v,t];var m=_[0].split(":")[0];A(g,d,m);var w=_[v.length];return"Object"===O(s)&&(s._rev=w,s._id=w),s}))()}get(t,r){var e=this;return"function"==typeof t[r]?function(){for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return e.call(t,r,a)}:Reflect.get(t,r)}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function Q(t,r,e,n){return new(e||(e=Promise))((function(a,i){function s(t){try{u(n.next(t))}catch(t){i(t)}}function o(t){try{u(n.throw(t))}catch(t){i(t)}}function u(t){var r;t.done?a(t.value):(r=t.value,r instanceof e?r:new e((function(t){t(r)}))).then(s,o)}u((n=n.apply(t,r||[])).next())}))}function X(t,r){var e,n,a,i,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(i){return function(o){return function(i){if(e)throw new TypeError("Generator is already executing.");for(;s;)try{if(e=1,n&&(a=2&i[0]?n.return:i[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,i[1])).done)return a;switch(n=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!((a=(a=s.trys).length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){s.label=i[1];break}if(6===i[0]&&s.label<a[1]){s.label=a[1],a=i;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(i);break}a[2]&&s.ops.pop(),s.trys.pop();continue}i=r.call(t,s)}catch(t){i=[6,t],n=0}finally{e=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,o])}}}r.versionGuard=function(){return!0},r.Networks.defaultNetwork=r.Networks[b.NETWORK];var $=function(){function t(t,r,e){void 0===e&&(e={});var n=e.path,a=void 0===n?"m/44'/0'/0'/0":n,i=e.passphrase,s=void 0===i?"":i;this.mnemonic=t,this.path=a,this.passphrase=s,this.restClient=r,this.utoxsSyncing=!1,this.hdPrivateKey=this.mnemonic.toHDPrivateKey(this.passphrase,b.NETWORK),this.path&&(this.hdPrivateKey=this.hdPrivateKey.derive(this.path)),this.utxos=[],this.syncUtxos()}return Object.defineProperty(t.prototype,"chain",{get:function(){return this.restClient.chain},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"network",{get:function(){return this.restClient.network},enumerable:!1,configurable:!0}),t.prototype.getMnemonic=function(){return this.mnemonic},t.prototype.getPath=function(){return this.path},t.prototype.getUtxos=function(){return this.utxos},t.prototype.derive=function(r,e){void 0===r&&(r=0),void 0===e&&(e=!1);var n=new t(this.mnemonic,this.restClient);return n.path=this.path+(this.path.length?"/":"")+r+(e?"'":""),n.hdPrivateKey=this.hdPrivateKey.derive(r,e),n},t.getHdPrivateKey=function(){return new r.HDPrivateKey},t.prototype.getPrivateKey=function(){return this.hdPrivateKey.privateKey},t.prototype.getPublicKey=function(){return this.hdPrivateKey.publicKey},t.prototype.getAddress=function(){return this.address=this.address||this.getPublicKey().toAddress(this.network),this.address},t.prototype.syncUtxos=function(){return Q(this,void 0,void 0,(function(){var t;return X(this,(function(r){switch(r.label){case 0:return this.utoxsSyncing=!0,t=this,[4,this.restClient.getUtxosFromAddress(this.getAddress())];case 1:return t.utxos=r.sent(),this.utoxsSyncing=!1,[2]}}))}))},t.prototype.waitUntilSynced=function(){return Q(this,void 0,void 0,(function(){return X(this,(function(t){switch(t.label){case 0:return this.utoxsSyncing?[4,new Promise((function(t){return setTimeout(t,300)}))]:[3,2];case 1:return t.sent(),[3,0];case 2:return[2]}}))}))},t.prototype.getBalance=function(){return Q(this,void 0,void 0,(function(){var t;return X(this,(function(r){return t=this.getAddress(),[2,this.restClient.getBalance(t.toString())]}))}))},t.prototype.getBalanceLowerBounds=function(){return Q(this,void 0,void 0,(function(){return X(this,(function(t){switch(t.label){case 0:return[4,this.waitUntilSynced()];case 1:return t.sent(),[2,this.utxos.reduce((function(t,r){return t+r.satoshis}),0)]}}))}))},t.prototype.getUtxosToSpend=function(t){return Q(this,void 0,void 0,(function(){var r,e,n,a,i;var s;return X(this,(function(o){switch(o.label){case 0:return[4,this.waitUntilSynced()];case 1:for(o.sent(),r=this.utxos.length-1;r>0;r-=1)e=Math.floor(Math.random()*(r+1)),s=[this.utxos[e],this.utxos[r]],this.utxos[r]=s[0],this.utxos[e]=s[1];for(n=0,a=[],i=0;n<t&&i<this.utxos.length;)a.push(this.utxos[i]),n+=this.utxos[i].satoshis,i+=1;if(n>=t)return[2,a];throw new Error("Insufficient balance in address "+this.getAddress().toString()+" on "+b.NETWORK+" "+b.CHAIN+". Found "+n+", required "+t+".")}}))}))},t.prototype.fundAndSendTransaction=function(t,r){return void 0===r&&(r=!1),Q(this,void 0,void 0,(function(){var e,n,a;return X(this,(function(i){switch(i.label){case 0:return t.feePerKb(b.DEFAULT_FEE),e=t._estimateFee()+100,[4,this.getUtxosToSpend(t._getOutputAmount()-t._getInputAmount()+e)];case 1:return(n=i.sent()).forEach((function(r){return t.from(r)})),t.change(this.getAddress()),t.sign(this.getPrivateKey()),[4,this.restClient.sendTransaction(t,r)];case 2:return i.sent(),this.utxos=this.utxos.filter((function(t){return!n.includes(t)})),(a=t.getChangeOutput())&&this.utxos.push({txId:t.getTxId(),vout:t.getChangeIndex(),satoshis:a.satoshis,amount:a.satoshis/1e8,scriptPubKey:a.script.toHex()}),[2,t]}}))}))},t}();var{PublicKey:tt,Signature:rt,Script:et,Opcode:nt}=r;function at(t,r){var e=[];var n=0;for(;n<t.length;)e.push(t.slice(n,n+r)),n+=r;return e}class it extends et{static outScriptFromData(t){var{_owners:r,_amount:e,__vouts:n,__txId:a}=t,i=c(t,["_owners","_amount","__vouts","__txId"]);var s=at(Buffer.from(JSON.stringify(i)),b.SCRIPT_CHUNK_SIZE);return s[s.length-1].byteLength>=b.SCRIPT_CHUNK_SIZE&&at(s.pop(),b.SCRIPT_CHUNK_SIZE).forEach(t=>{s.push(t)}),s.map(t=>({redeemScript:it.getScript(t,r),chunk:t}))}static getScript(t,r){var e=new it;return e.add("OP_1"),r.forEach(t=>e.add(t.toBuffer())),e.add("OP_".concat(r.length)),e.add("OP_CHECKMULTISIG"),e.add(t),e.add("OP_DROP"),e}getData(){return this.isDbDataScript()?JSON.parse(this.chunks[this.chunks.length-2].buf.toString()):{}}getPublicKeys(){if(this.isDbDataScript())return this.chunks.slice(1,this.chunks.length-4).map(t=>new tt(t.buf));throw new Error("Cannot get owners from non-data script")}isDbDataScript(){return!!(this.chunks.length>=5&&this.chunks[0].opcodenum===nt.OP_1&&this.chunks[1].buf&&[20,33].includes(this.chunks[1].buf.length)&&this.chunks[this.chunks.length-3].opcodenum===nt.OP_CHECKMULTISIG&&this.chunks[this.chunks.length-2].buf&&this.chunks[this.chunks.length-1].opcodenum===nt.OP_DROP)}static isP2shScript(t){return!(3!==t.chunks.length||t.chunks[0].opcodenum!==nt.OP_0||!t.chunks[1].buf||!t.chunks[2].buf)}static redeemScriptFromP2shScript(t){if(!this.isP2shScript(t))throw new Error("not a p2sh script");var r=new et(t.chunks[2].buf);var e=new this;return e.chunks=r.chunks,e}static fromScript(t){var r=new et(t);var e=new it;return e.chunks=r.chunks,e}}function st(t){return{writable:!0,value:t}}function ot(t,r,e){var{[t]:n}=e;return o({[r]:n},c(e,[t].map(p)))}var{Address:ut,Transaction:ct,PublicKey:vt,Script:pt}=r;var ht=new Map;class dt{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:b.CHAIN;var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:b.NETWORK;var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:b.WOC_API_KEY;this.chain=t,this.network=r,"BSV"===t&&(this.wocApiKey=e)}getBaseUrl(){if("BSV"===this.chain){var t="livenet"===this.network?"main":"test";return"https://api.whatsonchain.com/v1/bsv/".concat(t)}var r="livenet"===this.network?"rest":"trest";return"https://".concat(r,".bitcoin.com/v2")}getRequestHeaders(){return"BSV"===this.chain&&this.wocApiKey?{"woc-api-key":this.wocApiKey}:{}}unwrap(t){return a((function*(){try{return(yield t).data}catch(t){var{message:r,config:e,response:n}=t;var{url:a,method:i,data:s}=e;var o;try{o=JSON.parse(s)}catch(t){o=null}var u=o&&o.txhex?new ct(o.txhex):null;throw t.message="Communication Error\n\nmessage\t".concat(r,"\nrequest\t").concat(i," ").concat(a,"\n").concat(u?"transaction\t ".concat(JSON.stringify(u.toJSON(),null,2)):"post"!==i||u?"":"data\t".concat(s),"\n").concat(n?"response\t".concat(JSON.stringify(n.data)):""),t}}))()}get(t){var r=arguments,n=this;return a((function*(){var a=r.length>1&&void 0!==r[1]&&r[1]?"":n.getBaseUrl();return n.unwrap(e.get("".concat(a).concat(t),{headers:n.getRequestHeaders()}))}))()}post(t,r){var n=arguments,i=this;return a((function*(){var a=n.length>2&&void 0!==n[2]&&n[2]?"":i.getBaseUrl();return i.unwrap(e.post("".concat(a).concat(t),r,{headers:i.getRequestHeaders()}))}))()}getBalance(t){var r=this;return a((function*(){var e="/address/".concat(t.toString(),"/balance");var n="/address/details/".concat(t.toString());var a;switch(r.chain){case"BSV":return a=yield r.get(e),parseInt(a.confirmed,10)+parseInt(a.unconfirmed,10);case"BCH":return a=yield r.get(n),parseInt(a.balanceSat,10)+parseInt(a.unconfirmedBalanceSat,10);default:throw new Error("chain is not set in getBalance")}}))()}getTransaction(t){var r=this;return a((function*(){var e=yield r.getRawTransaction(t);return new ct(e)}))()}getTransactionWithSpendingData(t){var r=this;return a((function*(){if("testnet"===r.network&&"BSV"===r.chain)throw new Error("Restclient.getTransactionWithSpendingData is not supported on BSV testnet");switch([t]=t.split(":"),r.chain){case"BSV":var e="https://api.blockchair.com/bitcoin-sv/dashboards/transaction/".concat(t);var{data:n}=yield r.get(e,!0);var{transaction:a,inputs:i,outputs:s}=n[t];return{hex:"",txid:a.hash,hash:a.hash,version:a.version,size:a.size,locktime:a.lock_time,vin:i,vout:s.map(t=>({value:t.value,n:t.index,scriptPubKey:t.script_hex,spentTxId:t.spending_transaction_id,spentIndex:t.spending_index})),blockhash:"unknown",confirmations:"unknown",time:"unknown",blocktime:"unknown"};case"BCH":return r.get("/transaction/details/".concat(t));default:throw new Error("chain is not set in getTransactionWithSpendingData")}}))()}getRawTransaction(t){var r=this;return a((function*(){[t]=t.split(":");var n=ht.get(t);if(n)return n;var a="livenet"===r.network?"main":"test";var i=yield r.unwrap(e.get("".concat(b.UN_P2SH_URL,"/tx/").concat(r.chain,"/").concat(a,"/").concat(t)));return ht.set(t,i),i}))()}sendTransaction(t){var r=arguments,e=this;return a((function*(){var n=r.length>1&&void 0!==r[1]&&r[1];var a;if("BSV"===e.chain)a=yield e.post("/tx/raw",{txhex:t.toString()});else{if("BCH"!==e.chain)throw new Error("chain is not set in sendTransaction");[a]=yield e.post("/rawtransactions/sendRawTransaction",{hexes:[t.toString()]})}if(n){var i=t.outputData.map(t=>{var{_owners:r}=t;if(void 0!==r){var e=r.map(t=>t.toString());return o(o({},t),{_owners:e})}return t});var s=JSON.stringify(i);var u=t.toJSON().inputs.map(t=>{var{prevTxId:r,outputIndex:e}=t;return{txId:r,outputIndex:e}});yield e.postOutputData({txId:a,outputData:s,inputs:u})}return a}))()}getUtxosFromAddress(t){var r=this;return a((function*(){var e=[];var n="";switch(r.chain){case"BSV":return e=yield r.get("/address/".concat(t.toString(),"/unspent")),Promise.all(e.map(t=>{var{tx_hash:r,tx_pos:e,value:n}=t;return{txId:r,vout:e,satoshis:n,amount:n/1e8}}).map(function(){var t=a((function*(t){var e=(yield r.getTransaction(t.txId)).outputs[t.vout];return t.scriptPubKey=e.script.toHex(),t}));return function(r){return t.apply(this,arguments)}}()));case"BCH":return({utxos:e,scriptPubKey:n}=yield r.get("/address/utxo/".concat(t.toString()))),e.map(t=>o({scriptPubKey:n},t)).map(t=>{var{txid:r}=t;return o({txId:r},c(t,["txid"]))});default:throw new Error("chain is not set in getUtxosFromAddress")}}))()}getTxosFromOutputData(t){var r=this;return a((function*(){var e=t.map(t=>t.__txId);var n=[...new Set(e)];var i=new Map;return yield Promise.all(n.map(function(){var t=a((function*(t){return i.set(t,yield r.getTransaction(t))}));return function(r){return t.apply(this,arguments)}}())),t.map(t=>{var{outputs:r,blockheight:e,confirmations:n}=i.get(t.__txId)||{};return t.__vouts.map(a=>{var{_scriptBuffer:i,_satoshis:s}=r[a];return{txId:t.__txId,vout:a,scriptPubKey:i.toString("hex"),amount:parseFloat(s/1e8),satoshis:parseInt(s,10),height:e,confirmations:n}})})}))()}postOutputData(t){var r=this;return a((function*(){return r.post("".concat(b.UN_P2SH_URL,"/"),t,!0)}))()}getOutputData(t){var r=this;return a((function*(){return((yield r.get("".concat(b.UN_P2SH_URL,"/un-p2sh/").concat(t),!0))||[]).map(t=>t._owners?o(o({},t),{_owners:t._owners.map(t=>new vt(t))}):t)}))()}getOwnedRevs(t){var r=this;return a((function*(){return r.get("".concat(b.UN_P2SH_URL,"/txos/").concat(t.toString()),!0)}))()}setTxoSpent(t){var r=this;return a((function*(){var[e,n]=t.split(":");return r.post("".concat(b.UN_P2SH_URL,"/txos/set-spent/"),{txId:e,virtualIndex:parseInt(n,10)},!0)}))()}}var{Transaction:lt,PublicKey:ft,Address:_t,BN:gt,Script:mt,encoding:wt}=r;var{Output:yt,Input:bt}=lt;var{MultiSigScriptHash:St,PublicKeyHashInput:Ot}=bt;var{BufferReader:xt}=wt;var It=t=>new Promise(r=>setTimeout(r,t));class Pt extends lt{constructor(t,r,e){super(e),this._outputData=[],this.restClient=new dt(t,r),this.feePerKb(b.DEFAULT_FEE),Object.defineProperty(this,"to",st(this._to)),Object.defineProperty(this,"from",st(this._from))}get chain(){return this.restClient.chain}get network(){return this.restClient.network}static fromRedeemScripts(t){var r=t.map(t=>t.chunks[t.chunks.length-2].buf);var e=Buffer.concat(r);var n=JSON.parse(e.toString());return o({_owners:t[0].getPublicKeys(),_amount:b.MIN_NON_DUST_AMOUNT},n)}static addVouts(t){var r=0;return t.map(t=>{var e=it.outScriptFromData(t).length;return t.__vouts=Array(e).fill(r).map((t,r)=>t+r),r+=e,t})}get dataInputs(){var t=[];var r=function*(t){for(var r of t)yield r}(this.inputs);var e=r.next();for(;!e.done;){var n=e.value;var a=it.fromScript(n._scriptBuffer);if(it.isP2shScript(a)){var i=!1;var s=[it.redeemScriptFromP2shScript(a)];for(;!i;)try{t.push(Pt.fromRedeemScripts(s)),i=!0}catch(t){var o=r.next();if(o.done)throw new Error("Could not compute data inputs");var u=o.value;var c=it.fromScript(u._scriptBuffer);s.push(it.redeemScriptFromP2shScript(c))}}e=r.next()}return t}set dataInputs(t){throw Error("dataTransaction.dataInputs cannot be set directly, use dataTransaction.from or dataTransaction.fromDataOutput")}getVirtualInputs(){var t=this;return a((function*(){if("BSV"===t.chain)return(yield Promise.all(t.inputs.map(function(){var r=a((function*(r){var{prevTxId:e,outputIndex:n}=r;var a=r.prevTxId.toString("hex");var i=(yield Pt.fromTxId(a,t.chain,t.network)).outputs[n];return!!it.fromScript(i._scriptBuffer).isDbDataScript()&&r}));return function(t){return r.apply(this,arguments)}}()))).filter(t=>!!t).map(t=>"".concat(t.prevTxId.toString("hex"),":").concat(t.outputIndex));if("BCH"===t.chain){var{dataInputs:r}=t;var e=Pt.addVouts(r);return Promise.all(e.map(function(){var r=a((function*(r){var e=[];r.__vouts.forEach(r=>{e.push(t.inputs[r])});var n=e[0].prevTxId.toString("hex");var a=yield Pt.fromTxId(n,t.chain,t.network);yield a.fetchOutputData();var i=Pt.addVouts(a.outputData);var s=[];i.forEach((t,r)=>{T(t.__vouts,e.map(t=>t.outputIndex))&&s.push(r)});var o=s[0];return"".concat(n,":").concat(o)}));return function(t){return r.apply(this,arguments)}}()))}throw new Error("chain not set in getVirtualInputs")}))()}fromMultiSig(t,r,e){var n=t.map(t=>ot("txId","txid",t));return super.from(n,r,e)}_from(t,r,e){var n=ot("txId","txid",t);return super.from(n,r,e)}fromDataOutput(t,r){var e=it.outScriptFromData(r);var{_owners:n}=r;return e.forEach((r,e)=>{var{redeemScript:a}=r;var{scriptPubKey:i,satoshis:s,txId:o,vout:u}=t[e];var c=new yt({script:new it(i),satoshis:parseInt(s,10)});var v=new it;var p=new St({prevTxId:o,output:c,outputIndex:u,script:v},n,1,null,a);this.addInput(p)}),this}get outputData(){if("BSV"===this.chain)return this.outputs.filter(t=>it.fromScript(t._scriptBuffer).isDbDataScript()).map(t=>{var{chunks:r}=t._script||t.script;var{buf:e}=r[r.length-2];var n=JSON.parse(e.toString());var a=r.slice(1,r.length-4);return n._owners=a.map(t=>new ft(t.buf).toString()),n._amount=t._satoshis,n});if("BCH"===this.chain)return this._outputData;throw new Error("Chain not set in dataTransaction get outputdata")}set outputData(t){throw Error("dataTransaction.outputData cannot be set directly")}toData(t){if("BSV"===this.chain){var{_owners:r,_amount:e}=t,n=c(t,["_owners","_amount"]);var a=Buffer.from(JSON.stringify(n));var i=it.getScript(a,r);var s=new yt({script:i,satoshis:e});return this.addOutput(s),this.outputs.length-1}if("BCH"===this.chain){var o=it.outScriptFromData(t);return this._outputData.push(t),o.forEach(r=>{var{redeemScript:e,chunk:n}=r;var a=it.buildScriptHashOut(e);var i=t._amount;var s=new yt({script:a,satoshis:i});this.addOutput(s)}),this._outputData.length-1}throw new Error("chain not set in dataScript.toScriptOutput")}_to(t,r){return t&&t._owners&&t._amount&&!r?this.toData(t):super.to(t,r)}fetchOutputData(){var t=this;return a((function*(){if(!t._outputData.length){var r=t.getTxId();"BSV"===t.chain?t._outputData=t.outputs.map(t=>{var r=it.fromScript(t._scriptBuffer);var e=t._satoshis;if(r.isDbDataScript()){var n=r.getPublicKeys().map(t=>t.toString());return Object.assign(r.getData(),{_amount:e,_owners:n})}if(r.isPublicKeyHashOut()){var a=r.getPublicKeyHash();return{address:_t.fromPublicKeyHash(a)}}throw new Error("Unrecognized output script ".concat(r.toString()))}):"BCH"===t.chain&&(t._outputData=yield t.restClient.getOutputData(r))}}))()}get prevObjectIds(){return this.inputs.map(t=>"".concat(t.prevTxId.toString("hex"),":").concat(t.outputIndex))}getTxId(){return new xt(this._getHash()).readReverse().toString("hex")}getChangeIndex(){return this._changeIndex}static fromTxId(t,r,e){return a((function*(){var n=null;var a=new dt(r,e);try{n=yield a.getRawTransaction(t)}catch(r){yield It(3e3),n=yield a.getRawTransaction(t)}var i=new Pt(r,e);return i.fromString(n),i}))()}}var{HDPrivateKey:Tt,Mnemonic:jt,Transaction:Ct,Script:Et,PublicKey:kt}=r;class Bt{constructor(t){this.wallet=t}get chain(){return this.wallet.chain}get network(){return this.wallet.network}put(t){var r=this;return a((function*(){return r.update([],t)}))()}getOutputDataMap(t){var r=this;return a((function*(){var e=[...new Set(t)];var n=yield Promise.all(e.map(function(){var t=a((function*(t){var e=yield r.wallet.restClient.getOutputData(t);var n=0;var a=e.map(r=>{var e=it.outScriptFromData(r).length;var a=Array(e).fill(n).map((t,r)=>t+r);return n+=e,void 0!==r._owners&&(r._owners=r._owners.map(t=>new kt(t))),o(o({},r),{},{__vouts:a,__txId:t})});return[t,a]}));return function(r){return t.apply(this,arguments)}}()));return new Map(n)}))()}get(t){var r=this;return a((function*(){if("BSV"===r.chain){var e=t.map(t=>t.split(":")[0]);var n=[...new Set(e)];var i=yield Promise.all(n.map(function(){var t=a((function*(t){return[t,yield r.wallet.restClient.getTransaction(t)]}));return function(r){return t.apply(this,arguments)}}()));var s=new Map(i);return Promise.all(t.map(function(){var t=a((function*(t){var[r,e]=t.split(":");var n=s.get(r).outputs[parseInt(e,10)];var a=it.fromScript(n.script);return Object.assign(a.getData(),{__txId:r,__vouts:[parseInt(e,10)],_owners:a.getPublicKeys(),_amount:Math.round(n.satoshis)})}));return function(r){return t.apply(this,arguments)}}()))}if("BCH"===r.chain){var o=t.map(t=>t.split(":")[0]);var u=yield r.getOutputDataMap(o);return t.map(t=>{var[r,e]=t.split(":");var n=u.get(r);if(!n||!Array.isArray(n))throw new Error("No data found.");return n[parseInt(e,10)]})}throw new Error("chain not set in db.get")}))()}getUpdateTxBch(t,r,e){var n=this;return a((function*(){var e=new Pt(n.chain,n.network);var i=yield n.get(t);var s=yield n.wallet.restClient.getTxosFromOutputData(i);t.forEach(function(){var t=a((function*(t,r){e.fromDataOutput(s[r],i[r])}));return function(r,e){return t.apply(this,arguments)}}());var o=R(r,n.wallet.getPublicKey()).map(t=>e.to(t));return{transaction:e=yield n.wallet.fundAndSendTransaction(e,!0),virtualIndices:o}}))()}getUpdateTxBsv(t,r,e){var n=this;return a((function*(){var e=new Pt(n.chain,n.network);(yield Promise.all(t.map(function(){var t=a((function*(t){var[r,e]=t.split(":");var a=yield n.wallet.restClient.getTransaction(r);var{script:i,satoshis:s}=a.outputs[parseInt(e,10)];var o=it.fromScript(i);return{output:{txId:r,outputIndex:parseInt(e,10),scriptPubKey:o,satoshis:Math.round(s)},publicKeys:o.getPublicKeys(),nr:1}}));return function(r){return t.apply(this,arguments)}}()))).forEach(t=>{var{output:r,publicKeys:n,nr:a}=t;e.from(r,n,a)});var i=R(r,n.wallet.getPublicKey()).map(t=>e.to(t));return e=yield n.wallet.fundAndSendTransaction(e,!0),yield e.fetchOutputData(),{transaction:e,virtualIndices:i}}))()}update(t,r){var e=this;return a((function*(){var n=r.reduce((t,r)=>t+parseInt(r._amount,10),0);if("BSV"===e.chain){var{transaction:i,virtualIndices:s}=yield e.getUpdateTxBsv(t,r,n);return yield Promise.all(t.map(function(){var t=a((function*(t){yield e.wallet.restClient.setTxoSpent(t)}));return function(r){return t.apply(this,arguments)}}())),s.map(t=>"".concat(i.getTxId(),":").concat(t))}if("BCH"===e.chain){var{transaction:o,virtualIndices:u}=yield e.getUpdateTxBch(t,r,n);return t.forEach(function(){var t=a((function*(t){yield e.wallet.restClient.setTxoSpent(t)}));return function(r){return t.apply(this,arguments)}}()),u.map(t=>"".concat(o.getTxId(),":").concat(t))}throw new Error("Chain not set in db.update ".concat(e.chain))}))()}}var Dt;if("undefined"==typeof window){var{LocalStorage:Kt}=require("node-localstorage");Dt=new Kt("./uls-scratch")}else void 0!==window.localStorage&&({localStorage:Dt}=window);var Nt=Dt;class At{static serialize(t){return JSON.stringify(Object.entries(t))}static deserialize(t,r){var e=r?new r:{};return JSON.parse(t).forEach(t=>{var[r,n]=t;return e[r]=n}),e}static set(t){if(void 0===t._rev)throw new Error("Rev not set in Cache.set");var r="Object"===t.constructor.name?JSON.stringify({data:this.serialize(t)}):JSON.stringify({data:this.serialize(t),clazz:t.constructor.toString()});return Nt.setItem(t._rev,r),t._rev}static get(t){var{data:r,clazz:e}=JSON.parse(Nt.getItem(t||""))||{};if(r){var n="string"==typeof e?eval("(".concat(e,")")):void 0;return this.deserialize(r,n)}return null}}class Ut{constructor(t,r){this.chain=t,this.network=r}get(t){var r=this;return a((function*(){var e=At.get(t);if(e)return e;var[n]=t.split(":");var i=yield Pt.fromTxId(n,r.chain,r.network);yield i.fetchOutputData();var[{__cls:s,__func:o,_args:u,__index:c}]=i.outputData;var v=yield i.getVirtualInputs();var p=Object.fromEntries(yield Promise.all(Object.entries(c).map(function(){var t=a((function*(t){var[e,n]=t;return[e,v[n]?yield r.get(v[n]):{}]}));return function(r){return t.apply(this,arguments)}}())));var h=p.obj;delete p.obj;var d=Object.entries(p).reduce((t,r)=>{var[e,n]=r;return Number.isNaN(parseInt(e,10))||(t[parseInt(e,10)]=n),t},[]);var l=G(d,u);var f;if("constructor"===o){var _=eval("(".concat(s,")"));h=new _(...l)}else{var g=h[o].bind(h);f=Reflect.apply(g,h,l)}if("Object"!==O(h))return h;A([...l,h,f],v,n);var m=U([...l,h,f],t);return m?(At.set(m),m):(h._id=t,h._rev=t,At.set(h),h)}))()}}var{Mnemonic:Rt,PublicKey:Ht}=r;class Ft{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};var{seed:r,chain:e=b.CHAIN,network:n=b.NETWORK,mnemonic:a=new Rt(r),wocApiKey:i,path:s="m/44'/0'/0'/0",passphrase:o=""}=t;this.restClient=new dt(e,n,i);var{db:u=new Bt(new $(a,this.restClient,{path:s,passphrase:o}))}=t;this.db=u,this.reader=new Ut(this.chain,this.network)}get chain(){return this.db.chain}get network(){return this.db.network}static parseContract(t){return"string"===O(t)&&(t=t.startsWith("export ")?t.slice(7):t,t=t.startsWith("default ")?t.slice(8):t,t="(".concat(t,")"),t=eval(t)),t}new(t,r){var e=this;return a((function*(){var n=new Y(e.db);var a=Ft.parseContract(t);var i=new Proxy(a,n);var s=yield new i(...r);return new Proxy(s,n)}))()}sync(t){var r=this;return a((function*(){var e=yield r.reader.get(t);var n=new Y(r.db);return new Proxy(e,n)}))()}getOwnedRevs(){var t=arguments,r=this;return a((function*(){var e=t.length>0&&void 0!==t[0]?t[0]:r.db.wallet.getPublicKey();return r.db.wallet.restClient.getOwnedRevs(e)}))()}syncWallet(){var t=this;return a((function*(){t.db.wallet.syncWallet()}))()}}module.exports=Ft;
