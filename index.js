"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var r=require("isomorphic-ws");var e=t(r);var n=t(require("eventemitter3"));var a=t(require("bitcoinsource"));var i=t(require("axios"));function s(t,r,e,n,a,i,s){try{var o=t[i](s);var u=o.value}catch(t){return void e(t)}o.done?r(u):Promise.resolve(u).then(n,a)}function o(t){return function(){var r=this,e=arguments;return new Promise((function(n,a){var i=t.apply(r,e);function o(t){s(i,n,a,o,u,"next",t)}function u(t){s(i,n,a,o,u,"throw",t)}o(void 0)}))}}function u(t,r,e){return r in t?Object.defineProperty(t,r,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[r]=e,t}function c(t,r){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),e.push.apply(e,n)}return e}function v(t){for(var r=1;r<arguments.length;r++){var e=null!=arguments[r]?arguments[r]:{};r%2?c(Object(e),!0).forEach((function(r){u(t,r,e[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):c(Object(e)).forEach((function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(e,r))}))}return t}function d(t,r){if(null==t)return{};var e={};var n=Object.keys(t);var a,i;for(i=0;i<n.length;i++)a=n[i],r.indexOf(a)>=0||(e[a]=t[a]);return e}function p(t,r){if(null==t)return{};var e=d(t,r);var n,a;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(a=0;a<i.length;a++)n=i[a],r.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(e[n]=t[n])}return e}function h(t,r){if("object"!=typeof t||null===t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,r||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}function l(t){var r=h(t,"string");return"symbol"==typeof r?r:String(r)}var f=process.env.BC_CHAIN||"BSV";var _=process.env.BC_CHAIN||"testnet";var g=process.env.BC_LOCAL_BBS||!1;var m=process.env.BC_DUST_LIMIT||4e3;var w=process.env.BC_DEFAULT_FEE||("BSV"===f?500:1e3);var y=process.env.BC_SCRIPT_CHUNK_SIZE||479;var b=process.env.BC_WOC_API_KEY||void 0;var S;var O;process.env.BC_BBS_URL?(O="http://".concat(process.env.BC_BBS_URL),S="ws://".concat(process.env.BC_BBS_URL)):(O=g?"http://localhost:3000":"http://bitcoinbroadcastserver-env.r5t6c3b2kj.us-west-1.elasticbeanstalk.com",S=g?"ws://localhost:3000":"ws://bitcoinbroadcastserver-env.r5t6c3b2kj.us-west-1.elasticbeanstalk.com");var x={CHAIN:f,NETWORK:_,MIN_NON_DUST_AMOUNT:m,SCRIPT_CHUNK_SIZE:y,UN_P2SH_URL:O,WS_URL:S,DEFAULT_FEE:w,WOC_API_KEY:b};a.versionGuard=()=>!0,a.Networks.defaultNetwork=a.Networks[x.NETWORK];class I{constructor(t){this.kind=t}toJSON(){return{}}}function P(t){return{writable:!0,value:t}}function E(t,r,e){var{[t]:n}=e;return v({[r]:n},p(e,[t].map(l)))}var{PublicKey:N,Address:k,Transaction:T}=a;class D extends I{constructor(t,r){super("pkh"),this.address=t,this._amount=r}static fromPublicKeyHashInput(t){var{output:r}=t;return new this(r.script.toAddress(),r.satoshis)}toJSON(){return{kind:"pkh",address:this.address.toString(),amount:this._amount}}static isJSON(t){return t.address&&t.amount}static fromJSON(t){return new this(new k(t.address),t.amount)}}class j extends I{constructor(t){super("return"),this.data=t||""}getData(){return this.data}toJSON(){return{kind:"return",data:this.data}}static isJSON(t){return!!t.data}static fromJSON(t){return new this(t.data)}}var{PublicKey:C,Signature:A,Script:B,Opcode:K}=a;function U(t,r){var e=[];var n=0;for(;n<t.length;)e.push(t.slice(n,n+r)),n+=r;return e}class R extends B{static outScriptFromData(t){var{kind:r,_owners:e=[],_amount:n,__vouts:a,__txId:i}=t,s=p(t,["kind","_owners","_amount","__vouts","__txId"]);var o=U(Buffer.from(JSON.stringify(s)),x.SCRIPT_CHUNK_SIZE);return o[o.length-1].byteLength>=x.SCRIPT_CHUNK_SIZE&&U(o.pop(),x.SCRIPT_CHUNK_SIZE).forEach(t=>{o.push(t)}),o.map(t=>{var r=new R;return r.add("OP_1"),e.forEach(t=>r.add(t.toBuffer())),r.add("OP_".concat(e.length)),r.add("OP_CHECKMULTISIG"),r.add(t),r.add("OP_DROP"),{redeemScript:r,chunk:t}})}getData(){return this.isDbDataScript()?JSON.parse(this.chunks[this.chunks.length-2].buf.toString()):{}}getPublicKeys(){if(this.isDbDataScript())return this.chunks.slice(1,this.chunks.length-4).map(t=>new C(t.buf));throw new Error("Cannot get owners from non-data script")}isDbDataScript(){return!!(this.chunks.length>=5&&this.chunks[0].opcodenum===K.OP_1&&this.chunks[1].buf&&[20,33].includes(this.chunks[1].buf.length)&&this.chunks[this.chunks.length-3].opcodenum===K.OP_CHECKMULTISIG&&this.chunks[this.chunks.length-2].buf&&this.chunks[this.chunks.length-1].opcodenum===K.OP_DROP)}static isP2shScript(t){return!(3!==t.chunks.length||t.chunks[0].opcodenum!==K.OP_0||!t.chunks[1].buf||!t.chunks[2].buf)}static redeemScriptFromP2shScript(t){if(!this.isP2shScript(t))throw new Error("not a p2sh script");var r=new B(t.chunks[2].buf);var e=new this;return e.chunks=r.chunks,e}static fromScript(t){var r=new B(t);var e=new R;return e.chunks=r.chunks,e}}var H=["_id","_rev","_owners","_amount"];var J=t=>"object"==typeof t?Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1]:Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1].toLowerCase();var M=t=>["undefined","number","string","boolean","Null"].includes(J(t));var F=t=>M(t)||["Array","Object"].includes(J(t));var V=t=>"Object"===J(t)&&Object.keys(t).every(t=>!isNaN(parseInt(t,10)));var L=(t,r)=>{if(!F(t)||!F(r))throw new Error("Unsupported data types for deep equals: ".concat(J(t)," & ").concat(J(r)));return J(t)===J(r)&&(M(t)&&M(r)?t===r:t&&r&&Object.entries(t).every(t=>{var[e,n]=t;return L(r[e],n)})&&Object.entries(r).every(r=>{var[e,n]=r;return L(t[e],n)}))};var W=t=>{if(M(t))return t;if("Array"===J(t))return t.map(W);if("Object"===J(t)){var r=Object.keys(t).reduce((r,e)=>(r[e]=W(t[e]),r),{});var e=Object.create(Object.getPrototypeOf(t));return Object.assign(e,r)}throw new Error("Unsupported data type for clone: ".concat(J(t)))};var z=(t,r)=>t.reduce((t,e)=>{var[n,a]=t;return r(e)?[[...n,e],a]:[n,[...a,e]]},[[],[]]);var q=(t,r)=>Object.fromEntries(Object.entries(t).map(t=>{var[e,n]=t;return[e,r(n)]}));var Z=(t,r)=>Object.fromEntries(Object.entries(t).filter(t=>{var[,e]=t;return r(e)}));var G=t=>JSON.stringify(Object.entries(t));var Y=(t,r)=>{var e=new r;return JSON.parse(t).forEach(t=>{var[r,n]=t;return e[r]=n}),e};var Q=t=>M(t)?t:Object.entries(t).reduce((t,r)=>{var[e,n]=r;var a=Q(n);return V(a)?Object.entries(a).forEach(r=>{var[n,a]=r;t["".concat(e,"_").concat(n)]=a}):t[e]=a,t},{});var X=0;var $=()=>"__temp__:".concat(X++);var tt=t=>{if("Array"===J(t))t.map(tt);else if("Object"===J(t)){var r=$();t._id=t._id||r,t._rev=t._rev||r,Object.values(t).map(tt)}};var rt=t=>{"Array"===J(t)?t.map(rt):"Object"===J(t)&&(void 0!==t._owners&&(t._owners=JSON.stringify(t._owners)),Object.values(t).map(rt))};var et=t=>{"Array"===J(t)?t.map(et):"Object"===J(t)&&(void 0!==t._owners&&(t._owners=JSON.parse(t._owners)),Object.values(t).map(et))};var nt=(t,r)=>{"Array"===J(t)?t.map(t=>nt(t,r)):"Object"===J(t)&&(void 0!==t._id&&t._id.startsWith("__temp__")&&(t._id="".concat(r,":").concat(t._id.split(":")[1])),Object.values(t).map(t=>nt(t,r)))};var at=t=>{var r={[t._id]:Object.entries(t).reduce((t,r)=>{var[e,n]=r;return H.includes(e)?v({},t,{},{[e]:n}):M(n)?v({},t,{},{["__basic__".concat(e)]:n}):v({},t,{},{[e]:n._id})},{})};return Object.values(t).filter(t=>!M(t)).reduce((t,r)=>v({},t,{},at(r)),r)};var it=(t,r)=>(t[r].__contains=Object.entries(t[r]).reduce((r,e)=>{var[n,a]=e;return["__contains"].concat(H).includes(n)?r:"__change"===n?"new"===a||"diff"===a||r:it(t,a)[a].__contains||r},!1),t);var st=(t,r)=>Object.fromEntries(Object.entries(r).map(r=>{var[e,n]=r;var a=t[e];var i;return n.__change=(i=a)?L(i,n)?"same":"diff":"new",[e,n]}));var ot=t=>Object.fromEntries(Object.entries(t).filter(t=>{var[r]=t;return!r.startsWith("__basic__")}));var ut=t=>t.reduce((t,r,e)=>v({},t,{},{[r._id]:e}),{});var ct=(t,r)=>t.map(t=>Object.entries(t).reduce((t,e)=>{var[n,a]=e;return v({},t,{},{[n]:"undefined"!==J(r[a])?r[a]:a})},{}));var vt=(t,r)=>{var e=r._id;tt(r);var n=W(t);var a=W(r);rt(n),rt(a);var i=Q(n);var s=Q(a);var o=at(i);var u=at(s);var c=st(o,u);var d=q(c,ot);var p=it(d,e);var h=p[e];delete p[e];var l=q(p,t=>t._rev);var f=Z(p,t=>t.__contains||Object.values(h).includes(t._id));var _=Object.values(f);var[g,m]=z(_,t=>"new"===t.__change);var w=[...m,...g];var y=ut(w);var b=ct(w,y);var[S]=ct([h],y);var O=m.map(t=>t._rev);b.concat([S]).forEach(t=>{delete t._id,delete t._rev,delete t.__change,delete t.__contains});var x=b.map(t=>Object.entries(t).reduce((t,r)=>{var[e,n]=r;return v({},t,{},{[e]:l[n]||n})},{}));return et(x),[O,x,S]};var{PublicKey:dt,Transaction:pt,Script:ht}=a;class lt extends I{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super("script"),Object.assign(this,t),this._amount=t._amount||x.MIN_NON_DUST_AMOUNT}getData(t){return this[t]}getSerializeData(){var t=p(this,["kind","_owners","_amount"]);return Buffer.from(JSON.stringify(t))}static fromMultiSigScriptHashInput(t){var{_scriptBuffer:r}=t;var e=R.fromBuffer(r);var{redeemScript:n=R.redeemScriptFromP2shScript(e)}=t;return this.fromRedeemScript(n)}static fromRedeemScript(t){return this.fromRedeemScripts([t])}static fromRedeemScripts(t){var r=t.map(t=>t.chunks[t.chunks.length-2].buf);var e=Buffer.concat(r);var n=JSON.parse(e.toString());return Object.assign(new this,v({kind:"script",_owners:t[0].getPublicKeys(),_amount:x.MIN_NON_DUST_AMOUNT},n))}static addVouts(t){var r=0;return t.map(t=>{var e="script"===t.kind?R.outScriptFromData(t).length:1;return t.__vouts=Array(e).fill(r).map((t,r)=>t+r),r+=e,t})}toJSON(){return v({},this,{kind:"script",_owners:(this._owners||[]).map(t=>t.toString())})}static isJSON(t){return"script"===t.kind}static fromJSON(t){var r=W(t);return r._owners=(r._owners||[]).map(t=>new dt(t)),new lt(r)}}var{PublicKey:ft,Address:_t}=a;class gt extends I{constructor(t){super("change"),this.address=t}toJSON(){return{kind:"change",address:this.address.toString()}}static isJSON(t){return t.address}static fromJSON(t){return new this(new _t(t.address))}}var{Address:mt,Transaction:wt,PublicKey:yt,Script:bt}=a;var St=new Map;class Ot{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:x.CHAIN;var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:x.NETWORK;this.chain=t,this.network=r}getBaseUrl(){if("BSV"===this.chain){var t="livenet"===this.network?"main":"test";return"https://api.whatsonchain.com/v1/bsv/".concat(t)}var r="livenet"===this.network?"rest":"trest";return"https://".concat(r,".bitcoin.com/v2")}getRequestHeaders(){return"BSV"===this.chain&&x.WOC_API_KEY?{"woc-api-key":x.WOC_API_KEY}:{}}unwrap(t){return o((function*(){try{return(yield t).data}catch(t){var{message:r,config:e,response:n}=t;var{url:a,method:i,data:s}=e;var o;try{o=JSON.parse(s)}catch(t){o=null}var u=o&&o.txhex?new wt(o.txhex):null;throw t.message="Communication Error\n\nmessage\t".concat(r,"\nrequest\t").concat(i," ").concat(a,"\n").concat(u?"transaction\t ".concat(JSON.stringify(u.toJSON(),null,2)):"post"!==i||u?"":"data\t".concat(s),"\n").concat(n?"response\t".concat(JSON.stringify(n.data)):""),t}}))()}get(t){var r=this;var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return o((function*(){var n=e?"":r.getBaseUrl();return r.unwrap(i.get("".concat(n).concat(t),{headers:r.getRequestHeaders()}))}))()}post(t,r){var e=this;var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return o((function*(){var a=n?"":e.getBaseUrl();return e.unwrap(i.post("".concat(a).concat(t),r,{headers:e.getRequestHeaders()}))}))()}getBalance(t){var r=this;return o((function*(){switch(r.chain){case"BSV":var e="/address/".concat(t.toString(),"/balance");var{confirmed:n,unconfirmed:a}=yield r.get(e);return parseInt(n,10)+parseInt(a,10);case"BCH":var i="/address/details/".concat(t.toString());var{balanceSat:s,unconfirmedBalanceSat:o}=yield r.get(i);return parseInt(s,10)+parseInt(o,10);default:throw new Error("chain is not set in getBalance")}}))()}getTransaction(t){var r=this;return o((function*(){var e=yield r.getRawTransaction(t);return new wt(e)}))()}getTransactionWithSpendingData(t){var r=this;return o((function*(){if("testnet"===r.network&&"BSV"===r.chain)throw new Error("Restclient.getTransactionWithSpendingData is not supported on BSV testnet");switch([t]=t.split(":"),r.chain){case"BSV":var e="https://api.blockchair.com/bitcoin-sv/dashboards/transaction/".concat(t);var{data:n}=yield r.get(e,!0);var{transaction:a,inputs:i,outputs:s}=n[t];return{hex:"",txid:a.hash,hash:a.hash,version:a.version,size:a.size,locktime:a.lock_time,vin:i,vout:s.map(t=>({value:t.value,n:t.index,scriptPubKey:t.script_hex,spentTxId:t.spending_transaction_id,spentIndex:t.spending_index})),blockhash:"unknown",confirmations:"unknown",time:"unknown",blocktime:"unknown"};case"BCH":return r.get("/transaction/details/".concat(t));default:throw new Error("chain is not set in getTransactionWithSpendingData")}}))()}getRawTransaction(t){var r=this;return o((function*(){[t]=t.split(":");var e=St.get(t);if(e)return e;var n="livenet"===r.network?"main":"test";var a=yield r.unwrap(i.get("".concat(x.UN_P2SH_URL,"/tx/").concat(r.chain,"/").concat(n,"/").concat(t)));return St.set(t,a),a}))()}sendTransaction(t){var r=this;return o((function*(){if("BSV"===r.chain)return yield r.post("/tx/raw",{txhex:t.toString()});if("BCH"===r.chain){var[e]=yield r.post("/rawtransactions/sendRawTransaction",{hexes:[t.toString()]});return e}throw new Error("chain is not set in sendTransaction")}))()}getUtxosFromAddress(t){var r=this;return o((function*(){var e=[];var n="";switch(r.chain){case"BSV":var a=(e=yield r.get("/address/".concat(t.toString(),"/unspent"))).map(t=>{var{tx_hash:r,tx_pos:e,value:n}=t;return{txId:r,vout:e,satoshis:n,amount:n/1e8}});return Promise.all(a.map(function(){var t=o((function*(t){var e=(yield r.getTransaction(t.txId)).outputs[t.vout];return t.scriptPubKey=e.script.toHex(),t}));return function(r){return t.apply(this,arguments)}}()));case"BCH":return({utxos:e,scriptPubKey:n}=yield r.get("/address/utxo/".concat(t.toString()))),(e=e.map(t=>v({scriptPubKey:n},t))).map(t=>{var{txid:r}=t;return v({txId:r},p(t,["txid"]))});default:throw new Error("chain is not set in getUtxosFromAddress")}}))()}getTxosFromOutputData(t){var r=this;return o((function*(){var e=t.map(t=>t.__txId);var n=[...new Set(e)];var a=new Map;return yield Promise.all(n.map(function(){var t=o((function*(t){return a.set(t,yield r.getTransaction(t))}));return function(r){return t.apply(this,arguments)}}())),t.map(t=>{var{vout:r,blockheight:e,confirmations:n}=a.get(t.__txId)||{};return t.__vouts.map(a=>{var{scriptPubKey:i,value:s}=r[a];return{address:i.addresses[0],txId:t.__txId,vout:a,scriptPubKey:i.hex,amount:parseFloat(s),satoshis:parseInt(1e8*s,10),height:e,confirmations:n}})})}))()}postOutputData(t){var r=this;return o((function*(){return r.post("".concat(x.UN_P2SH_URL,"/"),t,!0)}))()}getOutputData(t){var r=this;return o((function*(){return r.get("".concat(x.UN_P2SH_URL,"/un-p2sh/").concat(t),!0)}))()}getOwnedRevs(t){var r=this;return o((function*(){return r.get("".concat(x.UN_P2SH_URL,"/txos/").concat(t.toString()),!0)}))()}setTxoSpent(t){var r=this;return o((function*(){var[e,n]=t.split(":");return r.post("".concat(x.UN_P2SH_URL,"/txos/set-spent/"),{txId:e,virtualIndex:parseInt(n,10)},!0)}))()}}class xt{static fromJSON(t){if(lt.isJSON(t))return lt.fromJSON(t);if(D.isJSON(t))return D.fromJSON(t);if(gt.isJSON(t))return gt.fromJSON(t);if(j.isJSON(t))return j.fromJSON(t);throw new Error("unrecognized json ".concat(JSON.stringify(t)))}}var{Transaction:It,PublicKey:Pt,Address:Et,BN:Nt,Script:kt,encoding:Tt}=a;var{Output:Dt,Input:jt}=It;var{MultiSigScriptHash:Ct,PublicKeyHashInput:At}=jt;var{BufferReader:Bt}=Tt;var Kt=t=>new Promise(r=>setTimeout(r,t));class Ut extends It{constructor(t,r,e){super(e),this._outputData=[],this.restClient=new Ot(t,r),this.feePerKb(x.DEFAULT_FEE),Object.defineProperty(this,"to",P(this._to)),Object.defineProperty(this,"from",P(this._from))}get chain(){return this.restClient.chain}get network(){return this.restClient.network}get dataInputs(){var t=[];var r=function*(t){for(var r of t)yield r}(this.inputs);var e=r.next();for(;!e.done;){var n=e.value;var a=R.fromScript(n._scriptBuffer);if(a.isPublicKeyHashIn())t.push(new D(a.toAddress(),0));else if(R.isP2shScript(a)){var i=!1;var s=[R.redeemScriptFromP2shScript(a)];for(;!i;)try{t.push(lt.fromRedeemScripts(s)),i=!0}catch(t){var o=r.next();if(o.done)throw new Error("Could not compute data inputs");var u=o.value;var c=R.fromScript(u._scriptBuffer);s.push(R.redeemScriptFromP2shScript(c))}}e=r.next()}return t}set dataInputs(t){throw Error("dataTransaction.dataInputs cannot be set directly, use dataTransaction.from or dataTransaction.fromScriptOutput")}get inputsWithData(){return this.dataInputs.filter(t=>"script"===t.kind)}getVirtualInputs(t){var r=this;return o((function*(){if("BSV"===r.chain)return(yield Promise.all(r.inputs.map(function(){var t=o((function*(t){var{prevTxId:e,outputIndex:n}=t;var a=t.prevTxId.toString("hex");var i=(yield Ut.fromTxId(a,r.chain,r.network)).outputs[n];return!!R.fromScript(i._scriptBuffer).isDbDataScript()&&t}));return function(r){return t.apply(this,arguments)}}()))).filter(t=>!!t).map(t=>"".concat(t.prevTxId.toString("hex"),":").concat(t.outputIndex));if("BCH"===t){var{inputsWithData:e}=r;var n=lt.addVouts(e);return Promise.all(n.map(function(){var e=o((function*(e){var n=[];e.__vouts.forEach(t=>{n.push(r.inputs[t])});var a=n[0].prevTxId.toString("hex");var i=yield Ut.fromTxId(a,t);yield i.fetchOutputData();var s=lt.addVouts(i.outputData);var o=[];s.forEach((t,r)=>{L(t.__vouts,n.map(t=>t.outputIndex))&&o.push(r)});var u=o[0];return"".concat(a,":").concat(u)}));return function(t){return e.apply(this,arguments)}}()))}throw new Error("chain not set in getVirtualInputs")}))()}fromMultiSig(t,r,e){var n=t.map(t=>E("txId","txid",t));return super.from(n,r,e)}_from(t,r,e){var n=E("txId","txid",t);return super.from(n,r,e)}fromScriptOutput(t,r){var e=R.outScriptFromData(r);var{_owners:n}=r;return e.forEach((r,e)=>{var{redeemScript:a}=r;var{scriptPubKey:i,satoshis:s,txId:o,vout:u}=t[e];var c=new Dt({script:new R(i),satoshis:parseInt(s,10)});var v=new R;var d=new Ct({prevTxId:o,output:c,outputIndex:u,script:v},n,1,null,a);this.addInput(d)}),this}get outputData(){if("BSV"===this.chain)return this.outputs.filter(t=>R.fromScript(t._scriptBuffer).isDbDataScript()).map(t=>{var{chunks:r}=t._script||t.script;var{buf:e}=r[r.length-2];var n=JSON.parse(e.toString());var a=r.slice(1,r.length-4);return n._owners=a.map(t=>new Pt(t.buf).toString()),n._amount=t._satoshis,n});if("BCH"===this.chain)return this._outputData;throw new Error("Chain not set in dataTransaction get outputdata")}set outputData(t){throw Error("dataTransaction.outputData cannot be set directly")}change(t){var r=this.outputs.length;return super.change(t),this.outputs.length>r&&this._outputData.push(new gt(t)),this}toChangeOutput(t){var r=this.outputs.length;return super.change(t.address),this.outputs.length>r&&this._outputData.push(t),this._outputData.length-1}toPkhOutput(t){return super.to(t.address,t._amount),this._outputData.push(t),this._outputData.length-1}toScriptOutput(t){if("BSV"===this.chain){var{_owners:r=[],_amount:e}=t,n=p(t,["_owners","_amount"]);var a=new R;a.add("OP_1"),r.forEach(t=>a.add(t.toBuffer())),a.add("OP_".concat(r.length)),a.add("OP_CHECKMULTISIG"),a.add(Buffer.from(JSON.stringify(n))),a.add("OP_DROP");var i=new Dt({script:a,satoshis:e});return this.addOutput(i),this.outputs.length-1}if("BCH"===this.chain){var s=R.outScriptFromData(t);return this._outputData.push(t),s.forEach(r=>{var{redeemScript:e,chunk:n}=r;var a="BSV"===this.chain?e:R.buildScriptHashOut(e);var i=t._amount;var s=new Dt({script:a,satoshis:i});this.addOutput(s)}),this._outputData.length-1}throw new Error("chain not set in dataScript.toScriptOutput")}toReturnOutput(t){return this.addData(t.data),this._outputData.push(t),this._outputData.length-1}_to(t){switch(t.kind){case"change":return this.toChangeOutput(t);case"return":return this.toReturnOutput(t);case"script":return this.toScriptOutput(t);case"pkh":return this.toPkhOutput(t);default:throw new Error("Unsupported output kind ".concat(t.kind))}}fetchOutputData(){var t=this;return o((function*(){if(t._outputData.length)return t._outputData;var r=t.getTxId();var e=[];return"BSV"===t.chain?e=t.outputs.map(t=>{var r=R.fromScript(t._scriptBuffer);var e=t._satoshis;if(r.isDbDataScript()){var n=r.getPublicKeys().map(t=>t.toString());return Object.assign(r.getData(),{kind:"script",_amount:e,_owners:n})}if(r.isPublicKeyHashOut()){var a=r.getPublicKeyHash();return{kind:"change",address:Et.fromPublicKeyHash(a)}}throw new Error("Unrecognized output script ".concat(r.toString()))}):"BCH"===t.chain&&(e=yield t.restClient.getOutputData(r)),t._outputData=e.map(xt.fromJSON),t._outputData}))()}get prevObjectIds(){return this.inputs.map(t=>"".concat(t.prevTxId.toString("hex"),":").concat(t.outputIndex))}getTxId(){return new Bt(this._getHash()).readReverse().toString("hex")}static fromTxId(t,r,e){return o((function*(){var n=null;var a=new Ot(r,e);try{n=yield a.getRawTransaction(t)}catch(r){yield Kt(3e3),n=yield a.getRawTransaction(t)}var i=new Ut(r,e);return i.fromString(n),i}))()}}var{Mnemonic:Rt,HDPrivateKey:Ht,PrivateKey:Jt,PublicKey:Mt,Address:Ft,OutputData:Vt}=a;class Lt{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Rt;var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:x.CHAIN;var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:x.NETWORK;this.mnemonic=t,this.path="",this.restClient=new Ot(r,e),this.hdPrivateKey=this.mnemonic.toHDPrivateKey(this.path,x.NETWORK)}get chain(){return this.restClient.chain}get network(){return this.restClient.network}static getRandomMnemonic(){return(new Rt).toString()}getRandomMnemonic(){return Lt.getRandomMnemonic()}static fromMnemonic(t,r){return new Lt(t,r)}getMnemonic(){return this.mnemonic}getPath(){return this.path}derive(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];var e=new Lt(this.mnemonic);return e.path="".concat(this.path).concat(this.path.length?"/":"").concat(t).concat(r?"'":""),e.hdPrivateKey=this.hdPrivateKey.derive(t,r),e}static getHdPrivateKey(){return new Ht}getPrivateKey(){return this.hdPrivateKey.privateKey}getPublicKey(){return this.hdPrivateKey.publicKey}getAddress(){return this.address=this.address||this.getPublicKey().toAddress(this.network),this.address}getBalance(){var t=this;return o((function*(){var r=t.getAddress();return t.restClient.getBalance(r.toString())}))()}getUtxos(t){var r=this;var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getAddress();return o((function*(){var n=yield r.restClient.getUtxosFromAddress(e);for(var a=n.length-1;a>0;a-=1){var i=Math.floor(Math.random()*(a+1));[n[a],n[i]]=[n[i],n[a]]}var s=0;var o=[];var u=0;for(;s<t&&u<n.length;)o.push(n[u]),s+=n[u].satoshis,u+=1;if(s>=t)return o;throw new Error("Insufficient balance in address ".concat(e.toString()," on ").concat(x.NETWORK," ").concat(x.CHAIN,". Found ").concat(s,", required ").concat(t,"."))}))()}sendOutputData(t,r){var e=this;return o((function*(){var n=new Ut(e.chain,e.network);var a=r||e.getAddress();var i=Ut._estimateFee(n._estimateSize(),n._getUnspentValue(),x.DEFAULT_FEE);return(yield e.getUtxos(n._getOutputAmount()-n._getInputAmount()+i)).forEach(t=>n.from(t)),t.forEach(n.to.bind(n)),n.change(a),n.sign(e.getPrivateKey()),e.sendTransaction(n)}))()}sendTransaction(t){var r=this;var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return o((function*(){var n=yield r.restClient.sendTransaction(t);if(e){var a=JSON.stringify(t.outputData);var i=t.toJSON().inputs.map(t=>{var{prevTxId:r,outputIndex:e}=t;return{txId:r,outputIndex:e}});yield r.restClient.postOutputData({txId:n,outputData:a,inputs:i})}return n}))()}sendAll(t){var r=this;return o((function*(){var e=yield r.getBalance();var n=x.DEFAULT_FEE;if(e>n){var a=new D(t,e-n);return r.sendOutputData([a])}throw new Error("Insufficient funds to send payment.")}))()}}var{HDPrivateKey:Wt,Mnemonic:zt,Transaction:qt,Script:Zt}=a;class Gt{constructor(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:x.CHAIN;var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:x.NETWORK;this.wallet=t||new Lt(void 0,r,e)}get chain(){return this.wallet.chain}get network(){return this.wallet.network}static fromMnemonic(t,r,e){return new this(new Lt(t,r,e),r,e)}put(t){var r=this;return o((function*(){return r.update([],t)}))()}getOutputDataMap(t){var r=this;return o((function*(){var e=[...new Set(t)];var n=yield Promise.all(e.map(function(){var t=o((function*(t){var e=(yield r.wallet.restClient.getOutputData(t)).map(xt.fromJSON);var n=0;var a=e.map(r=>{var e="script"===r.kind?R.outScriptFromData(r).length:1;var a=Array(e).fill(n).map((t,r)=>t+r);return n+=e,v({},r,{__vouts:a,__txId:t})});return[t,a]}));return function(r){return t.apply(this,arguments)}}()));return new Map(n)}))()}get(t){var r=this;return o((function*(){if("BSV"===r.chain){var e=t.map(t=>t.split(":")[0]);var n=[...new Set(e)];var a=yield Promise.all(n.map(function(){var t=o((function*(t){return[t,yield r.wallet.restClient.getTransaction(t)]}));return function(r){return t.apply(this,arguments)}}()));var i=new Map(a);return Promise.all(t.map(function(){var t=o((function*(t){var[r,e]=t.split(":");var n=i.get(r).outputs[parseInt(e,10)];var a=R.fromScript(n.script);return Object.assign(n.script.getData(),{__txId:r,__vouts:[parseInt(e,10)],_owners:a.getPublicKeys(),_amount:Math.round(n.satoshis)})}));return function(r){return t.apply(this,arguments)}}()))}if("BCH"===r.chain){var s=t.map(t=>t.split(":")[0]);var u=yield r.getOutputDataMap(s);return t.map(t=>{var[r,e]=t.split(":");var n=u.get(r);if(!n||!Array.isArray(n))throw new Error("No data found.");return n[parseInt(e,10)]})}throw new Error("chain not set in db.get")}))()}getUpdateTxBch(t,r,e){var n=this;return o((function*(){var e=new Ut(n.chain,n.network);var a=yield n.get(t);var i=yield n.wallet.restClient.getTxosFromOutputData(a);t.forEach(function(){var t=o((function*(t,r){e.fromScriptOutput(i[r],a[r])}));return function(r,e){return t.apply(this,arguments)}}());var s=r.map(t=>e.to(t));var u=qt._estimateFee(e._estimateSize(),e._getUnspentValue(),x.DEFAULT_FEE);return(yield n.wallet.getUtxos(e._getOutputAmount()-e._getInputAmount()+u)).forEach(t=>e.from(t)),e.change(n.wallet.getAddress()),e.sign(n.wallet.getPrivateKey()),{transaction:e,virtualIndices:s}}))()}getUpdateTxBsv(t,r,e){var n=this;return o((function*(){var e=new Ut(n.chain,n.network);(yield Promise.all(t.map(function(){var t=o((function*(t){var[r,e]=t.split(":");var a=yield n.wallet.restClient.getTransaction(r);var{script:i,satoshis:s}=a.outputs[parseInt(e,10)];var o=R.fromScript(i);return{output:{txId:r,outputIndex:parseInt(e,10),scriptPubKey:o,satoshis:Math.round(s)},publicKeys:o.getPublicKeys(),nr:1}}));return function(r){return t.apply(this,arguments)}}()))).forEach(t=>{var{output:r,publicKeys:n,nr:a}=t;e.from(r,n,a)}),r.map(t=>t._amount=Math.max(t._amount||x.MIN_NON_DUST_AMOUNT));var a=r.map(t=>e.to(t));var i=qt._estimateFee(e._estimateSize(),e._getUnspentValue(),x.DEFAULT_FEE);return(yield n.wallet.getUtxos(e._getOutputAmount()-e._getInputAmount()+i)).forEach(t=>e.from(t)),e.change(n.wallet.getAddress()),e.sign(n.wallet.getPrivateKey()),yield e.fetchOutputData(),{transaction:e,virtualIndices:a}}))()}update(t,r){var e=this;return o((function*(){var n=r.reduce((t,r)=>t+parseInt(r._amount,10),0);if("BSV"===e.chain){var{transaction:a,virtualIndices:i}=yield e.getUpdateTxBsv(t,r,n);var s=yield e.wallet.sendTransaction(a,!0);return t.forEach(function(){var t=o((function*(t){yield e.wallet.restClient.setTxoSpent(t)}));return function(r){return t.apply(this,arguments)}}()),i.map(t=>"".concat(s,":").concat(t))}if("BCH"===e.chain){var{transaction:u,virtualIndices:c}=yield e.getUpdateTxBch(t,r,n);var v=yield e.wallet.sendTransaction(u,!0);return t.forEach(function(){var t=o((function*(t){yield e.wallet.restClient.setTxoSpent(t)}));return function(r){return t.apply(this,arguments)}}()),c.map(t=>"".concat(v,":").concat(t))}throw new Error("Chain not set in db.update ".concat(e.chain))}))()}createUtxos(t,r){var e=this;return o((function*(){var n=r||10*x.MIN_NON_DUST_AMOUNT;console.log("Creating ".concat(t," unspent outputs with ").concat(n," satoshis in address ").concat(e.wallet.getAddress().toString()));var a=[...Array(t-1).keys()].map(()=>new D(e.wallet.getAddress(),n));return e.update([],a)}))()}}var Yt=eval;class Qt{eval(t){return o((function*(){return Yt(t)}))()}apply(t,r,e){return o((function*(){return{res:t[r](...e),obj:t}}))()}}class Xt{constructor(){return new Qt}eval(t){var r=this;return o((function*(){return r.sandbox.eval(t)}))()}apply(t,r,e){var n=this;return o((function*(){return n.sandbox.apply(t,r,e)}))()}}class $t{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};var{chain:r,db:e=new Gt(void 0,r),sandbox:a=new Xt,eventEmitter:i=new n}=t;this.db=e,this.sandbox=a,this.eventEmitter=i,this._initialized=!1,this.chain=r}get(t,r){var e=this;if("_initialized"===r)return Reflect.get(this,r);if(["_id","_rev","_owners","_amount","__pos"].includes(r))return Reflect.get(t,r);if("__target"===r)return t;if(["_on","_once","_emit"].includes(r))return(t,e)=>this.eventEmitter[r.substring(1)](t,e);if("_close"===r)throw new Error("Smart objects do not need to be closed anymore.");return t&&r&&"function"!=typeof t[r]?Reflect.get(t,r):Object.prototype.hasOwnProperty.call(t.constructor.prototype,r)?function(){var n=o((function*(){for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return e.update(a,t,r)}));return function(){return n.apply(this,arguments)}}():Reflect.get(t,r)}update(t,r,e){var n=this;return o((function*(){if(t.some(t=>void 0===t))throw new Error("All paramters to a smart contract must be defined");var a=t.filter(t=>t._rev);var i=W(a);var s=t.map(t=>t._rev?"__":t);var o=t.map(t=>t._rev?t.__target:t);var u=W(r);var{res:c}=yield n.sandbox.apply(u,e,o);var v=i.reduce((t,r,e)=>Object.assign(t,{["arg".concat(e)]:r}),{_id:"__index:0",obj:r});var d=a.reduce((t,r,e)=>Object.assign(t,{["arg".concat(e)]:r}),{_id:"__index:1",obj:u});var[p,h,l]=vt(v,d);void 0!==h[0]&&(h[0].__func=e,h[0]._args=s,h[0].__index=l);var f=h.map(lt.fromJSON);yield n.db.update(p,f);var{eventEmitter:_}=n;return new Promise(t=>{_.once("updated",()=>{t(c)})})}))()}set(t,r,e){return t[r]=e,!0}}var tr;if("undefined"==typeof window){var{LocalStorage:rr}=require("node-localstorage");tr=new rr("./uls-scratch")}else void 0!==window.localStorage&&({localStorage:tr}=window);var er=tr;var{Mnemonic:nr,PublicKey:ar}=a;var ir=t=>new Promise(r=>setTimeout(r,t));var sr=function(){var t=o((function*(t,r){return new Promise(e=>{t._initialized||t._once(r,e)})}));return function(r,e){return t.apply(this,arguments)}}();class or{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};var{seed:r}=t;var{chain:n=x.CHAIN}=t;var{network:a=x.NETWORK}=t;var{sandbox:i=new Xt}=t;var{mnemonic:s=new nr(r)}=t;var{db:o=Gt.fromMnemonic(s,n,a)}=t;this.db=o,this.sandbox=i,this.socket=new e(x.WS_URL),this.socket.addEventListener("message",this.onWebsocketMessage.bind(this)),this.objects=new Map}get chain(){return this.db.chain}get network(){return this.db.network}_createSmartObject(t){var{db:r,sandbox:e}=this;var{chain:a}=r.wallet.restClient;var i=new n;var s=new $t({__target:t,chain:a,db:r,sandbox:e,eventEmitter:i});var o=new Proxy(t,s);return this.objects.set(o._id,o),o}formatContract(t){var r=this;return o((function*(){return"string"===J(t)&&(t=(t=t.startsWith("export ")?t.slice(7):t).startsWith("default ")?t.slice(8):t,t="(".concat(t,")"),t=yield r.sandbox.eval(t)),t}))()}new(t){var r=this;var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return o((function*(){if(e.some(t=>void 0===t))throw new Error("All paramters to a smart contract must be defined");var n=e.filter(t=>t._rev);var a=W(n);var i=e.map(t=>t._rev?"__":t);var s=e.map(t=>t._rev?t.__target:t);var o=new(t=yield r.formatContract(t))(...s);var u=a.reduce((t,r,e)=>Object.assign(t,{["arg".concat(e)]:r}),{_id:"__index:0",obj:{}});var c=n.reduce((t,r,e)=>Object.assign(t,{["arg".concat(e)]:r}),{_id:"__index:1",obj:o});var[v,d,p]=vt(u,c);void 0!==d[0]&&(d[0].__func="constructor",d[0]._args=i,d[0].__index=p,d[0].__cls=t.toString());var h=d.map(lt.fromJSON);var[l]=yield r.db.update(v,h);nt(c,l.split(":")[0]),o._id=l,o._rev=l;var f=r._createSmartObject(o);return yield sr(f,"initialized"),f}))()}sync(t){var r=this;return o((function*(){var e=yield or.getObjectAt(t,r.sandbox,r.chain);return r._createSmartObject(e)}))()}shutdown(){var t=this;setTimeout(()=>{t.socket.readyState===r.OPEN?t.socket.close():t.shutdown()},5)}onWebsocketMessage(t){var r=this;var{data:e}=t;return o((function*(){var{txId:t,outputData:n}=JSON.parse(e);var a=yield Ut.fromTxId(t,r.chain);if(yield a.fetchOutputData(),"BSV"===r.chain)({outputData:n}=a);else{if("BCH"!==r.chain)throw new Error("chain not set in onWebsocketMessage");n=JSON.parse(n)}var[{__func:i}]=n;var s=yield a.getVirtualInputs(r.chain);var o=[];var u=function(e){var n=s.findIndex(t=>t===e._rev);"constructor"===i?o.push(r.emitInitialized(e)):-1!==n&&o.push(r.updateObject(e,"".concat(t,":").concat(n)))};for(var[,c]of r.objects)u(c);yield Promise.all(o)}))()}emitInitialized(t){var r=this;return o((function*(){var e=!1;for(;!e;)try{var n=t._id.split(":");yield r.db.wallet.restClient.getTransaction(n[0]),e=!0}catch(t){yield ir(500)}t._emit("initialized")}))()}updateObject(t,r){var e=this;return o((function*(){t._rev=r;var n=yield or.getObjectAt(t._rev,e.sandbox,e.chain);Object.entries(n).forEach(r=>{var[e,n]=r;t[e]=n}),t._emit("updated")}))()}static getValuesAt(t,r,e){return o((function*(){var{data:n,clazz:a,id:i}=JSON.parse(er.getItem(t||""))||{};if(n&&a&&i){var s=eval("(".concat(a,")"));var u=Y(n,s);return[{value:u,id:i}]}if(!e)throw new Error("chain not set in getValuesAt");var c=yield Ut.fromTxId(t,e);yield c.fetchOutputData(e);var v=yield c.getVirtualInputs(e);var d=v.length?[v[0]]:[];var p=yield Promise.all(d.map(function(){var t=o((function*(t){var[n,a]=t.split(":");return(yield or.getValuesAt(n,r,e))[parseInt(a,10)]}));return function(r){return t.apply(this,arguments)}}()));var h=p.map(t=>t.value);var l=p.map(t=>t.id);var{__func:f,_args:_,__cls:g}=c.outputData[0];var m=0;var w=null;var y=null;if("constructor"===f){var b=h;var S=_.map(t=>"__"===t?b[m++]:t);var O=yield r.eval("(".concat(g,")"));w=new O(...S),y="".concat(t,":",0)}else{var[x,...I]=h;var P=_.map(t=>"__"===t?I[m++]:t);yield r.apply(x,f,P),w=x,[y]=l}return er.setItem(t,JSON.stringify({data:G(w),id:y,clazz:w.constructor.toString()})),[{value:w,id:y}]}))()}static getValueAt(t,r,e){return o((function*(){var n=t.split(":");return(yield or.getValuesAt(n[0],r,e))[n[1]]}))()}static getObjectAt(t,r,e){var n=this;return o((function*(){var{value:a,id:i}=yield n.getValueAt(t,r,e);return a._id=i,a._rev=t,a}))()}getOwnedRevs(){var t=this;var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.db.wallet.getPublicKey();return o((function*(){return t.db.wallet.restClient.getOwnedRevs(r)}))()}revFromId(t){var r=this;return o((function*(){var[e,n]=t.split(":");var a=yield r.db.wallet.restClient.getTransactionWithSpendingData(e);var{spentTxId:i,spentIndex:s}=a.vout[n];var o="".concat(i,":").concat(s);return i?r.revFromId(o):t}))()}}module.exports=or;
