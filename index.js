"use strict";var t=require("bitcoinsource");var e=require("axios");function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var r=n(t);var s=n(e);
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function i(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(t);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(t,r[s])&&(n[r[s]]=t[r[s]])}return n}function o(t,e,n,r){return new(n||(n=Promise))((function(s,i){function o(t){try{a(r.next(t))}catch(t){i(t)}}function c(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,c)}a((r=r.apply(t,e||[])).next())}))}const c=process.env.BC_CHAIN||"BSV";const a=process.env.BC_NETWORK||"testnet";const u=process.env.BC_WOC_API_KEY||void 0;const h=parseInt(process.env.BC_DUST_LIMIT,10)||4e3;const d=parseInt(process.env.BC_DEFAULT_FEE,10)||("BSV"===c?500:2500);const p=parseInt(process.env.BC_SCRIPT_CHUNK_SIZE,10)||479;let l;let f;process.env.BC_BBS_URL?(f="http://"+process.env.BC_BBS_URL,l="ws://"+process.env.BC_BBS_URL):(f="https://bbs.bitcoincomputer.io",l="wss://bbs.bitcoincomputer.io");var v={CHAIN:c,NETWORK:a,WOC_API_KEY:u,MIN_NON_DUST_AMOUNT:h,SCRIPT_CHUNK_SIZE:p,UN_P2SH_URL:f,WS_URL:l,DEFAULT_FEE:d};r.default.versionGuard=()=>!0,r.default.Networks.defaultNetwork=r.default.Networks[v.NETWORK];const{PublicKey:g}=r.default;const _=()=>"__temp__:"+Math.random();const w=["_id","_rev","_owners","_amount","__vouts","__txId","__cls","__func","__index","__args"];const m=t=>Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1];const b=t=>"object"==typeof t?m(t):m(t).toLowerCase();const y=t=>["number","string","boolean","undefined","Null"].includes(b(t));const O=t=>"Array"===b(t);const S=t=>"Object"===b(t);const x=t=>!!t._owners&&"object"==typeof t._owners;const I=t=>!!t._owners&&"string"==typeof t._owners;const j=t=>!!t._amount;const P=t=>y(t)||["Array","Object"].includes(b(t));const E=t=>"Object"===b(t)&&Object.keys(t).every(t=>!Number.isNaN(parseInt(t,10)));const T=(t,e)=>{if(!P(t)||!P(e))throw new Error(`Unsupported data types for deep equals: ${b(t)} & ${b(e)}`);if(b(t)!==b(e))return!1;if(y(t)&&y(e))return t===e;const n=(t,e)=>Object.entries(t).every(([t,n])=>T(e[t],n));return t&&e&&n(t,e)&&n(e,t)};const C=t=>{if(y(t))return t;if(O(t))return t.map(C);if(S(t)){const e=Object.keys(t).reduce((e,n)=>(e[n]=C(t[n]),e),{});const n=Object.create(Object.getPrototypeOf(t));return Object.assign(n,e)}throw new Error("Unsupported data type for clone: "+b(t))};const k=(t,e)=>t.reduce(([t,n],r,s)=>e(r,s)?[[...t,r],n]:[t,[...n,r]],[[],[]]);const D=(t,e)=>Object.fromEntries(Object.entries(t).map(t=>e(t)));const K=(t,e)=>D(t,([t,n])=>[t,e(n)]);const U=(t,e)=>Object.fromEntries(Object.entries(t).filter(([,t])=>e(t)));const B=(t,e)=>{if(y(t))return t;if(O(t))return t.map(t=>B(t,e));if(S(t)){const n=D(t,([t,n])=>[t,w.includes(t)?n:B(n,e)]);const r=j(t)?t._amount:v.MIN_NON_DUST_AMOUNT;const s=x(t)?t._owners:[e];return Object.assign(Object.assign({},n),{_amount:r,_owners:s})}throw new Error(`unsupported type ${b(t)} in setOwnersAndAmount`)};const N=(t,e,n,r)=>{if(y(t))return t;if(O(t))return t.map(t=>N(t,e,n,r));if(S(t)){t._rev=`${r}:${n}`;const s=e[n];return Object.entries(t).forEach(([n,i])=>{"object"==typeof s&&Object.keys(s).includes(n)&&(t[n]=N(i,e,s[n],r))}),t}throw new Error(`Unsupported type ${b(t)} in deep.updateRev`)};const A=t=>{if(y(t))return t;if(O(t))return t.map(t=>A(t));if(S(t))return t.__cls=t.constructor.toString(),Object.entries(t).forEach(([e,n])=>{t[e]=A(n)}),t;throw new Error(`Unsupported type ${b(t)} in deep.addClass`)};const R=(t,e)=>{if(y(t))return t;if(O(t))return t.map(t=>R(t,e));if(S(t))return t._id=!t._id||t._id.startsWith("__temp__")?t._rev:t._id,t._rootId=t._rootId||e,Object.entries(t).forEach(([n,r])=>{t[n]=R(r,e)}),t;throw new Error(`Unsupported type ${b(t)} in deep.addId`)};const H=t=>{if(y(t))return t;if(O(t))return t.map(t=>H(t));if(S(t)){const e=_();return t._id=t._id||e,t._rev=t._rev||e,Object.values(t).map(t=>H(t)),t}throw new Error(`Unsupported type ${b(t)} in addRandomId`)};const $=t=>{if(y(t))return t;if(O(t))return t.map(t=>$(t));if(S(t))return D(t,([t,e])=>"_owners"===t?[t,JSON.stringify(e)]:y(e)?[t,e]:[t,$(e)]);throw new Error(`Unexpected type ${b(t)} in stringifyOwners`)};const L=t=>I(t)?Object.assign(Object.assign({},t),{_owners:JSON.parse(t._owners).map(t=>new g(t))}):t;const M=t=>{if(y(t))return t;if(O(t)||S(t))return Object.entries(t).reduce((t,[e,n])=>{const r=M(n);return E(r)?Object.entries(r).forEach(([n,r])=>{t[`${e}_${n}`]=r}):t[e]=r,t},{});throw new Error(`Unsupported type ${b(t)} in encodeArraysAsObjects`)};const F=t=>{const e={[t._id]:Object.entries(t).reduce((t,[e,n])=>w.includes(e)?Object.assign(Object.assign({},t),{[e]:n}):y(n)?Object.assign(Object.assign({},t),{["__basic__"+e]:n}):Object.assign(Object.assign({},t),{[e]:n._id}),{})};return Object.values(t).filter(t=>!y(t)).reduce((t,e)=>Object.assign(Object.assign({},t),F(e)),e)};const V=t=>Object.fromEntries(Object.entries(t).filter(([t])=>!t.startsWith("__basic__")));const W=(t,e)=>Object.fromEntries(Object.entries(e).map(([e,n])=>{const r=t[e];var s;return n.__change=(s=r)?T(s,n)?"same":"diff":"new",[e,n]}));const J=(t,e)=>(t[e].__contains=Object.entries(t[e]).reduce((e,[n,r])=>["__contains"].concat(w).includes(n)?e:"__change"===n?"new"===r||"diff"===r||e:J(t,r)[r].__contains||e,!1),t);const z=t=>t.reduce((t,e,n)=>Object.assign(Object.assign({},t),{[e._id]:n}),{});const q=(t,e)=>t.map(t=>Object.entries(t).reduce((t,[n,r])=>{const s="string"==typeof r&&"undefined"!==b(e[r])?e[r]:r;return Object.assign(Object.assign({},t),{[n]:s})},{}));const Z=(t,e,n)=>{const[r,...s]=[e,...t].map((t,e)=>{const r=i(t,["_id","_rev","__change","__contains"]);return 0===e||e<=n.length?i(r,["__cls"]):r});return[r,...s.map(t=>Object.fromEntries(Object.entries(t).filter(([t,e])=>w.filter(t=>"__cls"!==t).includes(t)||"__cls"===t&&"string"==typeof e&&"function Object() { [native code] }"!==e||"number"==typeof e)))]};const G=(t,e)=>{const n=H(e);const r=n._id;const s=C(t);const i=C(n);A(s),A(i);const o=$(s);const c=$(i);const a=M(o);const u=M(c);const h=F(a);const d=F(u);const p=W(h,d);const l=K(p,V);const f=J(l,r);const v=f[r];delete v.__cls,delete f[r];const g=K(f,t=>t._rev);const _=U(f,t=>t.__contains||Object.values(v).includes(t._id));const w=Object.values(_);const[m,b]=k(w,t=>"new"===t.__change);const y=[...b,...m];const O=z(y);const S=q(y,O);const[x]=q([v],O);const I=b.map(t=>t._rev);const[j,...P]=Z(S,x,I);return[I,P.map(L).map(t=>Object.entries(t).reduce((t,[e,n])=>Object.assign(Object.assign({},t),{[e]:g[n]||n}),{})),j]};var Y=t=>({smartArgs:t.filter(t=>t._rev),dumbArgs:t.map(t=>t._rev?"__":t)});var Q=(t,e)=>{var n=0;return e.map(e=>"__"===e?t[n++]:e)};class X{constructor(t){this.db=t}static getUpdate(t,e,n,r){return o(this,void 0,void 0,(function*(){const[s,i]=C([t,n]);const o=Object.keys(n).length?Reflect.apply(n[r],n,t):null;const c=Object.keys(n).length?n:new e(...t);const{smartArgs:a,dumbArgs:u}=Y(s);const{smartArgs:h}=Y(t);const d=Object.assign(Object.assign(Object.assign({},a),{obj:i}),{_id:"index"});const p=Object.assign(Object.assign(Object.assign({},h),{obj:c}),{_id:"index"});"Object"===b(o)&&(p.res=o);const[l,f,v]=G(d,p);void 0!==f[0]&&(f[0].__index=v);const g=v.obj;return void 0!==f[g]&&(f[g].__args=u,r?f[g].__func=r:(f[g].__func="constructor",f[g].__cls=e.toString())),[l,f,c,h,o,v]}))}construct(t,e){return o(this,void 0,void 0,(function*(){const[n,r,s,i,,o]=yield X.getUpdate(e,t,{});const[c]=yield this.db.update(n,r);const[a]=c.split(":");const u=`${a}:${o.obj}`;return Object.entries(o).forEach(([t,e])=>{N("obj"===t?s:i[t],r,e,a)}),R([s,...i],u),s}))}call(t,e,n){return o(this,void 0,void 0,(function*(){const[r,s,,i,o,c]=yield X.getUpdate(n,null,t,e);const[a]=yield this.db.update(r,s);const[u]=a.split(":");Object.entries(c).forEach(([e,n])=>{"obj"===e&&N(t,s,n,u),N("res"===e?o:i[e],s,n,u)});const h=t._rootId||`${u}:${c.obj}`;return R([o,t,...i],h),o}))}get(t,e){return"function"==typeof t[e]?(...n)=>this.call(t,e,n):Reflect.get(t,e)}}function tt(t,e,n,r,s,i,o){try{var c=t[i](o);var a=c.value}catch(t){return void n(t)}c.done?e(a):Promise.resolve(a).then(r,s)}function et(t){return function(){var e=this,n=arguments;return new Promise((function(r,s){var i=t.apply(e,n);function o(t){tt(i,r,s,o,c,"next",t)}function c(t){tt(i,r,s,o,c,"throw",t)}o(void 0)}))}}function nt(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function rt(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function st(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?rt(Object(n),!0).forEach((function(e){nt(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):rt(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function it(t,e){if(null==t)return{};var n={};var r=Object.keys(t);var s,i;for(i=0;i<r.length;i++)s=r[i],e.indexOf(s)>=0||(n[s]=t[s]);return n}function ot(t,e){if(null==t)return{};var n=it(t,e);var r,s;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(s=0;s<i.length;s++)r=i[s],e.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(t,r)&&(n[r]=t[r])}return n}function ct(t,e){if("object"!=typeof t||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}function at(t){var e=ct(t,"string");return"symbol"==typeof e?e:String(e)}var{PublicKey:ut,Signature:ht,Script:dt,Opcode:pt}=r.default;function lt(t,e){var n=[];var r=0;for(;r<t.length;)n.push(t.slice(r,r+e)),r+=e;return n}class ft extends dt{static outScriptFromData(t){var{_owners:e,_amount:n,__vouts:r,__txId:s}=t,i=ot(t,["_owners","_amount","__vouts","__txId"]);var o=lt(Buffer.from(JSON.stringify(i)),v.SCRIPT_CHUNK_SIZE);return o[o.length-1].byteLength>=v.SCRIPT_CHUNK_SIZE&&lt(o.pop(),v.SCRIPT_CHUNK_SIZE).forEach(t=>{o.push(t)}),o.map(t=>({redeemScript:ft.getScript(t,e),chunk:t}))}static getScript(t,e){var n=new ft;return n.add("OP_1"),e.forEach(t=>n.add(t.toBuffer())),n.add("OP_".concat(e.length)),n.add("OP_CHECKMULTISIG"),n.add(t),n.add("OP_DROP"),n}getData(){return this.isDbDataScript()?JSON.parse(this.chunks[this.chunks.length-2].buf.toString()):{}}getPublicKeys(){if(this.isDbDataScript())return this.chunks.slice(1,this.chunks.length-4).map(t=>new ut(t.buf));throw new Error("Cannot get owners from non-data script")}isDbDataScript(){return!!(this.chunks.length>=5&&this.chunks[0].opcodenum===pt.OP_1&&this.chunks[1].buf&&[20,33].includes(this.chunks[1].buf.length)&&this.chunks[this.chunks.length-3].opcodenum===pt.OP_CHECKMULTISIG&&this.chunks[this.chunks.length-2].buf&&this.chunks[this.chunks.length-1].opcodenum===pt.OP_DROP)}static isP2shScript(t){return!(3!==t.chunks.length||t.chunks[0].opcodenum!==pt.OP_0||!t.chunks[1].buf||!t.chunks[2].buf)}static redeemScriptFromP2shScript(t){if(!this.isP2shScript(t))throw new Error("not a p2sh script");var e=new dt(t.chunks[2].buf);var n=new this;return n.chunks=e.chunks,n}static fromScript(t){var e=new dt(t);var n=new ft;return n.chunks=e.chunks,n}}function vt(t){return{writable:!0,value:t}}function gt(t,e,n){var{[t]:r}=n;return st({[e]:r},ot(n,[t].map(at)))}var{Address:_t,Transaction:wt,PublicKey:mt,Script:bt}=r.default;var yt=new Map;class Ot{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:v.CHAIN;var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:v.NETWORK;var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:v.WOC_API_KEY;this.chain=t,this.network=e,"BSV"===t&&(this.wocApiKey=n)}getBaseUrl(){if("BSV"===this.chain){var t="livenet"===this.network?"main":"test";return"https://api.whatsonchain.com/v1/bsv/".concat(t)}var e="livenet"===this.network?"rest":"trest";return"https://".concat(e,".bitcoin.com/v2")}getRequestHeaders(){return"BSV"===this.chain&&this.wocApiKey?{"woc-api-key":this.wocApiKey}:{}}unwrap(t){return et((function*(){try{return(yield t).data}catch(t){var{message:e,config:n,response:r}=t;var{url:s,method:i,data:o}=n;var c;try{c=JSON.parse(o)}catch(t){c=null}var a=c&&c.txhex?new wt(c.txhex):null;throw t.message="Communication Error\n\nmessage\t".concat(e,"\nrequest\t").concat(i," ").concat(s,"\n").concat(a?"transaction\t ".concat(JSON.stringify(a.toJSON(),null,2)):"post"!==i||a?"":"data\t".concat(o),"\n").concat(r?"response\t".concat(JSON.stringify(r.data)):""),t}}))()}get(t){var e=arguments,n=this;return et((function*(){var r=e.length>1&&void 0!==e[1]&&e[1]?"":n.getBaseUrl();return n.unwrap(s.default.get("".concat(r).concat(t),{headers:n.getRequestHeaders()}))}))()}post(t,e){var n=arguments,r=this;return et((function*(){var i=n.length>2&&void 0!==n[2]&&n[2]?"":r.getBaseUrl();return r.unwrap(s.default.post("".concat(i).concat(t),e,{headers:r.getRequestHeaders()}))}))()}getBalance(t){var e=this;return et((function*(){var n="/address/".concat(t.toString(),"/balance");var r="/address/details/".concat(t.toString());var s;switch(e.chain){case"BSV":return s=yield e.get(n),parseInt(s.confirmed,10)+parseInt(s.unconfirmed,10);case"BCH":return s=yield e.get(r),parseInt(s.balanceSat,10)+parseInt(s.unconfirmedBalanceSat,10);default:throw new Error("chain is not set in getBalance")}}))()}getTransaction(t){var e=this;return et((function*(){var n=yield e.getRawTransaction(t);return new wt(n)}))()}getTransactionWithSpendingData(t){var e=this;return et((function*(){if("testnet"===e.network&&"BSV"===e.chain)throw new Error("Restclient.getTransactionWithSpendingData is not supported on BSV testnet");switch([t]=t.split(":"),e.chain){case"BSV":var n="https://api.blockchair.com/bitcoin-sv/dashboards/transaction/".concat(t);var{data:r}=yield e.get(n,!0);var{transaction:s,inputs:i,outputs:o}=r[t];return{hex:"",txid:s.hash,hash:s.hash,version:s.version,size:s.size,locktime:s.lock_time,vin:i,vout:o.map(t=>({value:t.value,n:t.index,scriptPubKey:t.script_hex,spentTxId:t.spending_transaction_id,spentIndex:t.spending_index})),blockhash:"unknown",confirmations:"unknown",time:"unknown",blocktime:"unknown"};case"BCH":return e.get("/transaction/details/".concat(t));default:throw new Error("chain is not set in getTransactionWithSpendingData")}}))()}getRawTransaction(t){var e=this;return et((function*(){var[n]=t.split(":");var r=yt.get(n);if(r)return r;var i="livenet"===e.network?"main":"test";var o=yield e.unwrap(s.default.get("".concat(v.UN_P2SH_URL,"/tx/").concat(e.chain,"/").concat(i,"/").concat(n)));return yt.set(n,o),o}))()}sendTransaction(t){var e=arguments,n=this;return et((function*(){var r=e.length>1&&void 0!==e[1]&&e[1];var s;if("BSV"===n.chain)s=yield n.post("/tx/raw",{txhex:t.toString()});else{if("BCH"!==n.chain)throw new Error("chain is not set in sendTransaction");[s]=yield n.post("/rawtransactions/sendRawTransaction",{hexes:[t.toString()]})}if(r){var i=t.outputData.map(t=>{var{_owners:e}=t;if(void 0!==e){var n=e.map(t=>t.toString());return st(st({},t),{_owners:n})}return t});var o=JSON.stringify(i);var c=t.toJSON().inputs.map(t=>{var{prevTxId:e,outputIndex:n}=t;return"".concat(e,":").concat(n)});yield n.postOutputData({txId:s,outputData:o,inputs:c})}return s}))()}getUtxosFromAddress(t){var e=this;return et((function*(){var n=[];var r="";switch(e.chain){case"BSV":return n=yield e.get("/address/".concat(t.toString(),"/unspent")),Promise.all(n.map(t=>{var{tx_hash:e,tx_pos:n,value:r}=t;return{txId:e,vout:n,satoshis:r,amount:r/1e8}}).map(function(){var t=et((function*(t){var n=(yield e.getTransaction(t.txId)).outputs[t.vout];return t.scriptPubKey=n.script.toHex(),t}));return function(e){return t.apply(this,arguments)}}()));case"BCH":return({utxos:n,scriptPubKey:r}=yield e.get("/address/utxo/".concat(t.toString()))),n.map(t=>st({scriptPubKey:r},t)).map(t=>{var{txid:e}=t;return st({txId:e},ot(t,["txid"]))});default:throw new Error("chain is not set in getUtxosFromAddress")}}))()}getTxosFromOutputData(t){var e=this;return et((function*(){var n=t.map(t=>t.__txId);var r=[...new Set(n)];var s=new Map;return yield Promise.all(r.map(function(){var t=et((function*(t){return s.set(t,yield e.getTransaction(t))}));return function(e){return t.apply(this,arguments)}}())),t.map(t=>{var{outputs:e,blockheight:n,confirmations:r}=s.get(t.__txId)||{};return t.__vouts.map(s=>{var{_scriptBuffer:i,_satoshis:o}=e[s];return{txId:t.__txId,vout:s,scriptPubKey:i.toString("hex"),amount:parseFloat(o/1e8),satoshis:parseInt(o,10),height:n,confirmations:r}})})}))()}postOutputData(t){var e=this;return et((function*(){return e.post("".concat(v.UN_P2SH_URL,"/"),t,!0)}))()}getOutputData(t){var e=this;return et((function*(){return((yield e.get("".concat(v.UN_P2SH_URL,"/un-p2sh/").concat(t),!0))||[]).map(t=>t._owners?st(st({},t),{_owners:t._owners.map(t=>new mt(t))}):t)}))()}getOwnedRevs(t){var e=this;return et((function*(){return e.get("".concat(v.UN_P2SH_URL,"/txos/").concat(t.toString()),!0)}))()}getLatestRev(t){var e=this;return et((function*(){var[{rev:n}]=yield e.get("".concat(v.UN_P2SH_URL,"/get-rev/").concat(t),!0);return n}))()}setTxoSpent(t){var e=this;return et((function*(){var[n,r]=t.split(":");return e.post("".concat(v.UN_P2SH_URL,"/txos/set-spent/"),{txId:n,virtualIndex:parseInt(r,10)},!0)}))()}}const{Transaction:St,PublicKey:xt,Address:It,encoding:jt}=r.default;const{Output:Pt,Input:Et}=St;const{MultiSigScriptHash:Tt}=Et;const{BufferReader:Ct}=jt;const kt=t=>new Promise(e=>setTimeout(e,t));class Dt extends St{constructor(t,e,n){super(n),this._outputData=[],this.restClient=new Ot(t,e),this.feePerKb(v.DEFAULT_FEE),Object.defineProperty(this,"from",vt(this._from))}get chain(){return this.restClient.chain}get network(){return this.restClient.network}static fromRedeemScripts(t){const e=t.map(t=>t.chunks[t.chunks.length-2].buf);const n=Buffer.concat(e);const r=JSON.parse(n.toString());return Object.assign({_owners:t[0].getPublicKeys(),_amount:v.MIN_NON_DUST_AMOUNT},r)}static addVouts(t){let e=0;return t.map(t=>{const n=ft.outScriptFromData(t).length;return t.__vouts=Array(n).fill(e).map((t,e)=>t+e),e+=n,t})}get dataInputs(){const t=[];const e=function*(t){for(const e of t)yield e}(this.inputs);let n=e.next();for(;!n.done;){const r=n.value;const s=ft.fromScript(r._scriptBuffer);if(ft.isP2shScript(s)){let n=!1;const r=[ft.redeemScriptFromP2shScript(s)];for(;!n;)try{t.push(Dt.fromRedeemScripts(r)),n=!0}catch(t){const n=e.next();if(n.done)throw new Error("Could not compute data inputs");const s=n.value;const i=ft.fromScript(s._scriptBuffer);r.push(ft.redeemScriptFromP2shScript(i))}}n=e.next()}return t}set dataInputs(t){throw Error("dataTransaction.dataInputs cannot be set directly, use dataTransaction.from or dataTransaction.fromDataOutput")}getVirtualInputs(){return o(this,void 0,void 0,(function*(){if("BSV"===this.chain)return(yield Promise.all(this.inputs.map(t=>o(this,void 0,void 0,(function*(){const{outputIndex:e}=t;const n=t.prevTxId.toString("hex");const r=(yield Dt.fromTxId(n,this.chain,this.network)).outputs[e];return!!ft.fromScript(r._scriptBuffer).isDbDataScript()&&t}))))).filter(t=>!!t).map(t=>`${t.prevTxId.toString("hex")}:${t.outputIndex}`);if("BCH"===this.chain){const{dataInputs:t}=this;const e=Dt.addVouts(t);return Promise.all(e.map(t=>o(this,void 0,void 0,(function*(){const e=[];t.__vouts.forEach(t=>{e.push(this.inputs[t])});const n=e[0].prevTxId.toString("hex");const r=yield Dt.fromTxId(n,this.chain,this.network);yield r.fetchOutputData();const s=Dt.addVouts(r.outputData);const i=[];return s.forEach((t,n)=>{T(t.__vouts,e.map(t=>t.outputIndex))&&i.push(n)}),`${n}:${i[0]}`}))))}throw new Error("chain not set in getVirtualInputs")}))}fromMultiSig(t,e,n){const r=t.map(t=>gt("txId","txid",t));return super.from(r,e,n)}_from(t,e,n){const r=gt("txId","txid",t);return super.from(r,e,n)}fromDataOutput(t,e){const n=ft.outScriptFromData(e);const{_owners:r}=e;return n.forEach(({redeemScript:e},n)=>{const{scriptPubKey:s,satoshis:i,txId:o,vout:c}=t[n];const a=new Pt({script:new ft(s),satoshis:i});const u=new ft;const h=new Tt({prevTxId:o,output:a,outputIndex:c,script:u},r,1,null,e);this.addInput(h)}),this}get outputData(){if("BSV"===this.chain)return this.outputs.filter(t=>ft.fromScript(t._scriptBuffer).isDbDataScript()).map(t=>{const{chunks:e}=t._script||t.script;const{buf:n}=e[e.length-2];const r=JSON.parse(n.toString());const s=e.slice(1,e.length-4);return r._owners=s.map(t=>new xt(t.buf).toString()),r._amount=t._satoshis,r});if("BCH"===this.chain)return this._outputData;throw new Error("Chain not set in dataTransaction get outputdata")}set outputData(t){throw Error("dataTransaction.outputData cannot be set directly")}toData(t){if("BSV"===this.chain){const{_owners:e,_amount:n}=t,r=i(t,["_owners","_amount"]);const s=Buffer.from(JSON.stringify(r));const o=ft.getScript(s,e);const c=new Pt({script:o,satoshis:n});return this.addOutput(c),this.outputs.length-1}if("BCH"===this.chain){const e=ft.outScriptFromData(t);return this._outputData.push(t),e.forEach(({redeemScript:e})=>{const n=ft.buildScriptHashOut(e);const r=t._amount;const s=new Pt({script:n,satoshis:r});this.addOutput(s)}),this._outputData.length-1}throw new Error("chain not set in dataScript.toScriptOutput")}fetchOutputData(){return o(this,void 0,void 0,(function*(){if(this._outputData.length)return;const t=this.getTxId();"BSV"===this.chain?this._outputData=this.outputs.map(t=>{const e=ft.fromScript(t._scriptBuffer);const n=t._satoshis;if(e.isDbDataScript()){const t=e.getPublicKeys().map(t=>t.toString());return Object.assign(e.getData(),{_amount:n,_owners:t})}if(e.isPublicKeyHashOut()){const t=e.getPublicKeyHash();return{address:It.fromPublicKeyHash(t)}}throw new Error("Unrecognized output script "+e.toString())}):"BCH"===this.chain&&(this._outputData=yield this.restClient.getOutputData(t))}))}get prevObjectIds(){return this.inputs.map(t=>`${t.prevTxId.toString("hex")}:${t.outputIndex}`)}getTxId(){return new Ct(this._getHash()).readReverse().toString("hex")}getChangeIndex(){return this._changeIndex}static fromTxId(t,e,n){return o(this,void 0,void 0,(function*(){let r=null;const s=new Ot(e,n);try{r=yield s.getRawTransaction(t)}catch(e){yield kt(3e3),r=yield s.getRawTransaction(t)}const i=new Dt(e,n);return i.fromString(r),i}))}}const{PublicKey:Kt}=r.default;class Ut{constructor(t){this.wallet=t}get chain(){return this.wallet.chain}get network(){return this.wallet.network}put(t){return o(this,void 0,void 0,(function*(){return this.update([],t)}))}getOutputDataMap(t){return o(this,void 0,void 0,(function*(){const e=[...new Set(t)];const n=yield Promise.all(e.map(t=>o(this,void 0,void 0,(function*(){const e=yield this.wallet.restClient.getOutputData(t);let n=0;const r=e.map(e=>{const r=ft.outScriptFromData(e).length;const s=Array(r).fill(n).map((t,e)=>t+e);return n+=r,void 0!==e._owners&&(e._owners=e._owners.map(t=>new Kt(t))),Object.assign(Object.assign({},e),{__vouts:s,__txId:t})});return[t,r]}))));return new Map(n)}))}get(t){return o(this,void 0,void 0,(function*(){if("BSV"===this.chain){const e=t.map(t=>t.split(":")[0]);const n=[...new Set(e)];const r=yield Promise.all(n.map(t=>o(this,void 0,void 0,(function*(){return[t,yield this.wallet.restClient.getTransaction(t)]}))));const s=new Map(r);return Promise.all(t.map(t=>o(this,void 0,void 0,(function*(){const[e,n]=t.split(":");const r=s.get(e).outputs[parseInt(n,10)];const i=ft.fromScript(r.script);return Object.assign(i.getData(),{__txId:e,__vouts:[parseInt(n,10)],_owners:i.getPublicKeys(),_amount:Math.round(r.satoshis)})}))))}if("BCH"===this.chain){const e=t.map(t=>t.split(":")[0]);const n=yield this.getOutputDataMap(e);return t.map(t=>{const[e,r]=t.split(":");const s=n.get(e);if(!s||!Array.isArray(s))throw new Error("No data found.");return s[parseInt(r,10)]})}throw new Error("chain not set in db.get")}))}getUpdateTxBch(t,e){return o(this,void 0,void 0,(function*(){const n=new Dt(this.chain,this.network);const r=yield this.get(t);const s=yield this.wallet.restClient.getTxosFromOutputData(r);t.forEach((t,e)=>o(this,void 0,void 0,(function*(){n.fromDataOutput(s[e],r[e])})));const i=B(e,this.wallet.getPublicKey()).map(t=>n.toData(t));return{txId:yield this.wallet.fundAndSendTransaction(n,!0),virtualIndices:i}}))}getUpdateTxBsv(t,e){return o(this,void 0,void 0,(function*(){const n=new Dt(this.chain,this.network);(yield Promise.all(t.map(t=>o(this,void 0,void 0,(function*(){const[e,n]=t.split(":");const r=yield this.wallet.restClient.getTransaction(e);const{script:s,satoshis:i}=r.outputs[parseInt(n,10)];const o=ft.fromScript(s);return{output:{txId:e,outputIndex:parseInt(n,10),scriptPubKey:o,satoshis:Math.round(i)},publicKeys:o.getPublicKeys(),nr:1}}))))).forEach(({output:t,publicKeys:e,nr:r})=>{n.from(t,e,r)});const r=B(e,this.wallet.getPublicKey()).map(t=>n.toData(t));return{txId:yield this.wallet.fundAndSendTransaction(n,!0),virtualIndices:r}}))}update(t,e){return o(this,void 0,void 0,(function*(){if("BSV"===this.chain){const{txId:n,virtualIndices:r}=yield this.getUpdateTxBsv(t,e);return yield Promise.all(t.map(t=>o(this,void 0,void 0,(function*(){yield this.wallet.restClient.setTxoSpent(t)})))),r.map(t=>`${n}:${t}`)}if("BCH"===this.chain){const{txId:n,virtualIndices:r}=yield this.getUpdateTxBch(t,e);return t.forEach(t=>o(this,void 0,void 0,(function*(){yield this.wallet.restClient.setTxoSpent(t)}))),r.map(t=>`${n}:${t}`)}throw new Error("Chain not set in db.update "+this.chain)}))}}const{Mnemonic:Bt,HDPrivateKey:Nt,Address:At,PublicKey:Rt,PrivateKey:Ht}=r.default;class $t{constructor(t,e,n={}){const{path:r="m/44'/0'/0'/0",passphrase:s=""}=n;this.mnemonic=t,this.path=r,this.passphrase=s,this.restClient=e,this.utoxsSyncing=!1,this.hdPrivateKey=this.mnemonic.toHDPrivateKey(this.passphrase,v.NETWORK),this.path&&(this.hdPrivateKey=this.hdPrivateKey.derive(this.path)),this.utxos=[],this.syncUtxos()}get chain(){return this.restClient.chain}get network(){return this.restClient.network}getMnemonic(){return this.mnemonic}getPath(){return this.path}getUtxos(){return this.utxos}derive(t=0,e=!1){const n=new $t(this.mnemonic,this.restClient);return n.path=`${this.path}${this.path.length?"/":""}${t}${e?"'":""}`,n.hdPrivateKey=this.hdPrivateKey.derive(t,e),n}static getHdPrivateKey(){return new Nt}getPrivateKey(){return this.hdPrivateKey.privateKey}getPublicKey(){return this.hdPrivateKey.publicKey}getAddress(){return this.address=this.address||this.getPublicKey().toAddress(this.network),this.address}syncUtxos(){return o(this,void 0,void 0,(function*(){this.utoxsSyncing=!0,this.utxos=yield this.restClient.getUtxosFromAddress(this.getAddress()),this.utoxsSyncing=!1}))}waitUntilSynced(){return o(this,void 0,void 0,(function*(){for(;this.utoxsSyncing;)yield new Promise(t=>setTimeout(t,300))}))}getBalance(){return o(this,void 0,void 0,(function*(){const t=this.getAddress();return this.restClient.getBalance(t.toString())}))}getBalanceLowerBounds(){return o(this,void 0,void 0,(function*(){return yield this.waitUntilSynced(),this.utxos.reduce((t,e)=>t+e.satoshis,0)}))}getUtxosToSpend(t){return o(this,void 0,void 0,(function*(){yield this.waitUntilSynced();for(let t=this.utxos.length-1;t>0;t-=1){const e=Math.floor(Math.random()*(t+1));[this.utxos[t],this.utxos[e]]=[this.utxos[e],this.utxos[t]]}return this.getUtxosWithSatoshis(t)}))}getUtxosWithSatoshis(t){let e=0;const n=[];let r=0;for(;e<t&&r<this.utxos.length;)n.push(this.utxos[r]),e+=this.utxos[r].satoshis,r+=1;if(e>=t)return n;throw new Error(`Insufficient balance in address ${this.getAddress().toString()} on ${v.NETWORK} ${v.CHAIN}. Found ${e}, required ${t}.`)}fundAndSendTransaction(t,e=!1){return o(this,void 0,void 0,(function*(){t.feePerKb(v.DEFAULT_FEE);const n=t._estimateFee()+100;const r=yield this.getUtxosToSpend(t._getOutputAmount()-t._getInputAmount()+n);r.forEach(e=>t.from(e)),t.change(this.getAddress()),t.sign(this.getPrivateKey());const s=yield this.restClient.sendTransaction(t,e);this.utxos=this.utxos.filter(t=>!r.includes(t));const i=t.getChangeOutput();return i&&this.utxos.push({txId:t.getTxId(),vout:t.getChangeIndex(),satoshis:i.satoshis,amount:i.satoshis/1e8,scriptPubKey:i.script.toHex()}),s}))}send(t,e){return o(this,void 0,void 0,(function*(){const n=new Dt(this.chain,this.network).to(e,t);return this.fundAndSendTransaction(n)}))}}let Lt;if("undefined"==typeof window){const{LocalStorage:t}=require("node-localstorage");Lt=new t("./uls-scratch")}else void 0!==window.localStorage&&(Lt=window.localStorage);var Mt=Lt;class Ft{static serialize(t){return JSON.stringify(Object.entries(t))}static deserialize(t,e){const n=e?new e:{};return JSON.parse(t).forEach(([t,e])=>n[t]=e),n}static set(t){if(void 0===t._rev)throw new Error("Rev not set in Cache.set");const e="Object"===t.constructor.name?JSON.stringify({data:Ft.serialize(t)}):JSON.stringify({data:Ft.serialize(t),clazz:t.constructor.toString()});return Mt.setItem(t._rev,e),t._rev}static get(t){const{data:e,clazz:n}=JSON.parse(Mt.getItem(t||""))||{};if(e){const t="string"==typeof n?eval(`(${n})`):void 0;return this.deserialize(e,t)}return null}}class Vt{constructor(t,e){this.chain=t,this.network=e}get(t){return o(this,void 0,void 0,(function*(){const e=Ft.get(t);if(e)return e;const[n,r]=t.split(":");const s=yield Dt.fromTxId(n,this.chain,this.network);yield s.fetchOutputData();const i=s.outputData;const{__index:c}=i[0];const{__cls:a,__func:u,__args:h}=i[c.obj];const d=yield s.getVirtualInputs();const p=yield Promise.all(Object.values(c).map(t=>o(this,void 0,void 0,(function*(){return d[t]?this.get(d[t]):Promise.resolve({})}))));const l=Object.keys(c).map((t,e)=>[t,p[e]]);const f=Object.fromEntries(l);let v=f.obj;delete f.obj;const g=Object.entries(f).reduce((t,[e,n])=>(Number.isNaN(parseInt(e,10))||(t[parseInt(e,10)]=n),t),[]);const _=Q(g,h);let w;if("constructor"===u){const t=eval(`(${a})`);v=new t(..._)}else{const t=v[u].bind(v);w=Reflect.apply(t,v,_)}const m=c;Object.entries(m).forEach(([t,e])=>{"obj"===t&&N(v,i,e,n),N("res"===t?w:g[t],i,e,n)});const b=v._rootId||`${n}:${m.obj}`;return R([v,w,...g],b),[v,w,...g].filter(t=>!y(t)).map(Ft.set),[...g,v,w][r]}))}}const{Mnemonic:Wt,PublicKey:Jt}=r.default;class zt{constructor(t){const{seed:e,chain:n=v.CHAIN,network:r=v.NETWORK,mnemonic:s=new Wt(e),wocApiKey:i,path:o="m/44'/0'/0'/0",passphrase:c=""}=t;this.restClient=new Ot(n,r,i);const{db:a=new Ut(new $t(s,this.restClient,{path:o,passphrase:c}))}=t;this.db=a,this.reader=new Vt(this.chain,this.network)}get chain(){return this.db.chain}get network(){return this.db.network}static parseContract(t){if("string"==typeof t){const e=t.startsWith("export ")?t.slice(7):t;const n=e.startsWith("default ")?e.slice(8):e;return eval(`(${n})`)}return t}new(t,e){return o(this,void 0,void 0,(function*(){const n=new X(this.db);const r=zt.parseContract(t);const s=new Proxy(r,n);const i=yield new s(...e);return new Proxy(i,n)}))}sync(t){return o(this,void 0,void 0,(function*(){const e=yield this.reader.get(t);const n=new X(this.db);return new Proxy(e,n)}))}getOwnedRevs(t=this.db.wallet.getPublicKey()){return o(this,void 0,void 0,(function*(){return this.db.wallet.restClient.getOwnedRevs(t)}))}getRevs(t=this.db.wallet.getPublicKey()){return o(this,void 0,void 0,(function*(){return(yield this.db.wallet.restClient.getOwnedRevs(t)).map(({txId:t,virtualIndex:e})=>`${t}:${e}`)}))}getLatestRev(t){return o(this,void 0,void 0,(function*(){return this.db.wallet.restClient.getLatestRev(t)}))}}module.exports=zt;
