"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("bitcoinsource");var e=require("axios");function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=n(t);var i=n(e);
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function r(t,e){var n={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(n[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(s=Object.getOwnPropertySymbols(t);i<s.length;i++)e.indexOf(s[i])<0&&Object.prototype.propertyIsEnumerable.call(t,s[i])&&(n[s[i]]=t[s[i]])}return n}function o(t,e,n,s){return new(n||(n=Promise))((function(i,r){function o(t){try{a(s.next(t))}catch(t){r(t)}}function c(t){try{a(s.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,c)}a((s=s.apply(t,e||[])).next())}))}const c=process.env.BC_CHAIN||"BSV";const a=process.env.BC_NETWORK||"testnet";const u=process.env.BC_WOC_API_KEY||void 0;const d=parseInt(process.env.BC_DUST_LIMIT,10)||4e3;const h=parseInt(process.env.BC_DEFAULT_FEE,10)||("BSV"===c?500:2500);const p=parseInt(process.env.BC_SCRIPT_CHUNK_SIZE,10)||479;let l;let f;process.env.BC_BBS_URL?(f="http://"+process.env.BC_BBS_URL,l="ws://"+process.env.BC_BBS_URL):(f="https://bbs.bitcoincomputer.io",l="wss://bbs.bitcoincomputer.io");var g={CHAIN:c,NETWORK:a,WOC_API_KEY:u,MIN_NON_DUST_AMOUNT:d,SCRIPT_CHUNK_SIZE:p,UN_P2SH_URL:f,WS_URL:l,DEFAULT_FEE:h};s.default.versionGuard=()=>!0,s.default.Networks.defaultNetwork=s.default.Networks[g.NETWORK];const{PublicKey:w}=s.default;const _=()=>"__temp__:"+Math.random();const v=["_id","_rev","_owners","_amount","__vouts","__txId","__cls","__func","__index","__args"];const m=t=>Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1];const b=t=>"object"==typeof t?m(t):m(t).toLowerCase();const y=t=>["number","string","boolean","undefined","Null"].includes(b(t));const O=t=>"Array"===b(t);const S=t=>"Object"===b(t);const x=t=>!!t._owners&&"object"==typeof t._owners;const I=t=>!!t._owners&&"string"==typeof t._owners;const j=t=>!!t._amount;const P=t=>y(t)||["Array","Object"].includes(b(t));const E=t=>"Object"===b(t)&&Object.keys(t).every(t=>!Number.isNaN(parseInt(t,10)));const T=(t,e)=>{if(!P(t)||!P(e))throw new Error(`Unsupported data types for deep equals: ${b(t)} & ${b(e)}`);if(b(t)!==b(e))return!1;if(y(t)&&y(e))return t===e;const n=(t,e)=>Object.entries(t).every(([t,n])=>T(e[t],n));return t&&e&&n(t,e)&&n(e,t)};const C=t=>{if(y(t))return t;if(O(t))return t.map(C);if(S(t)){const e=Object.keys(t).reduce((e,n)=>(e[n]=C(t[n]),e),{});const n=Object.create(Object.getPrototypeOf(t));return Object.assign(n,e)}throw new Error("Unsupported data type for clone: "+b(t))};const B=(t,e)=>t.reduce(([t,n],s,i)=>e(s,i)?[[...t,s],n]:[t,[...n,s]],[[],[]]);const N=(t,e)=>Object.fromEntries(Object.entries(t).map(t=>e(t)));const k=(t,e)=>N(t,([t,n])=>[t,e(n)]);const U=(t,e)=>Object.fromEntries(Object.entries(t).filter(([,t])=>e(t)));const $=(t,e)=>{if(y(t))return t;if(O(t))return t.map(t=>$(t,e));if(S(t)){const n=N(t,([t,n])=>[t,v.includes(t)?n:$(n,e)]);const s=j(t)?t._amount:g.MIN_NON_DUST_AMOUNT;const i=x(t)?t._owners:[e];return Object.assign(Object.assign({},n),{_amount:s,_owners:i})}throw new Error(`unsupported type ${b(t)} in setOwnersAndAmount`)};const K=(t,e,n,s)=>{if(y(t))return t;if(O(t))return t.map(t=>K(t,e,n,s));if(S(t)){t._rev=`${s}:${n}`;const i=e[n];return Object.entries(t).forEach(([n,r])=>{"object"==typeof i&&Object.keys(i).includes(n)&&(t[n]=K(r,e,i[n],s))}),t}throw new Error(`Unsupported type ${b(t)} in deep.updateRev`)};const D=t=>{if(y(t))return t;if(O(t))return t.map(t=>D(t));if(S(t))return t.__cls=t.constructor.toString(),Object.entries(t).forEach(([e,n])=>{t[e]=D(n)}),t;throw new Error(`Unsupported type ${b(t)} in deep.addClass`)};const A=(t,e)=>{if(y(t))return t;if(O(t))return t.map(t=>A(t,e));if(S(t))return t._id=!t._id||t._id.startsWith("__temp__")?t._rev:t._id,t._rootId=t._rootId||e,Object.entries(t).forEach(([n,s])=>{t[n]=A(s,e)}),t;throw new Error(`Unsupported type ${b(t)} in deep.addId`)};const R=t=>{if(y(t))return t;if(O(t))return t.map(t=>R(t));if(S(t)){const e=_();return t._id=t._id||e,t._rev=t._rev||e,Object.values(t).map(t=>R(t)),t}throw new Error(`Unsupported type ${b(t)} in addRandomId`)};const H=t=>{if(y(t))return t;if(O(t))return t.map(t=>H(t));if(S(t))return N(t,([t,e])=>"_owners"===t?[t,JSON.stringify(e)]:y(e)?[t,e]:[t,H(e)]);throw new Error(`Unexpected type ${b(t)} in stringifyOwners`)};const M=t=>I(t)?Object.assign(Object.assign({},t),{_owners:JSON.parse(t._owners).map(t=>new w(t))}):t;const L=t=>{if(y(t))return t;if(O(t)||S(t))return Object.entries(t).reduce((t,[e,n])=>{const s=L(n);return E(s)?Object.entries(s).forEach(([n,s])=>{t[`${e}_${n}`]=s}):t[e]=s,t},{});throw new Error(`Unsupported type ${b(t)} in encodeArraysAsObjects`)};const z=t=>{const e={[t._id]:Object.entries(t).reduce((t,[e,n])=>v.includes(e)?Object.assign(Object.assign({},t),{[e]:n}):y(n)?Object.assign(Object.assign({},t),{["__basic__"+e]:n}):Object.assign(Object.assign({},t),{[e]:n._id}),{})};return Object.values(t).filter(t=>!y(t)).reduce((t,e)=>Object.assign(Object.assign({},t),z(e)),e)};const F=t=>Object.fromEntries(Object.entries(t).filter(([t])=>!t.startsWith("__basic__")));const V=(t,e)=>Object.fromEntries(Object.entries(e).map(([e,n])=>{const s=t[e];var i;return n.__change=(i=s)?T(i,n)?"same":"diff":"new",[e,n]}));const W=(t,e)=>(t[e].__contains=Object.entries(t[e]).reduce((e,[n,s])=>["__contains"].concat(v).includes(n)?e:"__change"===n?"new"===s||"diff"===s||e:W(t,s)[s].__contains||e,!1),t);const J=t=>t.reduce((t,e,n)=>Object.assign(Object.assign({},t),{[e._id]:n}),{});const q=(t,e)=>t.map(t=>Object.entries(t).reduce((t,[n,s])=>{const i="string"==typeof s&&"undefined"!==b(e[s])?e[s]:s;return Object.assign(Object.assign({},t),{[n]:i})},{}));const Z=(t,e,n)=>{const[s,...i]=[e,...t].map((t,e)=>{const s=r(t,["_id","_rev","__change","__contains"]);return 0===e||e<=n.length?r(s,["__cls"]):s});return[s,...i.map(t=>Object.fromEntries(Object.entries(t).filter(([t,e])=>v.filter(t=>"__cls"!==t).includes(t)||"__cls"===t&&"string"==typeof e&&"function Object() { [native code] }"!==e||"number"==typeof e)))]};const G=(t,e)=>{const n=R(e);const s=n._id;const i=C(t);const r=C(n);D(i),D(r);const o=H(i);const c=H(r);const a=L(o);const u=L(c);const d=z(a);const h=z(u);const p=V(d,h);const l=k(p,F);const f=W(l,s);const g=f[s];delete g.__cls,delete f[s];const w=k(f,t=>t._rev);const _=U(f,t=>t.__contains||Object.values(g).includes(t._id));const v=Object.values(_);const[m,b]=B(v,t=>"new"===t.__change);const y=[...b,...m];const O=J(y);const S=q(y,O);const[x]=q([g],O);const I=b.map(t=>t._rev);const[j,...P]=Z(S,x,I);return[I,P.map(M).map(t=>Object.entries(t).reduce((t,[e,n])=>Object.assign(Object.assign({},t),{[e]:w[n]||n}),{})),j]};const Y=t=>({smartArgs:t.filter(t=>t._rev),dumbArgs:t.map(t=>t._rev?"__":t)});const Q=(t,e)=>{let n=0;return e.map(e=>"__"===e?t[n++]:e)};const X=t=>{if("string"!=typeof t||0===t.length)throw new Error("Please enter a valid id or revision");const[e,n]=t.split(":");if(!e||!n)throw new Error("Please enter a valid id or revision of the form <transaction id>:<output number>");if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid Transaction ID");if(Number.isNaN(Number(n)))throw new Error("Invalid Number")};class tt{constructor(t){this.db=t}static getUpdate(t,e,n,s){return o(this,void 0,void 0,(function*(){const[i,r]=C([t,n]);const o=Object.keys(n).length?Reflect.apply(n[s],n,t):null;const c=Object.keys(n).length?n:new e(...t);const{smartArgs:a,dumbArgs:u}=Y(i);const{smartArgs:d}=Y(t);const h=Object.assign(Object.assign(Object.assign({},a),{obj:r}),{_id:"index"});const p=Object.assign(Object.assign(Object.assign({},d),{obj:c}),{_id:"index"});"Object"===b(o)&&(p.res=o);const[l,f,g]=G(h,p);void 0!==f[0]&&(f[0].__index=g);const w=g.obj;return void 0!==f[w]&&(f[w].__args=u,s?f[w].__func=s:(f[w].__func="constructor",f[w].__cls=e.toString())),[l,f,c,d,o,g]}))}construct(t,e){return o(this,void 0,void 0,(function*(){const[n,s,i,r,,o]=yield tt.getUpdate(e,t,{});const[c]=yield this.db.update(n,s);const[a]=c.split(":");const u=`${a}:${o.obj}`;return Object.entries(o).forEach(([t,e])=>{K("obj"===t?i:r[t],s,e,a)}),A([i,...r],u),i}))}call(t,e,n){return o(this,void 0,void 0,(function*(){const[s,i,,r,o,c]=yield tt.getUpdate(n,null,t,e);const[a]=yield this.db.update(s,i);const[u]=a.split(":");Object.entries(c).forEach(([e,n])=>{"obj"===e&&K(t,i,n,u),K("res"===e?o:r[e],i,n,u)});const d=t._rootId||`${u}:${c.obj}`;return A([o,t,...r],d),o}))}get(t,e){return"function"==typeof t[e]?(...n)=>this.call(t,e,n):Reflect.get(t,e)}}const{PublicKey:et,Script:nt,Opcode:st}=s.default;function it(t,e){const n=[];let s=0;for(;s<t.length;)n.push(t.slice(s,s+e)),s+=e;return n}class rt extends nt{static outScriptFromData(t){const{_owners:e,_amount:n,__vouts:s,__txId:i}=t,o=r(t,["_owners","_amount","__vouts","__txId"]);const c=it(Buffer.from(JSON.stringify(o)),g.SCRIPT_CHUNK_SIZE);return c[c.length-1].byteLength>=g.SCRIPT_CHUNK_SIZE&&it(c.pop(),g.SCRIPT_CHUNK_SIZE).forEach(t=>{c.push(t)}),c.map(t=>({redeemScript:rt.getScript(t,e),chunk:t}))}static getScript(t,e){const n=new rt;return n.add("OP_1"),e.forEach(t=>n.add(t.toBuffer())),n.add("OP_"+e.length),n.add("OP_CHECKMULTISIG"),n.add(t),n.add("OP_DROP"),n}getData(){return this.isDbDataScript()?JSON.parse(this.chunks[this.chunks.length-2].buf.toString()):{}}getPublicKeys(){if(this.isDbDataScript())return this.chunks.slice(1,this.chunks.length-4).map(t=>new et(t.buf));throw new Error("Cannot get owners from non-data script")}isDbDataScript(){return!!(this.chunks.length>=5&&this.chunks[0].opcodenum===st.OP_1&&this.chunks[1].buf&&[20,33].includes(this.chunks[1].buf.length)&&this.chunks[this.chunks.length-3].opcodenum===st.OP_CHECKMULTISIG&&this.chunks[this.chunks.length-2].buf&&this.chunks[this.chunks.length-1].opcodenum===st.OP_DROP)}static isP2shScript(t){return!(3!==t.chunks.length||t.chunks[0].opcodenum!==st.OP_0||!t.chunks[1].buf||!t.chunks[2].buf)}static redeemScriptFromP2shScript(t){if(!this.isP2shScript(t))throw new Error("not a p2sh script");const e=new nt(t.chunks[2].buf);const n=new this;return n.chunks=e.chunks,n}static fromScript(t){const e=new nt(t);const n=new rt;return n.chunks=e.chunks,n}}const{Address:ot,Transaction:ct,PublicKey:at}=s.default;const ut=new Map;class dt{constructor(t=g.CHAIN,e=g.NETWORK,n=g.WOC_API_KEY){this.chain=t,this.network=e,"BSV"===t&&(this.wocApiKey=n)}getBaseUrl(){return"BSV"===this.chain?"https://api.whatsonchain.com/v1/bsv/"+("livenet"===this.network?"main":"test"):`https://${"livenet"===this.network?"rest":"trest"}.bitcoin.com/v2`}getRequestHeaders(){return"BSV"===this.chain&&this.wocApiKey?{"woc-api-key":this.wocApiKey}:{}}unwrap(t){return o(this,void 0,void 0,(function*(){try{return(yield t).data}catch(t){const{message:e,config:n,response:s}=t;const{url:i,method:r,data:o}=n;let c;try{c=JSON.parse(o)}catch(t){c=null}const a=c&&c.txhex?new ct(c.txhex):null;throw t.message=`\n        Communication Error\n        message\t${e}\n        request\t${r} ${i}\n        ${a?"transaction\t "+JSON.stringify(a.toJSON(),null,2):"post"!==r||a?"":"data\t"+o}\n        ${s?"response\t"+JSON.stringify(s.data):""}`,t}}))}get(t,e=!1){return o(this,void 0,void 0,(function*(){const n=e?"":this.getBaseUrl();return this.unwrap(i.default.get(`${n}${t}`,{headers:this.getRequestHeaders()}))}))}post(t,e,n=!1){return o(this,void 0,void 0,(function*(){const s=n?"":this.getBaseUrl();return this.unwrap(i.default.post(`${s}${t}`,e,{headers:this.getRequestHeaders()}))}))}getBalance(t){return o(this,void 0,void 0,(function*(){const e=`/address/${t.toString()}/balance`;const n="/address/details/"+t.toString();let s;switch(this.chain){case"BSV":return s=yield this.get(e),parseInt(s.confirmed,10)+parseInt(s.unconfirmed,10);case"BCH":return s=yield this.get(n),parseInt(s.balanceSat,10)+parseInt(s.unconfirmedBalanceSat,10);default:throw new Error("chain is not set in getBalance")}}))}getTransaction(t){return o(this,void 0,void 0,(function*(){const e=yield this.getRawTransaction(t);return new ct(e)}))}getTransactionWithSpendingData(t){return o(this,void 0,void 0,(function*(){if("testnet"===this.network&&"BSV"===this.chain)throw new Error("Restclient.getTransactionWithSpendingData is not supported on BSV testnet");const[e]=t.split(":");switch(this.chain){case"BSV":{const t="https://api.blockchair.com/bitcoin-sv/dashboards/transaction/"+e;const{data:n}=yield this.get(t,!0);const{transaction:s,inputs:i,outputs:r}=n[e];return{hex:"",txid:s.hash,hash:s.hash,version:s.version,size:s.size,locktime:s.lock_time,vin:i,vout:r.map(t=>({value:t.value,n:t.index,scriptPubKey:t.script_hex,spentTxId:t.spending_transaction_id,spentIndex:t.spending_index})),blockhash:"unknown",confirmations:"unknown",time:"unknown",blocktime:"unknown"}}case"BCH":return this.get("/transaction/details/"+e);default:throw new Error("chain is not set in getTransactionWithSpendingData")}}))}getRawTransaction(t){return o(this,void 0,void 0,(function*(){const[e]=t.split(":");const n=ut.get(e);if(n)return n;const s="livenet"===this.network?"main":"test";const r=yield this.unwrap(i.default.get(`${g.UN_P2SH_URL}/tx/${this.chain}/${s}/${e}`));return ut.set(e,r),r}))}sendTransaction(t,e=!1){return o(this,void 0,void 0,(function*(){let n;if("BSV"===this.chain)n=yield this.post("/tx/raw",{txhex:t.toString()});else{if("BCH"!==this.chain)throw new Error("chain is not set in sendTransaction");n=yield this.post("/rawtransactions/sendRawTransaction",{hexes:[t.toString()]})[0]}if(e){const e=t.outputData.map(t=>{const{_owners:e}=t;if(void 0!==e){const n=e.map(t=>t.toString());return Object.assign(Object.assign({},t),{_owners:n})}return t});const s=JSON.stringify(e);const i=t.toJSON().inputs.map(({prevTxId:t,outputIndex:e})=>`${t}:${e}`);yield this.postOutputData({txId:n,outputData:s,inputs:i})}return n}))}getUtxosFromAddress(t){return o(this,void 0,void 0,(function*(){let e=[];let n="";switch(this.chain){case"BSV":return e=yield this.get(`/address/${t.toString()}/unspent`),Promise.all(e.map(({tx_hash:t,tx_pos:e,value:n})=>({txId:t,vout:e,satoshis:n,amount:n/1e8})).map(t=>o(this,void 0,void 0,(function*(){const e=(yield this.getTransaction(t.txId)).outputs[t.vout];return Object.assign(Object.assign({},t),{scriptPubKey:e.script.toHex()})}))));case"BCH":return({utxos:e,scriptPubKey:n}=yield this.get("/address/utxo/"+t.toString())),e.map(t=>Object.assign({scriptPubKey:n},t)).map(t=>{var{txid:e}=t,n=r(t,["txid"]);return Object.assign({txId:e},n)});default:throw new Error("chain is not set in getUtxosFromAddress")}}))}getTxosFromOutputData(t){return o(this,void 0,void 0,(function*(){const e=t.map(t=>t.__txId);const n=[...new Set(e)];const s=new Map;return yield Promise.all(n.map(t=>o(this,void 0,void 0,(function*(){return s.set(t,yield this.getTransaction(t))})))),t.map(t=>{const{outputs:e,blockheight:n,confirmations:i}=s.get(t.__txId)||{};return t.__vouts.map(s=>{const{_scriptBuffer:r,_satoshis:o}=e[s];return{txId:t.__txId,vout:s,scriptPubKey:r.toString("hex"),amount:o/1e8,satoshis:parseInt(o,10),height:n,confirmations:i}})})}))}postOutputData(t){return o(this,void 0,void 0,(function*(){return this.post(g.UN_P2SH_URL+"/",t,!0)}))}getOutputData(t){return o(this,void 0,void 0,(function*(){return((yield this.get(`${g.UN_P2SH_URL}/un-p2sh/${t}`,!0))||[]).map(t=>t._owners?Object.assign(Object.assign({},t),{_owners:t._owners.map(t=>new at(t))}):t)}))}getOwnedRevs(t){return o(this,void 0,void 0,(function*(){return this.get(`${g.UN_P2SH_URL}/txos/${t.toString()}`,!0)}))}getLatestRev(t){return o(this,void 0,void 0,(function*(){const[{rev:e}]=yield this.get(`${g.UN_P2SH_URL}/get-rev/${t}`,!0);return e}))}setTxoSpent(t){return o(this,void 0,void 0,(function*(){const[e,n]=t.split(":");return this.post(g.UN_P2SH_URL+"/txos/set-spent/",{txId:e,virtualIndex:parseInt(n,10)},!0)}))}}function ht(t){return{writable:!0,value:t}}function pt(t,e,n){var s=t,i=n[s],o=r(n,["symbol"==typeof s?s:s+""]);return Object.assign({[e]:i},o)}const{Transaction:lt,PublicKey:ft,Address:gt,encoding:wt}=s.default;const{Output:_t,Input:vt}=lt;const{MultiSigScriptHash:mt}=vt;const{BufferReader:bt}=wt;const yt=t=>new Promise(e=>setTimeout(e,t));class Ot extends lt{constructor(t,e,n){super(n),this._outputData=[],this.restClient=new dt(t,e),this.feePerKb(g.DEFAULT_FEE),Object.defineProperty(this,"from",ht(this._from))}get chain(){return this.restClient.chain}get network(){return this.restClient.network}static fromRedeemScripts(t){const e=t.map(t=>t.chunks[t.chunks.length-2].buf);const n=Buffer.concat(e);const s=JSON.parse(n.toString());return Object.assign({_owners:t[0].getPublicKeys(),_amount:g.MIN_NON_DUST_AMOUNT},s)}static addVouts(t){let e=0;return t.map(t=>{const n=rt.outScriptFromData(t).length;const s=Object.assign(Object.assign({},t),{__vouts:[]});return s.__vouts=Array(n).fill(e).map((t,e)=>t+e),e+=n,s})}get dataInputs(){const t=[];const e=function*(t){for(const e of t)yield e}(this.inputs);let n=e.next();for(;!n.done;){const s=n.value;const i=rt.fromScript(s._scriptBuffer);if(rt.isP2shScript(i)){let n=!1;const s=[rt.redeemScriptFromP2shScript(i)];for(;!n;)try{t.push(Ot.fromRedeemScripts(s)),n=!0}catch(t){const n=e.next();if(n.done)throw new Error("Could not compute data inputs");const i=n.value;const r=rt.fromScript(i._scriptBuffer);s.push(rt.redeemScriptFromP2shScript(r))}}n=e.next()}return t}set dataInputs(t){throw Error("dataTransaction.dataInputs cannot be set directly, use dataTransaction.from or dataTransaction.fromDataOutput")}getVirtualInputs(){return o(this,void 0,void 0,(function*(){if("BSV"===this.chain)return(yield Promise.all(this.inputs.map(t=>o(this,void 0,void 0,(function*(){const{outputIndex:e}=t;const n=t.prevTxId.toString("hex");const s=(yield Ot.fromTxId(n,this.chain,this.network)).outputs[e];return!!rt.fromScript(s._scriptBuffer).isDbDataScript()&&t}))))).filter(t=>!!t).map(t=>`${t.prevTxId.toString("hex")}:${t.outputIndex}`);if("BCH"===this.chain){const{dataInputs:t}=this;const e=Ot.addVouts(t);return Promise.all(e.map(t=>o(this,void 0,void 0,(function*(){const e=[];t.__vouts.forEach(t=>{e.push(this.inputs[t])});const n=e[0].prevTxId.toString("hex");const s=yield Ot.fromTxId(n,this.chain,this.network);yield s.fetchOutputData();const i=Ot.addVouts(s.outputData);const r=[];return i.forEach((t,n)=>{T(t.__vouts,e.map(t=>t.outputIndex))&&r.push(n)}),`${n}:${r[0]}`}))))}throw new Error("chain not set in getVirtualInputs")}))}fromMultiSig(t,e,n){const s=t.map(t=>pt("txId","txid",t));return super.from(s,e,n)}_from(t,e,n){const s=pt("txId","txid",t);return super.from(s,e,n)}fromDataOutput(t,e){const n=rt.outScriptFromData(e);const{_owners:s}=e;return n.forEach(({redeemScript:e},n)=>{const{scriptPubKey:i,satoshis:r,txId:o,vout:c}=t[n];const a=new _t({script:new rt(i),satoshis:r});const u=new rt;const d=new mt({prevTxId:o,output:a,outputIndex:c,script:u},s,1,null,e);this.addInput(d)}),this}get outputData(){if("BSV"===this.chain)return this.outputs.filter(t=>rt.fromScript(t._scriptBuffer).isDbDataScript()).map(t=>{const{chunks:e}=t._script||t.script;const{buf:n}=e[e.length-2];const s=JSON.parse(n.toString());const i=e.slice(1,e.length-4);return s._owners=i.map(t=>new ft(t.buf).toString()),s._amount=t._satoshis,s});if("BCH"===this.chain)return this._outputData;throw new Error("Chain not set in dataTransaction get outputdata")}set outputData(t){throw Error("dataTransaction.outputData cannot be set directly")}toData(t){if("BSV"===this.chain){const{_owners:e,_amount:n}=t,s=r(t,["_owners","_amount"]);const i=Buffer.from(JSON.stringify(s));const o=rt.getScript(i,e);const c=new _t({script:o,satoshis:n});return this.addOutput(c),this.outputs.length-1}if("BCH"===this.chain){const e=rt.outScriptFromData(t);return this._outputData.push(t),e.forEach(({redeemScript:e})=>{const n=rt.buildScriptHashOut(e);const s=t._amount;const i=new _t({script:n,satoshis:s});this.addOutput(i)}),this._outputData.length-1}throw new Error("chain not set in dataScript.toScriptOutput")}fetchOutputData(){return o(this,void 0,void 0,(function*(){if(this._outputData.length)return;const t=this.getTxId();"BSV"===this.chain?this._outputData=this.outputs.map(t=>{const e=rt.fromScript(t._scriptBuffer);const n=t._satoshis;if(e.isDbDataScript()){const t=e.getPublicKeys().map(t=>t.toString());return Object.assign(e.getData(),{_amount:n,_owners:t})}if(e.isPublicKeyHashOut()){const t=e.getPublicKeyHash();return{address:gt.fromPublicKeyHash(t)}}throw new Error("Unrecognized output script "+e.toString())}):"BCH"===this.chain&&(this._outputData=yield this.restClient.getOutputData(t))}))}get prevObjectIds(){return this.inputs.map(t=>`${t.prevTxId.toString("hex")}:${t.outputIndex}`)}getTxId(){return new bt(this._getHash()).readReverse().toString("hex")}getChangeIndex(){return this._changeIndex}static fromTxId(t,e,n){return o(this,void 0,void 0,(function*(){let s=null;const i=new dt(e,n);try{s=yield i.getRawTransaction(t)}catch(e){yield yt(3e3),s=yield i.getRawTransaction(t)}const r=new Ot(e,n);return r.fromString(s),r}))}}const{PublicKey:St}=s.default;class xt{constructor(t){this.wallet=t}get chain(){return this.wallet.chain}get network(){return this.wallet.network}put(t){return o(this,void 0,void 0,(function*(){return this.update([],t)}))}getOutputDataMap(t){return o(this,void 0,void 0,(function*(){const e=[...new Set(t)];const n=yield Promise.all(e.map(t=>o(this,void 0,void 0,(function*(){const e=yield this.wallet.restClient.getOutputData(t);let n=0;const s=e.map(e=>{const s=Object.assign({},e);const i=rt.outScriptFromData(s).length;const r=Array(i).fill(n).map((t,e)=>t+e);return n+=i,void 0!==s._owners&&(s._owners=s._owners.map(t=>new St(t))),Object.assign(Object.assign({},s),{__vouts:r,__txId:t})});return[t,s]}))));return new Map(n)}))}get(t){return o(this,void 0,void 0,(function*(){if("BSV"===this.chain){const e=t.map(t=>t.split(":")[0]);const n=[...new Set(e)];const s=yield Promise.all(n.map(t=>o(this,void 0,void 0,(function*(){return[t,yield this.wallet.restClient.getTransaction(t)]}))));const i=new Map(s);return Promise.all(t.map(t=>o(this,void 0,void 0,(function*(){const[e,n]=t.split(":");const s=i.get(e).outputs[parseInt(n,10)];const r=rt.fromScript(s.script);return Object.assign(r.getData(),{__txId:e,__vouts:[parseInt(n,10)],_owners:r.getPublicKeys(),_amount:Math.round(s.satoshis)})}))))}if("BCH"===this.chain){const e=t.map(t=>t.split(":")[0]);const n=yield this.getOutputDataMap(e);return t.map(t=>{const[e,s]=t.split(":");const i=n.get(e);if(!i||!Array.isArray(i))throw new Error("No data found.");return i[parseInt(s,10)]})}throw new Error("chain not set in db.get")}))}getUpdateTxBch(t,e){return o(this,void 0,void 0,(function*(){const n=new Ot(this.chain,this.network);const s=yield this.get(t);const i=yield this.wallet.restClient.getTxosFromOutputData(s);t.forEach((t,e)=>o(this,void 0,void 0,(function*(){n.fromDataOutput(i[e],s[e])})));const r=$(e,this.wallet.getPublicKey()).map(t=>n.toData(t));return{txId:yield this.wallet.fundAndSendTransaction(n,!0),virtualIndices:r}}))}getUpdateTxBsv(t,e){return o(this,void 0,void 0,(function*(){const n=new Ot(this.chain,this.network);(yield Promise.all(t.map(t=>o(this,void 0,void 0,(function*(){const[e,n]=t.split(":");const s=yield this.wallet.restClient.getTransaction(e);const{script:i,satoshis:r}=s.outputs[parseInt(n,10)];const o=rt.fromScript(i);return{output:{txId:e,outputIndex:parseInt(n,10),scriptPubKey:o,satoshis:Math.round(r)},publicKeys:o.getPublicKeys(),nr:1}}))))).forEach(({output:t,publicKeys:e,nr:s})=>{n.from(t,e,s)});const s=$(e,this.wallet.getPublicKey()).map(t=>n.toData(t));return{txId:yield this.wallet.fundAndSendTransaction(n,!0),virtualIndices:s}}))}update(t,e){return o(this,void 0,void 0,(function*(){if("BSV"===this.chain){const{txId:n,virtualIndices:s}=yield this.getUpdateTxBsv(t,e);return yield Promise.all(t.map(t=>o(this,void 0,void 0,(function*(){yield this.wallet.restClient.setTxoSpent(t)})))),s.map(t=>`${n}:${t}`)}if("BCH"===this.chain){const{txId:n,virtualIndices:s}=yield this.getUpdateTxBch(t,e);return t.forEach(t=>o(this,void 0,void 0,(function*(){yield this.wallet.restClient.setTxoSpent(t)}))),s.map(t=>`${n}:${t}`)}throw new Error("Chain not set in db.update "+this.chain)}))}}const{Mnemonic:It,HDPrivateKey:jt,Address:Pt,PublicKey:Et,PrivateKey:Tt}=s.default;class Ct{constructor(t,e,n={}){const{path:s="m/44'/0'/0'/0",passphrase:i=""}=n;this.mnemonic=t,this.path=s,this.passphrase=i,this.restClient=e,this.utoxsSyncing=!1,this.hdPrivateKey=this.mnemonic.toHDPrivateKey(this.passphrase,g.NETWORK),this.path&&(this.hdPrivateKey=this.hdPrivateKey.derive(this.path)),this.utxos=[],this.syncUtxos()}get chain(){return this.restClient.chain}get network(){return this.restClient.network}getMnemonic(){return this.mnemonic}getPath(){return this.path}getUtxos(){return this.utxos}derive(t=0,e=!1){const n=new Ct(this.mnemonic,this.restClient);return n.path=`${this.path}${this.path.length?"/":""}${t}${e?"'":""}`,n.hdPrivateKey=this.hdPrivateKey.derive(t,e),n}static getHdPrivateKey(){return new jt}getPrivateKey(){return this.hdPrivateKey.privateKey}getPublicKey(){return this.hdPrivateKey.publicKey}getAddress(){return this.address=this.address||this.getPublicKey().toAddress(this.network),this.address}syncUtxos(){return o(this,void 0,void 0,(function*(){this.utoxsSyncing=!0,this.utxos=yield this.restClient.getUtxosFromAddress(this.getAddress()),this.utoxsSyncing=!1}))}waitUntilSynced(){return o(this,void 0,void 0,(function*(){for(;this.utoxsSyncing;)yield new Promise(t=>setTimeout(t,300))}))}getBalance(){return o(this,void 0,void 0,(function*(){const t=this.getAddress();return this.restClient.getBalance(t.toString())}))}getBalanceLowerBounds(){return o(this,void 0,void 0,(function*(){return yield this.waitUntilSynced(),this.utxos.reduce((t,e)=>t+e.satoshis,0)}))}getUtxosToSpend(t){return o(this,void 0,void 0,(function*(){yield this.waitUntilSynced();for(let t=this.utxos.length-1;t>0;t-=1){const e=Math.floor(Math.random()*(t+1));[this.utxos[t],this.utxos[e]]=[this.utxos[e],this.utxos[t]]}return this.getUtxosWithSatoshis(t)}))}getUtxosWithSatoshis(t){let e=0;const n=[];let s=0;for(;e<t&&s<this.utxos.length;)n.push(this.utxos[s]),e+=this.utxos[s].satoshis,s+=1;if(e>=t)return n;throw new Error(`Insufficient balance in address ${this.getAddress().toString()} on ${g.NETWORK} ${g.CHAIN}. Found ${e}, required ${t}.`)}fundAndSendTransaction(t,e=!1){return o(this,void 0,void 0,(function*(){t.feePerKb(g.DEFAULT_FEE);const n=t._estimateFee()+100;const s=yield this.getUtxosToSpend(t._getOutputAmount()-t._getInputAmount()+n);s.forEach(e=>t.from(e)),t.change(this.getAddress()),t.sign(this.getPrivateKey());const i=yield this.restClient.sendTransaction(t,e);this.utxos=this.utxos.filter(t=>!s.includes(t));const r=t.getChangeOutput();return r&&this.utxos.push({txId:t.getTxId(),vout:t.getChangeIndex(),satoshis:r.satoshis,amount:r.satoshis/1e8,scriptPubKey:r.script.toHex()}),i}))}send(t,e){return o(this,void 0,void 0,(function*(){const n=new Ot(this.chain,this.network).to(e,t);return this.fundAndSendTransaction(n)}))}}let Bt;if("undefined"==typeof window){const{LocalStorage:t}=require("node-localstorage");Bt=new t("./uls-scratch")}else void 0!==window.localStorage&&(Bt=window.localStorage);var Nt=Bt;class kt{static serialize(t){return JSON.stringify(Object.entries(t))}static deserialize(t,e){const n=e?new e:{};return JSON.parse(t).forEach(([t,e])=>{n[t]=e}),n}static set(t){if(void 0===t._rev)throw new Error("Rev not set in Cache.set");const e="Object"===t.constructor.name?JSON.stringify({data:kt.serialize(t)}):JSON.stringify({data:kt.serialize(t),clazz:t.constructor.toString()});return Nt.setItem(t._rev,e),t._rev}static get(t){const{data:e,clazz:n}=JSON.parse(Nt.getItem(t||""))||{};if(e){const t="string"==typeof n?eval(`(${n})`):void 0;return this.deserialize(e,t)}return null}}class Ut{constructor(t,e){this.chain=t,this.network=e}get(t){return o(this,void 0,void 0,(function*(){const e=kt.get(t);if(e)return e;const[n,s]=t.split(":");const i=yield Ot.fromTxId(n,this.chain,this.network);yield i.fetchOutputData();const r=i.outputData;const{__index:c}=r[0];const{__cls:a,__func:u,__args:d}=r[c.obj];const h=yield i.getVirtualInputs();const p=yield Promise.all(Object.values(c).map(t=>o(this,void 0,void 0,(function*(){return h[t]?this.get(h[t]):Promise.resolve({})}))));const l=Object.keys(c).map((t,e)=>[t,p[e]]);const f=Object.fromEntries(l);let g=f.obj;delete f.obj;const w=Object.entries(f).reduce((t,[e,n])=>(Number.isNaN(parseInt(e,10))||(t[parseInt(e,10)]=n),t),[]);const _=Q(w,d);let v;if("constructor"===u){const t=eval(`(${a})`);g=new t(..._)}else{const t=g[u].bind(g);v=Reflect.apply(t,g,_)}const m=c;Object.entries(m).forEach(([t,e])=>{"obj"===t&&K(g,r,e,n),K("res"===t?v:w[t],r,e,n)});const b=g._rootId||`${n}:${m.obj}`;return A([g,v,...w],b),[g,v,...w].filter(t=>!y(t)).map(kt.set),[...w,g,v][s]}))}}const{Mnemonic:$t,PublicKey:Kt}=s.default;class Dt{constructor(t={}){const{seed:e,chain:n=g.CHAIN,network:s=g.NETWORK,mnemonic:i=new $t(e),wocApiKey:r,path:o="m/44'/0'/0'/0",passphrase:c=""}=t;if(!n||!["BSV","BCH"].includes(n))throw new Error("Please set 'chain' to 'BSV' or 'BCH' when creating a computer instance");if(!s||!["livenet","testnet"].includes(s))throw new Error("Please set 'network' to 'testnett' or 'livenet' when creating a computer instance");if(!i)throw new Error("Please set 'seed' to a valid BIP 39 mnemonic string when creating a computer instance");this.restClient=new dt(n,s,r);const{db:a=new xt(new Ct(i,this.restClient,{path:o,passphrase:c}))}=t;this.db=a,this.reader=new Ut(this.chain,this.network)}get chain(){return this.db.chain}get network(){return this.db.network}static parseContract(t){if("string"==typeof t){const e=t.startsWith("export ")?t.slice(7):t;const n=e.startsWith("default ")?e.slice(8):e;return eval(`(${n})`)}return t}new(t,e=[]){return o(this,void 0,void 0,(function*(){if(!t)throw new Error("Please enter a valid Class");const n=new tt(this.db);const s=Dt.parseContract(t);const i=new Proxy(s,n);const r=yield new i(...e);return new Proxy(r,n)}))}sync(t){return o(this,void 0,void 0,(function*(){X(t);const e=yield this.reader.get(t);const n=new tt(this.db);return new Proxy(e,n)}))}getOwnedRevs(t=this.db.wallet.getPublicKey()){return o(this,void 0,void 0,(function*(){return this.db.wallet.restClient.getOwnedRevs(t)}))}getRevs(t=this.db.wallet.getPublicKey()){return o(this,void 0,void 0,(function*(){return(yield this.db.wallet.restClient.getOwnedRevs(t)).map(({txId:t,virtualIndex:e})=>`${t}:${e}`)}))}getLatestRev(t){return o(this,void 0,void 0,(function*(){return this.db.wallet.restClient.getLatestRev(t)}))}}const At=({data:t})=>{try{if("eval"===t.cmd){const e=eval(t.string);window.parent.postMessage({res:e},"*")}else{if("apply"!==t.cmd)throw new Error("Unrecognized cmd in sandbox. "+t.cmd);{const{serialized:e,func:n,args:s,clazz:i}=t.string;const r=eval(`(${i})`);const o=new r;JSON.parse(e).map(([t,e])=>o[t]=e);const c=o[n](...s);window.parent.postMessage({res:c,obj:o},"*")}}}catch(t){window.parent.postMessage({err:t.message},"*")}};const Rt=t=>new Promise(e=>setTimeout(e,t));const Ht=()=>"undefined"!=typeof window&&void 0!==window.document;const Mt=()=>"undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;class Lt{constructor(){this.isInitialized=!1,this.iframe=this.addIframe(At.toString())}addIframe(t){const e=document.createElement("iframe");if(!e)throw new Error("could not create iframe");e.setAttribute("sandbox","allow-scripts"),e.setAttribute("style","display: none;"),e.onload=()=>{this.isInitialized=!0};const n=`<script type="module" crossorigin="anonymous">window.addEventListener('message', ${t})<\/script>`;if(e.src="data:text/html;base64,"+btoa(n),!document||!document.body)throw new Error("document body not found");return document.body.appendChild(e),e}sendToFrame(t){this.isInitialized&&this.iframe.contentWindow.postMessage(t,"*")}eval(t){return o(this,void 0,void 0,(function*(){for(;!this.isInitialized;)yield Rt(100);return this.sendToFrame({cmd:"eval",string:t}),new Promise((t,e)=>{window.addEventListener("message",({data:n})=>{n.res?t(n.res):e(n.err)})})}))}apply(t,e,n){return o(this,void 0,void 0,(function*(){for(;!this.isInitialized;)yield Rt(100);const s=JSON.stringify(Object.entries(t));const i=t.constructor.toString();return this.sendToFrame({cmd:"apply",string:{serialized:s,func:e,args:n,clazz:i}}),new Promise((t,e)=>{window.addEventListener("message",({data:n})=>{n.res?t(n):e(n.err)})})}))}}class zt{eval(t){return o(this,void 0,void 0,(function*(){return eval(t)}))}apply(t,e,n){return o(this,void 0,void 0,(function*(){return{res:t[e](...n),obj:t}}))}}class Ft{constructor(){if(console.log(`Using ${Ht()?"browser":"node"} sandbox`),Ht())this.sandbox=new Lt;else{if(!Mt())throw new Error("Unrecognized computing environment");this.sandbox=new zt}}eval(t){return o(this,void 0,void 0,(function*(){return this.sandbox.eval(t)}))}apply(t,e,n){return o(this,void 0,void 0,(function*(){return this.sandbox.apply(t,e,n)}))}}exports.Sandbox=Ft,exports.default=Dt;
