"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var e=t(require("bitcoinsource"));var r=t(require("axios"));function n(t,e,r,n,s,i,a){try{var o=t[i](a);var c=o.value}catch(t){return void r(t)}o.done?e(c):Promise.resolve(c).then(n,s)}function s(t){return function(){var e=this,r=arguments;return new Promise((function(s,i){var a=t.apply(e,r);function o(t){n(a,s,i,o,c,"next",t)}function c(t){n(a,s,i,o,c,"throw",t)}o(void 0)}))}}function i(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function a(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function o(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?a(Object(r),!0).forEach((function(e){i(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function c(t,e){if(null==t)return{};var r={};var n=Object.keys(t);var s,i;for(i=0;i<n.length;i++)s=n[i],e.indexOf(s)>=0||(r[s]=t[s]);return r}function u(t,e){if(null==t)return{};var r=c(t,e);var n,s;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(s=0;s<i.length;s++)n=i[s],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}function h(t,e){if("object"!=typeof t||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}function p(t){var e=h(t,"string");return"symbol"==typeof e?e:String(e)}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function d(t,e,r,n){return new(r||(r=Promise))((function(s,i){function a(t){try{c(n.next(t))}catch(t){i(t)}}function o(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,o)}c((n=n.apply(t,e||[])).next())}))}var l=process.env.BC_CHAIN||"BSV";var v=process.env.BC_NETWORK||"testnet";var f=process.env.BC_WOC_API_KEY||void 0;var g=!!process.env.BC_LOCAL_BBS||!1;var _=parseInt(process.env.BC_DUST_LIMIT,10)||4e3;var m=parseInt(process.env.BC_DEFAULT_FEE,10)||("BSV"===l?500:2500);var w=parseInt(process.env.BC_SCRIPT_CHUNK_SIZE,10)||479;var b;var y;process.env.BC_BBS_URL?(y="http://".concat(process.env.BC_BBS_URL),b="ws://".concat(process.env.BC_BBS_URL)):(y=g?"http://localhost:3000":"https://bbs.bitcoincomputer.io",b=g?"ws://localhost:3000":"wss://bbs.bitcoincomputer.io");var O={CHAIN:l,NETWORK:v,WOC_API_KEY:f,MIN_NON_DUST_AMOUNT:_,SCRIPT_CHUNK_SIZE:w,UN_P2SH_URL:y,WS_URL:b,DEFAULT_FEE:m};const S=()=>"__temp__:"+Math.random();const x=["_id","_rev","_owners","_amount","__vouts","__txId","__cls","__func","__index","_args"];const I=t=>Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)[1];const P=t=>"object"==typeof t?I(t):I(t).toLowerCase();const j=t=>["number","string","boolean","undefined","Null"].includes(P(t));const T=t=>"Array"===P(t);const E=t=>"Object"===P(t);const C=t=>"Object"===P(t)&&!!t._id&&!!t._rev;const B=t=>j(t)||["Array","Object"].includes(P(t));const D=t=>"Object"===P(t)&&Object.keys(t).every(t=>!Number.isNaN(parseInt(t,10)));const k=(t,e)=>{if(!B(t)||!B(e))throw new Error(`Unsupported data types for deep equals: ${P(t)} & ${P(e)}`);if(P(t)!==P(e))return!1;if(j(t)&&j(e))return t===e;const r=(t,e)=>Object.entries(t).every(([t,r])=>k(e[t],r));return t&&e&&r(t,e)&&r(e,t)};const K=t=>{if(j(t))return t;if(T(t))return t.map(K);if(E(t)){const e=Object.keys(t).reduce((e,r)=>(e[r]=K(t[r]),e),{});const r=Object.create(Object.getPrototypeOf(t));return Object.assign(r,e)}throw new Error("Unsupported data type for clone: "+P(t))};const N=(t,e)=>t.reduce(([t,r],n,s)=>e(n,s)?[[...t,n],r]:[t,[...r,n]],[[],[]]);const U=(t,e)=>Object.fromEntries(Object.entries(t).map(t=>e(t)));const A=(t,e)=>U(t,([t,r])=>[t,e(r)]);const R=(t,e)=>Object.fromEntries(Object.entries(t).filter(([,t])=>e(t)));const H=(t,e)=>{if(!j(t)){if(T(t))return t.find(t=>H(t,e));if(E(t))return t._rev===e?t:Object.values(t).find(t=>H(t,e));throw new Error(`Unsupported type ${P(t)} in findByRev`)}};const M=(t,e)=>{if(j(t))return t;if(E(t)){const r=U(t,([t,r])=>[t,x.includes(t)?r:M(r,e)]);const n=t._amount&&void 0!==t._amount?t._amount:O.MIN_NON_DUST_AMOUNT;const s=void 0!==t._owners?t._owners:[e];return Object.assign(Object.assign({},r),{_amount:n,_owners:s})}if(T(t))return t.map(t=>M(t,e));throw new Error(`unsupported type ${P(t)} in setOwnersAndAmount`)};const F=(t,e,r)=>{if(!j(t)&&(T(t)&&t.map(t=>F(t,e,r)),C(t))){const n=e.findIndex(e=>e===t._rev);-1!==n&&(t._rev=`${r}:${n}`),Object.values(t).map(t=>F(t,e,r))}};const L=t=>{if(T(t))t.map(L);else if(E(t)){const e=S();return t._id=t._id||e,t._rev=t._rev||e,Object.values(t).map(L),t._id}};function V(t){if(j(t))return t;if(T(t))return t.map(V);if(E(t))return U(t,([t,e])=>"_owners"===t?[t,JSON.stringify(e)]:j(e)?[t,e]:[t,V(e)]);throw new Error(`Unexpected type ${P(t)} in stringifyOwners`)}const W=t=>j(t)?t:Object.entries(t).reduce((t,[e,r])=>{const n=W(r);return D(n)?Object.entries(n).forEach(([r,n])=>{t[`${e}_${r}`]=n}):t[e]=n,t},{});const $=t=>{const e={[t._id]:Object.entries(t).reduce((t,[e,r])=>x.includes(e)?Object.assign(Object.assign({},t),{[e]:r}):j(r)?Object.assign(Object.assign({},t),{["__basic__"+e]:r}):Object.assign(Object.assign({},t),{[e]:r._id}),{})};return Object.values(t).filter(t=>!j(t)).reduce((t,e)=>Object.assign(Object.assign({},t),$(e)),e)};const J=t=>Object.fromEntries(Object.entries(t).filter(([t])=>!t.startsWith("__basic__")));const z=(t,e)=>Object.fromEntries(Object.entries(e).map(([e,r])=>{const n=t[e];var s;return r.__change=(s=n)?k(s,r)?"same":"diff":"new",[e,r]}));const q=(t,e)=>(t[e].__contains=Object.entries(t[e]).reduce((e,[r,n])=>["__contains"].concat(x).includes(r)?e:"__change"===r?"new"===n||"diff"===n||e:q(t,n)[n].__contains||e,!1),t);const Z=t=>t.reduce((t,e,r)=>Object.assign(Object.assign({},t),{[e._id]:r}),{});const G=(t,e)=>t.map(t=>Object.entries(t).reduce((t,[r,n])=>{const s="string"==typeof n&&"undefined"!==P(e[n])?e[n]:n;return Object.assign(Object.assign({},t),{[r]:s})},{}));const Y=t=>void 0!==t._owners?Object.assign(Object.assign({},t),{_owners:JSON.parse(t._owners)}):t;const Q=(t,e)=>{const r=L(e);const n=K(t);const s=K(e);V(n),V(s);const i=W(n);const a=W(s);const o=$(i);const c=$(a);const u=z(o,c);const h=A(u,J);const p=q(h,r);const d=p[r];delete p[r];const l=A(p,t=>t._rev);const v=R(p,t=>t.__contains||Object.values(d).includes(t._id));const f=Object.values(v);const[g,_]=N(f,t=>"new"===t.__change);const m=[..._,...g];const w=Z(m);const b=G(m,w);const[y]=G([d],w);const O=_.map(t=>t._rev);return b.concat([y]).forEach(t=>{delete t._id,delete t._rev,delete t.__change,delete t.__contains}),[O,b.map(t=>Object.entries(t).reduce((t,[e,r])=>Object.assign(Object.assign({},t),{[e]:l[r]||r}),{})).map(Y),y]};var X=t=>({smartArgs:t.filter(t=>t._rev),dumbArgs:t.map(t=>t._rev?"__":t)});var tt=(t,e)=>e.map(e=>"__"===e?t.shift():e);class et{constructor(t){this.db=t}construct(t,e){return d(this,void 0,void 0,(function*(){return(()=>d(this,void 0,void 0,(function*(){const[r,n]=K([e,{}]);const s=new t(...e);const{smartArgs:i,dumbArgs:a}=X(r);const{smartArgs:o}=X(e);const c=Object.assign(Object.assign(Object.assign({},i),{obj:n}),{_id:"index"});const u=Object.assign(Object.assign(Object.assign({},o),{obj:s}),{_id:"index"});const[h,p,d]=Q(c,u);void 0!==p[0]&&(p[0].__func="constructor",p[0]._args=a,p[0].__index=d,p[0].__cls=t.toString());const l=yield this.db.update(h,p);const v=l[0].split(":")[0];F([...o,s],h,v);const f=l[o.length];return s._rev=f,s._id=f,s})))()}))}call(t,e,r){return d(this,void 0,void 0,(function*(){const[n,s]=K([r,t]);const i=Reflect.apply(t[e],t,r);const{smartArgs:a,dumbArgs:o}=X(n);const{smartArgs:c}=X(r);const u=Object.assign(Object.assign(Object.assign({},a),{obj:s}),{_id:"index"});const h=Object.assign(Object.assign(Object.assign({},c),{obj:t}),{_id:"index"});"object"===P(i)&&(h.res=i);const[p,d,l]=Q(u,h);void 0!==d[0]&&(d[0].__func=e,d[0]._args=o,d[0].__index=l);const v=yield this.db.update(p,d);const f="object"===P(i)?[...c,t,i]:[...c,t];const g=v[0].split(":")[0];F(f,p,g);const _=v[c.length];return"Object"===P(i)&&(i._rev=_,i._id=_),i}))}get(t,e){return"function"==typeof t[e]?(...r)=>this.call(t,e,r):Reflect.get(t,e)}}e.versionGuard=()=>!0,e.Networks.defaultNetwork=e.Networks[O.NETWORK];class rt{constructor(t,e,r={}){const{path:n="m/44'/0'/0'/0",passphrase:s=""}=r;this.mnemonic=t,this.path=n,this.passphrase=s,this.restClient=e,this.utoxsSyncing=!1,this.hdPrivateKey=this.mnemonic.toHDPrivateKey(this.passphrase,O.NETWORK),this.path&&(this.hdPrivateKey=this.hdPrivateKey.derive(this.path)),this.utxos=[],this.syncUtxos()}get chain(){return this.restClient.chain}get network(){return this.restClient.network}getMnemonic(){return this.mnemonic}getPath(){return this.path}getUtxos(){return this.utxos}derive(t=0,e=!1){const r=new rt(this.mnemonic,this.restClient);return r.path=`${this.path}${this.path.length?"/":""}${t}${e?"'":""}`,r.hdPrivateKey=this.hdPrivateKey.derive(t,e),r}static getHdPrivateKey(){return new e.HDPrivateKey}getPrivateKey(){return this.hdPrivateKey.privateKey}getPublicKey(){return this.hdPrivateKey.publicKey}getAddress(){return this.address=this.address||this.getPublicKey().toAddress(this.network),this.address}syncUtxos(){return d(this,void 0,void 0,(function*(){this.utoxsSyncing=!0,this.utxos=yield this.restClient.getUtxosFromAddress(this.getAddress()),this.utoxsSyncing=!1}))}waitUntilSynced(){return d(this,void 0,void 0,(function*(){for(;this.utoxsSyncing;)yield new Promise(t=>setTimeout(t,300))}))}getBalance(){return d(this,void 0,void 0,(function*(){const t=this.getAddress();return this.restClient.getBalance(t.toString())}))}getBalanceLowerBounds(){return d(this,void 0,void 0,(function*(){return yield this.waitUntilSynced(),this.utxos.reduce((t,e)=>t+e.satoshis,0)}))}getUtxosToSpend(t){return d(this,void 0,void 0,(function*(){yield this.waitUntilSynced();for(let t=this.utxos.length-1;t>0;t-=1){const e=Math.floor(Math.random()*(t+1));[this.utxos[t],this.utxos[e]]=[this.utxos[e],this.utxos[t]]}let e=0;const r=[];let n=0;for(;e<t&&n<this.utxos.length;)r.push(this.utxos[n]),e+=this.utxos[n].satoshis,n+=1;if(e>=t)return r;throw new Error(`Insufficient balance in address ${this.getAddress().toString()} on ${O.NETWORK} ${O.CHAIN}. Found ${e}, required ${t}.`)}))}fundAndSendTransaction(t,e=!1){return d(this,void 0,void 0,(function*(){t.feePerKb(O.DEFAULT_FEE);const r=t._estimateFee()+100;const n=yield this.getUtxosToSpend(t._getOutputAmount()-t._getInputAmount()+r);n.forEach(e=>t.from(e)),t.change(this.getAddress()),t.sign(this.getPrivateKey()),yield this.restClient.sendTransaction(t,e),this.utxos=this.utxos.filter(t=>!n.includes(t));const s=t.getChangeOutput();return s&&this.utxos.push({txId:t.getTxId(),vout:t.getChangeIndex(),satoshis:s.satoshis,amount:s.satoshis/1e8,scriptPubKey:s.script.toHex()}),t}))}}var{PublicKey:nt,Signature:st,Script:it,Opcode:at}=e;function ot(t,e){var r=[];var n=0;for(;n<t.length;)r.push(t.slice(n,n+e)),n+=e;return r}class ct extends it{static outScriptFromData(t){var{_owners:e,_amount:r,__vouts:n,__txId:s}=t,i=u(t,["_owners","_amount","__vouts","__txId"]);var a=ot(Buffer.from(JSON.stringify(i)),O.SCRIPT_CHUNK_SIZE);return a[a.length-1].byteLength>=O.SCRIPT_CHUNK_SIZE&&ot(a.pop(),O.SCRIPT_CHUNK_SIZE).forEach(t=>{a.push(t)}),a.map(t=>({redeemScript:ct.getScript(t,e),chunk:t}))}static getScript(t,e){var r=new ct;return r.add("OP_1"),e.forEach(t=>r.add(t.toBuffer())),r.add("OP_".concat(e.length)),r.add("OP_CHECKMULTISIG"),r.add(t),r.add("OP_DROP"),r}getData(){return this.isDbDataScript()?JSON.parse(this.chunks[this.chunks.length-2].buf.toString()):{}}getPublicKeys(){if(this.isDbDataScript())return this.chunks.slice(1,this.chunks.length-4).map(t=>new nt(t.buf));throw new Error("Cannot get owners from non-data script")}isDbDataScript(){return!!(this.chunks.length>=5&&this.chunks[0].opcodenum===at.OP_1&&this.chunks[1].buf&&[20,33].includes(this.chunks[1].buf.length)&&this.chunks[this.chunks.length-3].opcodenum===at.OP_CHECKMULTISIG&&this.chunks[this.chunks.length-2].buf&&this.chunks[this.chunks.length-1].opcodenum===at.OP_DROP)}static isP2shScript(t){return!(3!==t.chunks.length||t.chunks[0].opcodenum!==at.OP_0||!t.chunks[1].buf||!t.chunks[2].buf)}static redeemScriptFromP2shScript(t){if(!this.isP2shScript(t))throw new Error("not a p2sh script");var e=new it(t.chunks[2].buf);var r=new this;return r.chunks=e.chunks,r}static fromScript(t){var e=new it(t);var r=new ct;return r.chunks=e.chunks,r}}function ut(t){return{writable:!0,value:t}}function ht(t,e,r){var{[t]:n}=r;return o({[e]:n},u(r,[t].map(p)))}var{Address:pt,Transaction:dt,PublicKey:lt,Script:vt}=e;var ft=new Map;class gt{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:O.CHAIN;var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:O.NETWORK;var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:O.WOC_API_KEY;this.chain=t,this.network=e,"BSV"===t&&(this.wocApiKey=r)}getBaseUrl(){if("BSV"===this.chain){var t="livenet"===this.network?"main":"test";return"https://api.whatsonchain.com/v1/bsv/".concat(t)}var e="livenet"===this.network?"rest":"trest";return"https://".concat(e,".bitcoin.com/v2")}getRequestHeaders(){return"BSV"===this.chain&&this.wocApiKey?{"woc-api-key":this.wocApiKey}:{}}unwrap(t){return s((function*(){try{return(yield t).data}catch(t){var{message:e,config:r,response:n}=t;var{url:s,method:i,data:a}=r;var o;try{o=JSON.parse(a)}catch(t){o=null}var c=o&&o.txhex?new dt(o.txhex):null;throw t.message="Communication Error\n\nmessage\t".concat(e,"\nrequest\t").concat(i," ").concat(s,"\n").concat(c?"transaction\t ".concat(JSON.stringify(c.toJSON(),null,2)):"post"!==i||c?"":"data\t".concat(a),"\n").concat(n?"response\t".concat(JSON.stringify(n.data)):""),t}}))()}get(t){var e=arguments,n=this;return s((function*(){var s=e.length>1&&void 0!==e[1]&&e[1]?"":n.getBaseUrl();return n.unwrap(r.get("".concat(s).concat(t),{headers:n.getRequestHeaders()}))}))()}post(t,e){var n=arguments,i=this;return s((function*(){var s=n.length>2&&void 0!==n[2]&&n[2]?"":i.getBaseUrl();return i.unwrap(r.post("".concat(s).concat(t),e,{headers:i.getRequestHeaders()}))}))()}getBalance(t){var e=this;return s((function*(){var r="/address/".concat(t.toString(),"/balance");var n="/address/details/".concat(t.toString());var s;switch(e.chain){case"BSV":return s=yield e.get(r),parseInt(s.confirmed,10)+parseInt(s.unconfirmed,10);case"BCH":return s=yield e.get(n),parseInt(s.balanceSat,10)+parseInt(s.unconfirmedBalanceSat,10);default:throw new Error("chain is not set in getBalance")}}))()}getTransaction(t){var e=this;return s((function*(){var r=yield e.getRawTransaction(t);return new dt(r)}))()}getTransactionWithSpendingData(t){var e=this;return s((function*(){if("testnet"===e.network&&"BSV"===e.chain)throw new Error("Restclient.getTransactionWithSpendingData is not supported on BSV testnet");switch([t]=t.split(":"),e.chain){case"BSV":var r="https://api.blockchair.com/bitcoin-sv/dashboards/transaction/".concat(t);var{data:n}=yield e.get(r,!0);var{transaction:s,inputs:i,outputs:a}=n[t];return{hex:"",txid:s.hash,hash:s.hash,version:s.version,size:s.size,locktime:s.lock_time,vin:i,vout:a.map(t=>({value:t.value,n:t.index,scriptPubKey:t.script_hex,spentTxId:t.spending_transaction_id,spentIndex:t.spending_index})),blockhash:"unknown",confirmations:"unknown",time:"unknown",blocktime:"unknown"};case"BCH":return e.get("/transaction/details/".concat(t));default:throw new Error("chain is not set in getTransactionWithSpendingData")}}))()}getRawTransaction(t){var e=this;return s((function*(){[t]=t.split(":");var n=ft.get(t);if(n)return n;var s="livenet"===e.network?"main":"test";var i=yield e.unwrap(r.get("".concat(O.UN_P2SH_URL,"/tx/").concat(e.chain,"/").concat(s,"/").concat(t)));return ft.set(t,i),i}))()}sendTransaction(t){var e=arguments,r=this;return s((function*(){var n=e.length>1&&void 0!==e[1]&&e[1];var s;if("BSV"===r.chain)s=yield r.post("/tx/raw",{txhex:t.toString()});else{if("BCH"!==r.chain)throw new Error("chain is not set in sendTransaction");[s]=yield r.post("/rawtransactions/sendRawTransaction",{hexes:[t.toString()]})}if(n){var i=t.outputData.map(t=>{var{_owners:e}=t;if(void 0!==e){var r=e.map(t=>t.toString());return o(o({},t),{_owners:r})}return t});var a=JSON.stringify(i);var c=t.toJSON().inputs.map(t=>{var{prevTxId:e,outputIndex:r}=t;return{txId:e,outputIndex:r}});yield r.postOutputData({txId:s,outputData:a,inputs:c})}return s}))()}getUtxosFromAddress(t){var e=this;return s((function*(){var r=[];var n="";switch(e.chain){case"BSV":return r=yield e.get("/address/".concat(t.toString(),"/unspent")),Promise.all(r.map(t=>{var{tx_hash:e,tx_pos:r,value:n}=t;return{txId:e,vout:r,satoshis:n,amount:n/1e8}}).map(function(){var t=s((function*(t){var r=(yield e.getTransaction(t.txId)).outputs[t.vout];return t.scriptPubKey=r.script.toHex(),t}));return function(e){return t.apply(this,arguments)}}()));case"BCH":return({utxos:r,scriptPubKey:n}=yield e.get("/address/utxo/".concat(t.toString()))),r.map(t=>o({scriptPubKey:n},t)).map(t=>{var{txid:e}=t;return o({txId:e},u(t,["txid"]))});default:throw new Error("chain is not set in getUtxosFromAddress")}}))()}getTxosFromOutputData(t){var e=this;return s((function*(){var r=t.map(t=>t.__txId);var n=[...new Set(r)];var i=new Map;return yield Promise.all(n.map(function(){var t=s((function*(t){return i.set(t,yield e.getTransaction(t))}));return function(e){return t.apply(this,arguments)}}())),t.map(t=>{var{outputs:e,blockheight:r,confirmations:n}=i.get(t.__txId)||{};return t.__vouts.map(s=>{var{_scriptBuffer:i,_satoshis:a}=e[s];return{txId:t.__txId,vout:s,scriptPubKey:i.toString("hex"),amount:parseFloat(a/1e8),satoshis:parseInt(a,10),height:r,confirmations:n}})})}))()}postOutputData(t){var e=this;return s((function*(){return e.post("".concat(O.UN_P2SH_URL,"/"),t,!0)}))()}getOutputData(t){var e=this;return s((function*(){return((yield e.get("".concat(O.UN_P2SH_URL,"/un-p2sh/").concat(t),!0))||[]).map(t=>t._owners?o(o({},t),{_owners:t._owners.map(t=>new lt(t))}):t)}))()}getOwnedRevs(t){var e=this;return s((function*(){return e.get("".concat(O.UN_P2SH_URL,"/txos/").concat(t.toString()),!0)}))()}setTxoSpent(t){var e=this;return s((function*(){var[r,n]=t.split(":");return e.post("".concat(O.UN_P2SH_URL,"/txos/set-spent/"),{txId:r,virtualIndex:parseInt(n,10)},!0)}))()}}var{Transaction:_t,PublicKey:mt,Address:wt,BN:bt,Script:yt,encoding:Ot}=e;var{Output:St,Input:xt}=_t;var{MultiSigScriptHash:It,PublicKeyHashInput:Pt}=xt;var{BufferReader:jt}=Ot;var Tt=t=>new Promise(e=>setTimeout(e,t));class Et extends _t{constructor(t,e,r){super(r),this._outputData=[],this.restClient=new gt(t,e),this.feePerKb(O.DEFAULT_FEE),Object.defineProperty(this,"to",ut(this._to)),Object.defineProperty(this,"from",ut(this._from))}get chain(){return this.restClient.chain}get network(){return this.restClient.network}static fromRedeemScripts(t){var e=t.map(t=>t.chunks[t.chunks.length-2].buf);var r=Buffer.concat(e);var n=JSON.parse(r.toString());return o({_owners:t[0].getPublicKeys(),_amount:O.MIN_NON_DUST_AMOUNT},n)}static addVouts(t){var e=0;return t.map(t=>{var r=ct.outScriptFromData(t).length;return t.__vouts=Array(r).fill(e).map((t,e)=>t+e),e+=r,t})}get dataInputs(){var t=[];var e=function*(t){for(var e of t)yield e}(this.inputs);var r=e.next();for(;!r.done;){var n=r.value;var s=ct.fromScript(n._scriptBuffer);if(ct.isP2shScript(s)){var i=!1;var a=[ct.redeemScriptFromP2shScript(s)];for(;!i;)try{t.push(Et.fromRedeemScripts(a)),i=!0}catch(t){var o=e.next();if(o.done)throw new Error("Could not compute data inputs");var c=o.value;var u=ct.fromScript(c._scriptBuffer);a.push(ct.redeemScriptFromP2shScript(u))}}r=e.next()}return t}set dataInputs(t){throw Error("dataTransaction.dataInputs cannot be set directly, use dataTransaction.from or dataTransaction.fromDataOutput")}getVirtualInputs(){var t=this;return s((function*(){if("BSV"===t.chain)return(yield Promise.all(t.inputs.map(function(){var e=s((function*(e){var{prevTxId:r,outputIndex:n}=e;var s=e.prevTxId.toString("hex");var i=(yield Et.fromTxId(s,t.chain,t.network)).outputs[n];return!!ct.fromScript(i._scriptBuffer).isDbDataScript()&&e}));return function(t){return e.apply(this,arguments)}}()))).filter(t=>!!t).map(t=>"".concat(t.prevTxId.toString("hex"),":").concat(t.outputIndex));if("BCH"===t.chain){var{dataInputs:e}=t;var r=Et.addVouts(e);return Promise.all(r.map(function(){var e=s((function*(e){var r=[];e.__vouts.forEach(e=>{r.push(t.inputs[e])});var n=r[0].prevTxId.toString("hex");var s=yield Et.fromTxId(n,t.chain,t.network);yield s.fetchOutputData();var i=Et.addVouts(s.outputData);var a=[];i.forEach((t,e)=>{k(t.__vouts,r.map(t=>t.outputIndex))&&a.push(e)});var o=a[0];return"".concat(n,":").concat(o)}));return function(t){return e.apply(this,arguments)}}()))}throw new Error("chain not set in getVirtualInputs")}))()}fromMultiSig(t,e,r){var n=t.map(t=>ht("txId","txid",t));return super.from(n,e,r)}_from(t,e,r){var n=ht("txId","txid",t);return super.from(n,e,r)}fromDataOutput(t,e){var r=ct.outScriptFromData(e);var{_owners:n}=e;return r.forEach((e,r)=>{var{redeemScript:s}=e;var{scriptPubKey:i,satoshis:a,txId:o,vout:c}=t[r];var u=new St({script:new ct(i),satoshis:parseInt(a,10)});var h=new ct;var p=new It({prevTxId:o,output:u,outputIndex:c,script:h},n,1,null,s);this.addInput(p)}),this}get outputData(){if("BSV"===this.chain)return this.outputs.filter(t=>ct.fromScript(t._scriptBuffer).isDbDataScript()).map(t=>{var{chunks:e}=t._script||t.script;var{buf:r}=e[e.length-2];var n=JSON.parse(r.toString());var s=e.slice(1,e.length-4);return n._owners=s.map(t=>new mt(t.buf).toString()),n._amount=t._satoshis,n});if("BCH"===this.chain)return this._outputData;throw new Error("Chain not set in dataTransaction get outputdata")}set outputData(t){throw Error("dataTransaction.outputData cannot be set directly")}toData(t){if("BSV"===this.chain){var{_owners:e,_amount:r}=t,n=u(t,["_owners","_amount"]);var s=Buffer.from(JSON.stringify(n));var i=ct.getScript(s,e);var a=new St({script:i,satoshis:r});return this.addOutput(a),this.outputs.length-1}if("BCH"===this.chain){var o=ct.outScriptFromData(t);return this._outputData.push(t),o.forEach(e=>{var{redeemScript:r,chunk:n}=e;var s=ct.buildScriptHashOut(r);var i=t._amount;var a=new St({script:s,satoshis:i});this.addOutput(a)}),this._outputData.length-1}throw new Error("chain not set in dataScript.toScriptOutput")}_to(t,e){return t&&t._owners&&t._amount&&!e?this.toData(t):super.to(t,e)}fetchOutputData(){var t=this;return s((function*(){if(!t._outputData.length){var e=t.getTxId();"BSV"===t.chain?t._outputData=t.outputs.map(t=>{var e=ct.fromScript(t._scriptBuffer);var r=t._satoshis;if(e.isDbDataScript()){var n=e.getPublicKeys().map(t=>t.toString());return Object.assign(e.getData(),{_amount:r,_owners:n})}if(e.isPublicKeyHashOut()){var s=e.getPublicKeyHash();return{address:wt.fromPublicKeyHash(s)}}throw new Error("Unrecognized output script ".concat(e.toString()))}):"BCH"===t.chain&&(t._outputData=yield t.restClient.getOutputData(e))}}))()}get prevObjectIds(){return this.inputs.map(t=>"".concat(t.prevTxId.toString("hex"),":").concat(t.outputIndex))}getTxId(){return new jt(this._getHash()).readReverse().toString("hex")}getChangeIndex(){return this._changeIndex}static fromTxId(t,e,r){return s((function*(){var n=null;var s=new gt(e,r);try{n=yield s.getRawTransaction(t)}catch(e){yield Tt(3e3),n=yield s.getRawTransaction(t)}var i=new Et(e,r);return i.fromString(n),i}))()}}var{HDPrivateKey:Ct,Mnemonic:Bt,Transaction:Dt,Script:kt,PublicKey:Kt}=e;class Nt{constructor(t){this.wallet=t}get chain(){return this.wallet.chain}get network(){return this.wallet.network}put(t){var e=this;return s((function*(){return e.update([],t)}))()}getOutputDataMap(t){var e=this;return s((function*(){var r=[...new Set(t)];var n=yield Promise.all(r.map(function(){var t=s((function*(t){var r=yield e.wallet.restClient.getOutputData(t);var n=0;var s=r.map(e=>{var r=ct.outScriptFromData(e).length;var s=Array(r).fill(n).map((t,e)=>t+e);return n+=r,void 0!==e._owners&&(e._owners=e._owners.map(t=>new Kt(t))),o(o({},e),{},{__vouts:s,__txId:t})});return[t,s]}));return function(e){return t.apply(this,arguments)}}()));return new Map(n)}))()}get(t){var e=this;return s((function*(){if("BSV"===e.chain){var r=t.map(t=>t.split(":")[0]);var n=[...new Set(r)];var i=yield Promise.all(n.map(function(){var t=s((function*(t){return[t,yield e.wallet.restClient.getTransaction(t)]}));return function(e){return t.apply(this,arguments)}}()));var a=new Map(i);return Promise.all(t.map(function(){var t=s((function*(t){var[e,r]=t.split(":");var n=a.get(e).outputs[parseInt(r,10)];var s=ct.fromScript(n.script);return Object.assign(s.getData(),{__txId:e,__vouts:[parseInt(r,10)],_owners:s.getPublicKeys(),_amount:Math.round(n.satoshis)})}));return function(e){return t.apply(this,arguments)}}()))}if("BCH"===e.chain){var o=t.map(t=>t.split(":")[0]);var c=yield e.getOutputDataMap(o);return t.map(t=>{var[e,r]=t.split(":");var n=c.get(e);if(!n||!Array.isArray(n))throw new Error("No data found.");return n[parseInt(r,10)]})}throw new Error("chain not set in db.get")}))()}getUpdateTxBch(t,e,r){var n=this;return s((function*(){var r=new Et(n.chain,n.network);var i=yield n.get(t);var a=yield n.wallet.restClient.getTxosFromOutputData(i);t.forEach(function(){var t=s((function*(t,e){r.fromDataOutput(a[e],i[e])}));return function(e,r){return t.apply(this,arguments)}}());var o=M(e,n.wallet.getPublicKey()).map(t=>r.to(t));return{transaction:r=yield n.wallet.fundAndSendTransaction(r,!0),virtualIndices:o}}))()}getUpdateTxBsv(t,e,r){var n=this;return s((function*(){var r=new Et(n.chain,n.network);(yield Promise.all(t.map(function(){var t=s((function*(t){var[e,r]=t.split(":");var s=yield n.wallet.restClient.getTransaction(e);var{script:i,satoshis:a}=s.outputs[parseInt(r,10)];var o=ct.fromScript(i);return{output:{txId:e,outputIndex:parseInt(r,10),scriptPubKey:o,satoshis:Math.round(a)},publicKeys:o.getPublicKeys(),nr:1}}));return function(e){return t.apply(this,arguments)}}()))).forEach(t=>{var{output:e,publicKeys:n,nr:s}=t;r.from(e,n,s)});var i=M(e,n.wallet.getPublicKey()).map(t=>r.to(t));return r=yield n.wallet.fundAndSendTransaction(r,!0),yield r.fetchOutputData(),{transaction:r,virtualIndices:i}}))()}update(t,e){var r=this;return s((function*(){var n=e.reduce((t,e)=>t+parseInt(e._amount,10),0);if("BSV"===r.chain){var{transaction:i,virtualIndices:a}=yield r.getUpdateTxBsv(t,e,n);return yield Promise.all(t.map(function(){var t=s((function*(t){yield r.wallet.restClient.setTxoSpent(t)}));return function(e){return t.apply(this,arguments)}}())),a.map(t=>"".concat(i.getTxId(),":").concat(t))}if("BCH"===r.chain){var{transaction:o,virtualIndices:c}=yield r.getUpdateTxBch(t,e,n);return t.forEach(function(){var t=s((function*(t){yield r.wallet.restClient.setTxoSpent(t)}));return function(e){return t.apply(this,arguments)}}()),c.map(t=>"".concat(o.getTxId(),":").concat(t))}throw new Error("Chain not set in db.update ".concat(r.chain))}))()}}var Ut;if("undefined"==typeof window){var{LocalStorage:At}=require("node-localstorage");Ut=new At("./uls-scratch")}else void 0!==window.localStorage&&({localStorage:Ut}=window);var Rt=Ut;class Ht{static serialize(t){return JSON.stringify(Object.entries(t))}static deserialize(t,e){var r=e?new e:{};return JSON.parse(t).forEach(t=>{var[e,n]=t;return r[e]=n}),r}static set(t){if(void 0===t._rev)throw new Error("Rev not set in Cache.set");var e="Object"===t.constructor.name?JSON.stringify({data:this.serialize(t)}):JSON.stringify({data:this.serialize(t),clazz:t.constructor.toString()});return Rt.setItem(t._rev,e),t._rev}static get(t){var{data:e,clazz:r}=JSON.parse(Rt.getItem(t||""))||{};if(e){var n="string"==typeof r?eval("(".concat(r,")")):void 0;return this.deserialize(e,n)}return null}}class Mt{constructor(t,e){this.chain=t,this.network=e}get(t){return d(this,void 0,void 0,(function*(){const e=Ht.get(t);if(e)return e;const[r]=t.split(":");const n=yield yield Et.fromTxId(r,this.chain,this.network);yield n.fetchOutputData();const[{__cls:s,__func:i,_args:a,__index:o}]=n.outputData;const c=yield n.getVirtualInputs();const u=yield Promise.all(Object.values(o).map(t=>d(this,void 0,void 0,(function*(){return c[t]?this.get(c[t]):Promise.resolve({})}))));const h=Object.keys(o).map((t,e)=>[t,u[e]]);const p=Object.fromEntries(h);let l=p.obj;delete p.obj;const v=Object.entries(p).reduce((t,[e,r])=>(Number.isNaN(parseInt(e,10))||(t[parseInt(e,10)]=r),t),[]);const f=tt(v,a);let g;if("constructor"===i){const t=eval(`(${s})`);l=new t(...f)}else{const t=l[i].bind(l);g=Reflect.apply(t,l,f)}if("Object"!==P(l))return l;F([...f,l,g],c,r);const _=H([...f,l,g],t);return _?(Ht.set(_),_):(l._id=t,l._rev=t,Ht.set(l),l)}))}}var{Mnemonic:Ft,PublicKey:Lt}=e;class Vt{constructor(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};var{seed:e,chain:r=O.CHAIN,network:n=O.NETWORK,mnemonic:s=new Ft(e),wocApiKey:i,path:a="m/44'/0'/0'/0",passphrase:o=""}=t;this.restClient=new gt(r,n,i);var{db:c=new Nt(new rt(s,this.restClient,{path:a,passphrase:o}))}=t;this.db=c,this.reader=new Mt(this.chain,this.network)}get chain(){return this.db.chain}get network(){return this.db.network}static parseContract(t){return"string"===P(t)&&(t=t.startsWith("export ")?t.slice(7):t,t=t.startsWith("default ")?t.slice(8):t,t="(".concat(t,")"),t=eval(t)),t}new(t,e){var r=this;return s((function*(){var n=new et(r.db);var s=Vt.parseContract(t);var i=new Proxy(s,n);var a=yield new i(...e);return new Proxy(a,n)}))()}sync(t){var e=this;return s((function*(){var r=yield e.reader.get(t);var n=new et(e.db);return new Proxy(r,n)}))()}getOwnedRevs(){var t=arguments,e=this;return s((function*(){var r=t.length>0&&void 0!==t[0]?t[0]:e.db.wallet.getPublicKey();return e.db.wallet.restClient.getOwnedRevs(r)}))()}syncWallet(){var t=this;return s((function*(){t.db.wallet.syncWallet()}))()}}module.exports=Vt;
