import t from"bitcoinsource";import e from"axios";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function s(t,e){var s={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(s[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(t);r<n.length;r++)e.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(t,n[r])&&(s[n[r]]=t[n[r]])}return s}function n(t,e,s,n){return new(s||(s=Promise))((function(r,i){function o(t){try{a(n.next(t))}catch(t){i(t)}}function c(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,c)}a((n=n.apply(t,e||[])).next())}))}const r=process.env.BC_CHAIN||"BSV";const i=process.env.BC_NETWORK||"testnet";const o=process.env.BC_WOC_API_KEY;const c=parseInt(process.env.BC_DUST_LIMIT||"",10)||4e3;const a=parseInt(process.env.BC_DEFAULT_FEE||"",10)||("BSV"===r?500:2500);const u=parseInt(process.env.BC_SCRIPT_CHUNK_SIZE||"",10)||479;let h;let d;process.env.BC_BBS_URL?(h=process.env.BC_BBS_URL,d="ws"+process.env.BC_BBS_URL.slice(4)):(h="https://bbs.bitcoincomputer.io",d="wss://bbs.bitcoincomputer.io");var p={CHAIN:r,NETWORK:i,WOC_API_KEY:o,MIN_NON_DUST_AMOUNT:c,SCRIPT_CHUNK_SIZE:u,UN_P2SH_URL:h,WS_URL:d,DEFAULT_FEE:a};t.versionGuard=()=>!0,t.Networks.defaultNetwork=t.Networks[p.NETWORK];class l extends t.Address{constructor(...t){super(...t)}}class f extends t.crypto.BN{constructor(...t){super(...t)}}class g extends t.encoding.BufferReader{constructor(...t){super(...t)}}class _ extends t.encoding.BufferWriter{constructor(...t){super(...t)}}class w extends t.Mnemonic{constructor(...t){super(...t)}}class v extends t.HDPrivateKey{constructor(...t){super(...t)}}class b extends t.Transaction.Input.MultiSigScriptHash{constructor(...t){super(...t)}}class m extends t.Script.Interpreter{constructor(...t){super(...t)}}class y extends t.Opcode{constructor(...t){super(...t)}}class O extends t.Transaction.Input{constructor(...t){super(...t)}}class S extends t.Transaction.Output{constructor(...t){super(...t)}}class x extends t.PrivateKey{constructor(...t){super(...t)}}class I extends t.PublicKey{constructor(...t){super(...t)}}class j extends t.Script{constructor(...t){super(...t)}}class E extends t.Transaction{constructor(...t){super(...t)}}const P=()=>"__temp__:"+Math.random();const C=["_id","_rev","_owners","_amount","__vouts","__txId","__cls","__func","__index","__args"];const T=t=>(Object.prototype.toString.call(t).match(/\s([a-zA-Z]+)/)||[])[1];const B=t=>"object"==typeof t?T(t):T(t).toLowerCase();const K=t=>["number","string","boolean","undefined","Null"].includes(B(t));const N=t=>"Array"===B(t);const D=t=>"Object"===B(t);const $=t=>!!t._owners&&"object"==typeof t._owners;const k=t=>!!t._owners&&"string"==typeof t._owners;const U=t=>!!t._amount;const A=t=>K(t)||["Array","Object"].includes(B(t));const R=t=>"Object"===B(t)&&Object.keys(t).every(t=>!Number.isNaN(parseInt(t,10)));const H=(t,e)=>{if(!A(t)||!A(e))throw new Error(`Unsupported data types for deep equals: ${B(t)} & ${B(e)}`);if(B(t)!==B(e))return!1;if(K(t)&&K(e))return t===e;const s=(t,e)=>Object.entries(t).every(([t,s])=>H(e[t],s));return t&&e&&s(t,e)&&s(e,t)};const M=t=>{if(K(t))return t;if(N(t))return t.map(M);if(D(t)){const e=Object.keys(t).reduce((e,s)=>(e[s]=M(t[s]),e),{});const s=Object.create(Object.getPrototypeOf(t));return Object.assign(s,e)}throw new Error("Unsupported data type for clone: "+B(t))};const F=(t,e)=>t.reduce(([t,s],n,r)=>e(n,r)?[[...t,n],s]:[t,[...s,n]],[[],[]]);const L=(t,e)=>Object.fromEntries(Object.entries(t).map(t=>e(t)));const V=(t,e)=>L(t,([t,s])=>[t,e(s)]);const J=(t,e)=>Object.fromEntries(Object.entries(t).filter(([,t])=>e(t)));const W=(t,e)=>{if(K(t))return t;if(N(t))return t.map(t=>W(t,e));if(D(t)){const s=L(t,([t,s])=>[t,C.includes(t)?s:W(s,e)]);const n=U(t)?t._amount:p.MIN_NON_DUST_AMOUNT;const r=$(t)?t._owners:[e];return Object.assign(Object.assign({},s),{_amount:n,_owners:r})}throw new Error(`unsupported type ${B(t)} in setOwnersAndAmount`)};const z=(t,e,s,n)=>{if(K(t))return t;if(N(t))return t.map(t=>z(t,e,s,n));if(D(t)){t._rev=`${n}:${s}`;const r=e[s];return Object.entries(t).forEach(([s,i])=>{"object"==typeof r&&Object.keys(r).includes(s)&&(t[s]=z(i,e,r[s],n))}),t}throw new Error(`Unsupported type ${B(t)} in deep.updateRev`)};const q=t=>{if(K(t))return t;if(N(t))return t.map(t=>q(t));if(D(t))return t.__cls=t.constructor.toString(),Object.entries(t).forEach(([e,s])=>{t[e]=q(s)}),t;throw new Error(`Unsupported type ${B(t)} in deep.addClass`)};const Z=(t,e)=>{if(K(t))return t;if(N(t))return t.map(t=>Z(t,e));if(D(t))return t._id=!t._id||t._id.startsWith("__temp__")?t._rev:t._id,t._rootId=t._rootId||e,Object.entries(t).forEach(([s,n])=>{t[s]=Z(n,e)}),t;throw new Error(`Unsupported type ${B(t)} in deep.addId`)};const G=t=>{if(K(t))return t;if(N(t))return t.map(t=>G(t));if(D(t)){const e=P();return t._id=t._id||e,t._rev=t._rev||e,Object.values(t).map(t=>G(t)),t}throw new Error(`Unsupported type ${B(t)} in addRandomId`)};const Y=t=>{if(K(t))return t;if(N(t))return t.map(t=>Y(t));if(D(t))return L(t,([t,e])=>"_owners"===t?[t,JSON.stringify(e)]:K(e)?[t,e]:[t,Y(e)]);throw new Error(`Unexpected type ${B(t)} in stringifyOwners`)};const Q=t=>k(t)?Object.assign(Object.assign({},t),{_owners:JSON.parse(t._owners).map(t=>new I(t))}):t;const X=t=>{if(K(t))return t;if(N(t)||D(t))return Object.entries(t).reduce((t,[e,s])=>{const n=X(s);return R(n)?Object.entries(n).forEach(([s,n])=>{t[`${e}_${s}`]=n}):t[e]=n,t},{});throw new Error(`Unsupported type ${B(t)} in encodeArraysAsObjects`)};const tt=t=>{const e={[t._id]:Object.entries(t).reduce((t,[e,s])=>C.includes(e)?Object.assign(Object.assign({},t),{[e]:s}):K(s)?Object.assign(Object.assign({},t),{["__basic__"+e]:s}):Object.assign(Object.assign({},t),{[e]:s._id}),{})};return Object.values(t).filter(t=>!K(t)).reduce((t,e)=>Object.assign(Object.assign({},t),tt(e)),e)};const et=t=>Object.fromEntries(Object.entries(t).filter(([t])=>!t.startsWith("__basic__")));const st=(t,e)=>Object.fromEntries(Object.entries(e).map(([e,s])=>{const n=t[e];var r;return s.__change=(r=n)?H(r,s)?"same":"diff":"new",[e,s]}));const nt=(t,e)=>(t[e].__contains=Object.entries(t[e]).reduce((e,[s,n])=>["__contains"].concat(C).includes(s)?e:"__change"===s?"new"===n||"diff"===n||e:nt(t,n)[n].__contains||e,!1),t);const rt=t=>t.reduce((t,e,s)=>Object.assign(Object.assign({},t),{[e._id]:s}),{});const it=(t,e)=>t.map(t=>Object.entries(t).reduce((t,[s,n])=>{const r="string"==typeof n&&"undefined"!==B(e[n])?e[n]:n;return Object.assign(Object.assign({},t),{[s]:r})},{}));const ot=(t,e,n)=>{const[r,...i]=[e,...t].map((t,e)=>{const r=s(t,["_id","_rev","__change","__contains"]);return 0===e||e<=n.length?s(r,["__cls"]):r});return[r,...i.map(t=>Object.fromEntries(Object.entries(t).filter(([t,e])=>C.filter(t=>"__cls"!==t).includes(t)||"__cls"===t&&"string"==typeof e&&"function Object() { [native code] }"!==e||"number"==typeof e)))]};const ct=(t,e)=>{const s=G(e);const n=s._id;const r=M(t);const i=M(s);q(r),q(i);const o=Y(r);const c=Y(i);const a=X(o);const u=X(c);const h=tt(a);const d=tt(u);const p=st(h,d);const l=V(p,et);const f=nt(l,n);const g=f[n];delete g.__cls,delete f[n];const _=V(f,t=>t._rev);const w=J(f,t=>t.__contains||Object.values(g).includes(t._id));const v=Object.values(w);const[b,m]=F(v,t=>"new"===t.__change);const y=[...m,...b];const O=rt(y);const S=it(y,O);const[x]=it([g],O);const I=m.map(t=>t._rev);const[j,...E]=ot(S,x,I);return[I,E.map(Q).map(t=>Object.entries(t).reduce((t,[e,s])=>Object.assign(Object.assign({},t),{[e]:_[s]||s}),{})),j]};const at=t=>({smartArgs:t.filter(t=>t._rev),dumbArgs:t.map(t=>t._rev?"__":t)});const ut=(t,e)=>{let s=0;return e.map(e=>"__"===e?t[s++]:e)};const ht=t=>{if("string"!=typeof t||0===t.length)throw new Error("Please enter a valid id or revision");const[e,s]=t.split(":");if(!e||!s)throw new Error("Please enter a valid id or revision of the form <transaction id>:<output number>");if(!/^[0-9a-f]{64}$/.test(e))throw new Error("Invalid Transaction ID");if(Number.isNaN(Number(s)))throw new Error("Invalid Number")};class dt{constructor(t){this.db=t}static getUpdate(t,e,s,r){return n(this,void 0,void 0,(function*(){const[n,i]=M([t,s]);const o=Object.keys(s).length?Reflect.apply(s[r],s,t):null;const c=Object.keys(s).length?s:new e(...t);const{smartArgs:a,dumbArgs:u}=at(n);const{smartArgs:h}=at(t);const d=Object.assign(Object.assign(Object.assign({},a),{obj:i}),{_id:"index"});const p=Object.assign(Object.assign(Object.assign({},h),{obj:c}),{_id:"index"});"Object"===B(o)&&(p.res=o);const[l,f,g]=ct(d,p);void 0!==f[0]&&(f[0].__index=g);const _=g.obj;return void 0!==f[_]&&(f[_].__args=u,r?f[_].__func=r:(f[_].__func="constructor",f[_].__cls=e.toString())),[l,f,c,h,o,g]}))}construct(t,e){return n(this,void 0,void 0,(function*(){const[s,n,r,i,,o]=yield dt.getUpdate(e,t,{});const[c]=yield this.db.update(s,n);const[a]=c.split(":");const u=`${a}:${o.obj}`;return Object.entries(o).forEach(([t,e])=>{z("obj"===t?r:i[t],n,e,a)}),Z([r,...i],u),r}))}call(t,e,s){return n(this,void 0,void 0,(function*(){const[n,r,,i,o,c]=yield dt.getUpdate(s,null,t,e);const[a]=yield this.db.update(n,r);const[u]=a.split(":");Object.entries(c).forEach(([e,s])=>{"obj"===e&&z(t,r,s,u),z("res"===e?o:i[e],r,s,u)});const h=t._rootId||`${u}:${c.obj}`;return Z([o,t,...i],h),o}))}get(t,e){return"function"==typeof t[e]?(...s)=>this.call(t,e,s):Reflect.get(t,e)}}function pt(t,e){const s=[];let n=0;for(;n<t.length;)s.push(t.slice(n,n+e)),n+=e;return s}class lt extends j{static outScriptFromData(t){const{_owners:e,_amount:n,__vouts:r,__txId:i}=t,o=s(t,["_owners","_amount","__vouts","__txId"]);const c=pt(Buffer.from(JSON.stringify(o)),p.SCRIPT_CHUNK_SIZE);if(c[c.length-1].byteLength>=p.SCRIPT_CHUNK_SIZE){const t=c.pop();if(!t)throw new Error("panic");pt(t,p.SCRIPT_CHUNK_SIZE).forEach(t=>{c.push(t)})}return c.map(t=>({redeemScript:lt.getScript(t,e),chunk:t}))}static getScript(t,e){const s=new lt;return s.add("OP_1"),e.forEach(t=>s.add(t.toBuffer())),s.add("OP_"+e.length),s.add("OP_CHECKMULTISIG"),s.add(t),s.add("OP_DROP"),s}getData(){return this.isDbDataScript()?JSON.parse(this.chunks[this.chunks.length-2].buf.toString()):{}}getPublicKeys(){if(this.isDbDataScript())return this.chunks.slice(1,this.chunks.length-4).map(t=>new I(t.buf));throw new Error("Cannot get owners from non-data script")}isDbDataScript(){return!!(this.chunks.length>=5&&this.chunks[0].opcodenum===y.OP_1&&this.chunks[1].buf&&[20,33].includes(this.chunks[1].buf.length)&&this.chunks[this.chunks.length-3].opcodenum===y.OP_CHECKMULTISIG&&this.chunks[this.chunks.length-2].buf&&this.chunks[this.chunks.length-1].opcodenum===y.OP_DROP)}static isP2shScript(t){return!(3!==t.chunks.length||t.chunks[0].opcodenum!==y.OP_0||!t.chunks[1].buf||!t.chunks[2].buf)}static redeemScriptFromP2shScript(t){if(!this.isP2shScript(t))throw new Error("not a p2sh script");const e=new j(t.chunks[2].buf);const s=new this;return s.chunks=e.chunks,s}static fromScript(t){const e=new j(t);const s=new lt;return s.chunks=e.chunks,s}static buildPublicKeyOut(t){return lt.fromScript(j.buildPublicKeyOut(t))}static buildPublicKeyHashOut(t){return lt.fromScript(j.buildPublicKeyHashOut(t))}static buildScriptHashOut(t){return lt.fromScript(j.buildScriptHashOut(t))}}function ft(t){try{const e=JSON.parse(t);if("object"!=typeof e)throw new Error("Invalid object");if("string"!=typeof e.txhex)throw new Error("Invalid object");return new E(e.txhex)}catch(t){return null}}function gt(t){return n(this,void 0,void 0,(function*(){const{message:e,config:{url:s,method:n,data:r},response:i}=t;const o=ft(r);const c="message\t"+e;const a=`request\t${n} ${s}`;const u=o?"transaction\t "+JSON.stringify(o.toJSON(),null,2):"";const h="post"===n?"data\t"+r:"";const d=i?"response\t"+JSON.stringify(i.data):"";const p=o?u:h;throw t.message=`\n    Communication Error\n    ${c}\n    ${a}\n    ${p}\n    ${d}`,t}))}class _t{constructor(t,e={}){this.baseUrl=t,this.headers=e}get(t){return n(this,void 0,void 0,(function*(){const s=`${this.baseUrl}${t}`;try{return(yield e.get(s,{headers:this.headers})).data}catch(t){return gt(t)}}))}post(t,s){return n(this,void 0,void 0,(function*(){const n=`${this.baseUrl}${t}`;try{return(yield e.post(n,s,{headers:this.headers})).data}catch(t){return gt(t)}}))}}function wt(t){if(!/^[0-9A-Fa-f]{64}$/.test(t))throw new Error("Invalid txId: "+t)}function vt(t){if(!/^[0-9A-Fa-f]{64}:\d+$/.test(t))throw new Error("Invalid outId: "+t)}function bt(t){vt(t);const[e,s]=t.split(":");return{txId:e,virtualIndex:parseInt(s,10)}}const mt=new Map;class yt{constructor(t=p.CHAIN,e=p.NETWORK,s=p.WOC_API_KEY){this.chain=t,this.network=e,"BSV"===t&&(this.wocApiKey=s),this.bcx=new _t(this.getBaseUrl(),this.getRequestHeaders()),this.bbs=new _t(p.UN_P2SH_URL)}getBaseUrl(){if("BSV"===this.chain)return"https://api.whatsonchain.com/v1/bsv/"+("livenet"===this.network?"main":"test");if("BCH"===this.chain)return`https://${"livenet"===this.network?"rest":"trest"}.bitcoin.com/v2`;throw new Error("Illegal state")}getRequestHeaders(){if("BSV"===this.chain)return this.wocApiKey?{"woc-api-key":this.wocApiKey}:{};if("BCH"===this.chain)return{};throw new Error("Illegal state")}getBalance(t){return n(this,void 0,void 0,(function*(){if("BSV"===this.chain){const e=yield this.bcx.get(`/address/${t.toString()}/balance`);return e.confirmed+e.unconfirmed}if("BCH"===this.chain){const e=yield this.bcx.get("/address/details/"+t.toString());return e.balanceSat+e.unconfirmedBalanceSat}throw new Error("Illegal state")}))}getTransaction(t){return n(this,void 0,void 0,(function*(){return new E(yield this.getRawTransaction(t))}))}getRawTransaction(t){return n(this,void 0,void 0,(function*(){wt(t);let e=mt.get(t);if(!e){const s="livenet"===this.network?"main":"test";e=yield this.bbs.get(`/tx/${this.chain}/${s}/${t}`),mt.set(t,e)}return e}))}sendTransaction(t,e=!1){return n(this,void 0,void 0,(function*(){const s=t.toString();if("BSV"===this.chain){const n=yield this.bcx.post("/tx/raw",{txhex:s});return e&&(yield this.storeResult(n,t)),n}if("BCH"===this.chain){const[n]=yield this.bcx.post("/rawtransactions/sendRawTransaction",{hexes:[s]});return e&&(yield this.storeResult(n,t)),n}throw new Error("Illegal state")}))}storeResult(t,e){return n(this,void 0,void 0,(function*(){function s(t){return t.toString()}const n=e.outputData.map(t=>Object.assign(Object.assign({},t),{_owners:t._owners?t._owners.map(s):void 0}));const r=JSON.stringify(n);const i=e.toJSON().inputs.map(t=>`${t.prevTxId}:${t.outputIndex}`);yield this.postOutputData({txId:t,outputData:r,inputs:i})}))}getUtxosFromAddress(t){return n(this,void 0,void 0,(function*(){if("BSV"===this.chain){const e=(yield this.bcx.get(`/address/${t.toString()}/unspent`)).map(t=>({txId:t.tx_hash,vout:t.tx_pos,amount:t.value/1e8,satoshis:t.value}));return Promise.all(e.map(t=>n(this,void 0,void 0,(function*(){const e=(yield this.getTransaction(t.txId)).outputs[t.vout].script.toHex();return Object.assign(Object.assign({},t),{scriptPubKey:e})}))))}if("BCH"===this.chain){const{utxos:e,scriptPubKey:s}=yield this.bcx.get("/address/utxo/"+t.toString());return e.map(t=>({txId:t.txid,vout:t.vout,scriptPubKey:s,amount:t.amount,satoshis:t.satoshis,height:t.height,confirmations:t.confirmations}))}throw new Error("Illegal state")}))}getTxosFromOutputData(t){return n(this,void 0,void 0,(function*(){const e=new Map;const s=t.map(t=>{const e=t.__txId;if(!e)throw new Error("Missing __txId");return e});const r=[...new Set(s)];return yield Promise.all(r.map(t=>n(this,void 0,void 0,(function*(){return e.set(t,yield this.getTransaction(t))})))),t.map(t=>{const s=t.__txId;if(!s)throw new Error("Missing __txId");const n=t.__vouts;if(!n)throw new Error("Missing __vouts");const r=e.get(s);if(!r)throw new Error("Illegal state");return n.map(t=>{const e=r.outputs[t];const n=e._scriptBuffer.toString("hex");const i=e._satoshis;return{txId:s,vout:t,scriptPubKey:n,amount:i/1e8,satoshis:i}})})}))}postOutputData(t){return n(this,void 0,void 0,(function*(){return this.bbs.post("/",t)}))}getOutputData(t){return n(this,void 0,void 0,(function*(){function e(t){return new I(t)}return(yield this.bbs.get("/un-p2sh/"+t)).map(t=>Object.assign(Object.assign({},t),{_owners:t._owners?t._owners.map(e):void 0}))}))}getOwnedRevs(t){return n(this,void 0,void 0,(function*(){return this.bbs.get("/txos/"+t.toString())}))}getLatestRev(t){return n(this,void 0,void 0,(function*(){vt(t);const[{rev:e}]=yield this.bbs.get("/get-rev/"+t);return e}))}getLatestRevs(t){return n(this,void 0,void 0,(function*(){t.map(vt);const e=t.map(t=>"id="+t).join("&");return yield this.bbs.get("/get-revs?"+e)}))}setTxoSpent(t){return n(this,void 0,void 0,(function*(){const e=bt(t);this.bbs.post("/txos/set-spent/",e)}))}}function Ot(t){return{writable:!0,value:t}}function St(t,e,n){var r=t,i=n[r],o=s(n,["symbol"==typeof r?r:r+""]);return Object.assign({[e]:i},o)}const xt=t=>new Promise(e=>setTimeout(e,t));class It extends E{constructor(t,e,s){super(s),this._outputData=[],this.restClient=new yt(t,e),this.feePerKb(p.DEFAULT_FEE),Object.defineProperty(this,"from",Ot(this._from))}get chain(){return this.restClient.chain}get network(){return this.restClient.network}static fromRedeemScripts(t){const e=t.map(t=>t.chunks[t.chunks.length-2].buf);const s=Buffer.concat(e);const n=JSON.parse(s.toString());return Object.assign({_owners:t[0].getPublicKeys(),_amount:p.MIN_NON_DUST_AMOUNT},n)}static addVouts(t){let e=0;return t.map(t=>{const s=lt.outScriptFromData(t).length;const n=Object.assign(Object.assign({},t),{__vouts:[]});return n.__vouts=Array(s).fill(e).map((t,e)=>t+e),e+=s,n})}get dataInputs(){const t=[];const e=function*(t){for(const e of t)yield e}(this.inputs);let s=e.next();for(;!s.done;){const n=s.value;const r=lt.fromScript(n._scriptBuffer);if(lt.isP2shScript(r)){let s=!1;const n=[lt.redeemScriptFromP2shScript(r)];for(;!s;)try{t.push(It.fromRedeemScripts(n)),s=!0}catch(t){const s=e.next();if(s.done)throw new Error("Could not compute data inputs");const r=s.value;const i=lt.fromScript(r._scriptBuffer);n.push(lt.redeemScriptFromP2shScript(i))}}s=e.next()}return t}set dataInputs(t){throw Error("dataTransaction.dataInputs cannot be set directly, use dataTransaction.from or dataTransaction.fromDataOutput")}getVirtualInputs(){return n(this,void 0,void 0,(function*(){if("BSV"===this.chain)return(yield Promise.all(this.inputs.map(t=>n(this,void 0,void 0,(function*(){const{outputIndex:e}=t;const s=t.prevTxId.toString("hex");const n=(yield It.fromTxId(s,this.chain,this.network)).outputs[e];return!!lt.fromScript(n._scriptBuffer).isDbDataScript()&&t}))))).filter(t=>!!t).map(t=>`${t.prevTxId.toString("hex")}:${t.outputIndex}`);if("BCH"===this.chain){const{dataInputs:t}=this;const e=It.addVouts(t);return Promise.all(e.map(t=>n(this,void 0,void 0,(function*(){const e=[];t.__vouts.forEach(t=>{e.push(this.inputs[t])});const s=e[0].prevTxId.toString("hex");const n=yield It.fromTxId(s,this.chain,this.network);yield n.fetchOutputData();const r=It.addVouts(n.outputData);const i=[];return r.forEach((t,s)=>{H(t.__vouts,e.map(t=>t.outputIndex))&&i.push(s)}),`${s}:${i[0]}`}))))}throw new Error("chain not set in getVirtualInputs")}))}fromMultiSig(t,e,s){const n=t.map(t=>St("txId","txid",t));return super.from(n,e,s)}_from(t,e,s){const n=St("txId","txid",t);return super.from(n,e,s)}fromDataOutput(t,e){const s=lt.outScriptFromData(e);const{_owners:n}=e;return s.forEach(({redeemScript:e},s)=>{const{scriptPubKey:r,satoshis:i,txId:o,vout:c}=t[s];const a=new S({script:new lt(r),satoshis:i});const u=new lt;const h=new b({prevTxId:o,output:a,outputIndex:c,script:u},n,1,null,e);this.addInput(h)}),this}get outputData(){if("BSV"===this.chain)return this.outputs.filter(t=>lt.fromScript(t._scriptBuffer).isDbDataScript()).map(t=>{const{chunks:e}=t._script||t.script;const{buf:s}=e[e.length-2];const n=JSON.parse(s.toString());const r=e.slice(1,e.length-4);return n._owners=r.map(t=>new I(t.buf).toString()),n._amount=t._satoshis,n});if("BCH"===this.chain)return this._outputData;throw new Error("Chain not set in dataTransaction get outputdata")}set outputData(t){throw Error("dataTransaction.outputData cannot be set directly")}toData(t){if("BSV"===this.chain){const{_owners:e,_amount:n}=t,r=s(t,["_owners","_amount"]);const i=Buffer.from(JSON.stringify(r));const o=lt.getScript(i,e);const c=new S({script:o,satoshis:n});return this.addOutput(c),this.outputs.length-1}if("BCH"===this.chain){const e=lt.outScriptFromData(t);return this._outputData.push(t),e.forEach(({redeemScript:e})=>{const s=lt.buildScriptHashOut(e);const n=t._amount;const r=new S({script:s,satoshis:n});this.addOutput(r)}),this._outputData.length-1}throw new Error("chain not set in dataScript.toScriptOutput")}fetchOutputData(){return n(this,void 0,void 0,(function*(){if(this._outputData.length)return;const t=this.getTxId();"BSV"===this.chain?this._outputData=this.outputs.map(t=>{const e=lt.fromScript(t._scriptBuffer);const s=t._satoshis;if(e.isDbDataScript()){const t=e.getPublicKeys().map(t=>t.toString());return Object.assign(e.getData(),{_amount:s,_owners:t})}if(e.isPublicKeyHashOut()){const t=e.getPublicKeyHash();return{address:l.fromPublicKeyHash(t)}}throw new Error("Unrecognized output script "+e.toString())}):"BCH"===this.chain&&(this._outputData=yield this.restClient.getOutputData(t))}))}get prevObjectIds(){return this.inputs.map(t=>`${t.prevTxId.toString("hex")}:${t.outputIndex}`)}getTxId(){return new g(this._getHash()).readReverse().toString("hex")}getChangeIndex(){return this._changeIndex}static fromTxId(t,e,s){return n(this,void 0,void 0,(function*(){let n=null;const r=new yt(e,s);try{n=yield r.getRawTransaction(t)}catch(e){yield xt(3e3),n=yield r.getRawTransaction(t)}const i=new It(e,s);return i.fromString(n),i}))}}class jt{constructor(t){this.wallet=t}get chain(){return this.wallet.chain}get network(){return this.wallet.network}put(t){return n(this,void 0,void 0,(function*(){return this.update([],t)}))}getOutputDataMap(t){return n(this,void 0,void 0,(function*(){const e=[...new Set(t)];const s=yield Promise.all(e.map(t=>n(this,void 0,void 0,(function*(){const e=yield this.wallet.restClient.getOutputData(t);let s=0;const n=e.map(e=>{const n=Object.assign({},e);const r=lt.outScriptFromData(n).length;const i=Array(r).fill(s).map((t,e)=>t+e);return s+=r,void 0!==n._owners&&(n._owners=n._owners.map(t=>new I(t))),Object.assign(Object.assign({},n),{__vouts:i,__txId:t})});return[t,n]}))));return new Map(s)}))}get(t){return n(this,void 0,void 0,(function*(){if("BSV"===this.chain){const e=t.map(t=>t.split(":")[0]);const s=[...new Set(e)];const r=yield Promise.all(s.map(t=>n(this,void 0,void 0,(function*(){return[t,yield this.wallet.restClient.getTransaction(t)]}))));const i=new Map(r);return Promise.all(t.map(t=>n(this,void 0,void 0,(function*(){const[e,s]=t.split(":");const n=i.get(e).outputs[parseInt(s,10)];const r=lt.fromScript(n.script);return Object.assign(r.getData(),{__txId:e,__vouts:[parseInt(s,10)],_owners:r.getPublicKeys(),_amount:Math.round(n.satoshis)})}))))}if("BCH"===this.chain){const e=t.map(t=>t.split(":")[0]);const s=yield this.getOutputDataMap(e);return t.map(t=>{const[e,n]=t.split(":");const r=s.get(e);if(!r||!Array.isArray(r))throw new Error("No data found.");return r[parseInt(n,10)]})}throw new Error("chain not set in db.get")}))}getUpdateTxBch(t,e){return n(this,void 0,void 0,(function*(){const s=new It(this.chain,this.network);const r=yield this.get(t);const i=yield this.wallet.restClient.getTxosFromOutputData(r);t.forEach((t,e)=>n(this,void 0,void 0,(function*(){s.fromDataOutput(i[e],r[e])})));const o=W(e,this.wallet.getPublicKey()).map(t=>s.toData(t));return{txId:yield this.wallet.fundAndSendTransaction(s,!0),virtualIndices:o}}))}getUpdateTxBsv(t,e){return n(this,void 0,void 0,(function*(){const s=new It(this.chain,this.network);(yield Promise.all(t.map(t=>n(this,void 0,void 0,(function*(){const[e,s]=t.split(":");const n=yield this.wallet.restClient.getTransaction(e);const{script:r,satoshis:i}=n.outputs[parseInt(s,10)];const o=lt.fromScript(r);return{output:{txId:e,outputIndex:parseInt(s,10),scriptPubKey:o,satoshis:Math.round(i)},publicKeys:o.getPublicKeys(),nr:1}}))))).forEach(({output:t,publicKeys:e,nr:n})=>{s.from(t,e,n)});const r=W(e,this.wallet.getPublicKey()).map(t=>s.toData(t));return{txId:yield this.wallet.fundAndSendTransaction(s,!0),virtualIndices:r}}))}update(t,e){return n(this,void 0,void 0,(function*(){if("BSV"===this.chain){const{txId:s,virtualIndices:r}=yield this.getUpdateTxBsv(t,e);return yield Promise.all(t.map(t=>n(this,void 0,void 0,(function*(){yield this.wallet.restClient.setTxoSpent(t)})))),r.map(t=>`${s}:${t}`)}if("BCH"===this.chain){const{txId:s,virtualIndices:r}=yield this.getUpdateTxBch(t,e);return t.forEach(t=>n(this,void 0,void 0,(function*(){yield this.wallet.restClient.setTxoSpent(t)}))),r.map(t=>`${s}:${t}`)}throw new Error("Chain not set in db.update "+this.chain)}))}}class Et{constructor(t,e,s={}){const{path:n="m/44'/0'/0'/0",passphrase:r=""}=s;this.mnemonic=t,this.path=n,this.passphrase=r,this.restClient=e,this.utoxsSyncing=!1,this.hdPrivateKey=this.mnemonic.toHDPrivateKey(this.passphrase,p.NETWORK),this.path&&(this.hdPrivateKey=this.hdPrivateKey.derive(this.path)),this.utxos=[],this.syncUtxos()}get chain(){return this.restClient.chain}get network(){return this.restClient.network}getMnemonic(){return this.mnemonic}getPath(){return this.path}getUtxos(){return this.utxos}derive(t=0,e=!1){const s=new Et(this.mnemonic,this.restClient);return s.path=`${this.path}${this.path.length?"/":""}${t}${e?"'":""}`,s.hdPrivateKey=this.hdPrivateKey.derive(t,e),s}static getHdPrivateKey(){return new v}getPrivateKey(){return this.hdPrivateKey.privateKey}getPublicKey(){return this.hdPrivateKey.publicKey}getAddress(){return this.address=this.address||this.getPublicKey().toAddress(this.network),this.address}syncUtxos(){return n(this,void 0,void 0,(function*(){this.utoxsSyncing=!0,this.utxos=yield this.restClient.getUtxosFromAddress(this.getAddress()),this.utoxsSyncing=!1}))}waitUntilSynced(){return n(this,void 0,void 0,(function*(){for(;this.utoxsSyncing;)yield new Promise(t=>setTimeout(t,300))}))}getBalance(){return n(this,void 0,void 0,(function*(){const t=this.getAddress();return this.restClient.getBalance(t)}))}getBalanceLowerBounds(){return n(this,void 0,void 0,(function*(){return yield this.waitUntilSynced(),this.utxos.reduce((t,e)=>t+e.satoshis,0)}))}getUtxosToSpend(t){return n(this,void 0,void 0,(function*(){yield this.waitUntilSynced();for(let t=this.utxos.length-1;t>0;t-=1){const e=Math.floor(Math.random()*(t+1));[this.utxos[t],this.utxos[e]]=[this.utxos[e],this.utxos[t]]}return this.getUtxosWithSatoshis(t)}))}getUtxosWithSatoshis(t){let e=0;const s=[];let n=0;for(;e<t&&n<this.utxos.length;)s.push(this.utxos[n]),e+=this.utxos[n].satoshis,n+=1;if(e>=t)return s;throw new Error(`Insufficient balance in address ${this.getAddress().toString()} on ${p.NETWORK} ${p.CHAIN}. Found ${e}, required ${t}.`)}fundAndSendTransaction(t,e=!1){return n(this,void 0,void 0,(function*(){t.feePerKb(p.DEFAULT_FEE);const s=t._estimateFee()+100;const n=yield this.getUtxosToSpend(t._getOutputAmount()-t._getInputAmount()+s);n.forEach(e=>t.from(e)),t.change(this.getAddress()),t.sign(this.getPrivateKey());const r=yield this.restClient.sendTransaction(t,e);this.utxos=this.utxos.filter(t=>!n.includes(t));const i=t.getChangeOutput();return i&&this.utxos.push({txId:t.getTxId(),vout:t.getChangeIndex(),satoshis:i.satoshis,amount:i.satoshis/1e8,scriptPubKey:i.script.toHex()}),r}))}send(t,e){return n(this,void 0,void 0,(function*(){const s=new It(this.chain,this.network);const n=s.to(e,t);if(s!==n)throw new Error("panic");return this.fundAndSendTransaction(s)}))}}let Pt;if("undefined"==typeof window){const{LocalStorage:t}=require("node-localstorage");Pt=new t("./uls-scratch")}else void 0!==window.localStorage&&(Pt=window.localStorage);var Ct=Pt;class Tt{static serialize(t){return JSON.stringify(Object.entries(t))}static deserialize(t,e){const s=e?new e:{};return JSON.parse(t).forEach(([t,e])=>{s[t]=e}),s}static set(t){if(void 0===t._rev)throw new Error("Rev not set in Cache.set");const e="Object"===t.constructor.name?JSON.stringify({data:Tt.serialize(t)}):JSON.stringify({data:Tt.serialize(t),clazz:t.constructor.toString()});return Ct.setItem(t._rev,e),t._rev}static get(t){const{data:e,clazz:s}=JSON.parse(Ct.getItem(t||""))||{};if(e){const t="string"==typeof s?eval(`(${s})`):void 0;return this.deserialize(e,t)}return null}}class Bt{constructor(t,e){this.chain=t,this.network=e}get(t){return n(this,void 0,void 0,(function*(){const e=Tt.get(t);if(e)return e;const[s,r]=t.split(":");const i=yield It.fromTxId(s,this.chain,this.network);yield i.fetchOutputData();const o=i.outputData;const{__index:c}=o[0];const{__cls:a,__func:u,__args:h}=o[c.obj];const d=yield i.getVirtualInputs();const p=yield Promise.all(Object.values(c).map(t=>n(this,void 0,void 0,(function*(){return d[t]?this.get(d[t]):Promise.resolve({})}))));const l=Object.keys(c).map((t,e)=>[t,p[e]]);const f=Object.fromEntries(l);let g=f.obj;delete f.obj;const _=Object.entries(f).reduce((t,[e,s])=>(Number.isNaN(parseInt(e,10))||(t[parseInt(e,10)]=s),t),[]);const w=ut(_,h);let v;if("constructor"===u){const t=eval(`(${a})`);g=new t(...w)}else{const t=g[u].bind(g);v=Reflect.apply(t,g,w)}const b=c;Object.entries(b).forEach(([t,e])=>{"obj"===t&&z(g,o,e,s),z("res"===t?v:_[t],o,e,s)});const m=g._rootId||`${s}:${b.obj}`;return Z([g,v,..._],m),[g,v,..._].filter(t=>!K(t)).map(Tt.set),[..._,g,v][r]}))}}class Kt{constructor(t={}){const{seed:e,chain:s=p.CHAIN,network:n=p.NETWORK,mnemonic:r=new w(e),wocApiKey:i,path:o="m/44'/0'/0'/0",passphrase:c=""}=t;if(!s||!["BSV","BCH"].includes(s))throw new Error("Please set 'chain' to 'BSV' or 'BCH' when creating a computer instance");if(!n||!["livenet","testnet"].includes(n))throw new Error("Please set 'network' to 'testnet' or 'livenet' when creating a computer instance");if(!r)throw new Error("Please set 'seed' to a valid BIP 39 mnemonic string when creating a computer instance");this.restClient=new yt(s,n,i);const{db:a=new jt(new Et(r,this.restClient,{path:o,passphrase:c}))}=t;this.db=a,this.reader=new Bt(this.chain,this.network)}get chain(){return this.db.chain}get network(){return this.db.network}static parseContract(t){if("string"==typeof t){const e=t.startsWith("export ")?t.slice(7):t;const s=e.startsWith("default ")?e.slice(8):e;return eval(`(${s})`)}return t}new(t,e=[]){return n(this,void 0,void 0,(function*(){if(!t)throw new Error("Please enter a valid Class");const s=new dt(this.db);const n=Kt.parseContract(t);const r=new Proxy(n,s);const i=yield new r(...e);return new Proxy(i,s)}))}sync(t){return n(this,void 0,void 0,(function*(){ht(t);const e=yield this.reader.get(t);const s=new dt(this.db);return new Proxy(e,s)}))}getOwnedRevs(t=this.db.wallet.getPublicKey()){return n(this,void 0,void 0,(function*(){return this.db.wallet.restClient.getOwnedRevs(t)}))}getRevs(t=this.db.wallet.getPublicKey()){return n(this,void 0,void 0,(function*(){return(yield this.db.wallet.restClient.getOwnedRevs(t)).map(({txId:t,virtualIndex:e})=>`${t}:${e}`)}))}getLatestRev(t){return n(this,void 0,void 0,(function*(){return this.db.wallet.restClient.getLatestRev(t)}))}getLatestRevs(t){return n(this,void 0,void 0,(function*(){return this.db.wallet.restClient.getLatestRevs(t)}))}}export default Kt;
